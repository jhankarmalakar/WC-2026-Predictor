<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>World Cup 2026 – Pools → Groups → Knockouts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#0f1220;
      --panel:#151a2e;
      --panel-2:#111527;
      --text:#f5f7ff;
      --muted:#b9c0e6;
      --accent:#7aa2ff;
      --accent-2:#5ee6ff;
      --border:rgba(255,255,255,0.08);
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 14px;

      /* Rank highlights */
      --hl-strong-bg: rgba(94, 230, 168, 0.14);
      --hl-strong-br: rgba(94, 230, 168, 0.45);
      --hl-mild-bg:   rgba(122, 162, 255, 0.10);
      --hl-mild-br:   rgba(122, 162, 255, 0.35);

      /* Qualified styling */
      --qualified-br: rgba(94, 230, 168, 0.55);
      --qualified-glow: rgba(94, 230, 168, 0.18);

      /* Eliminated styling */
      --elim-bg: rgba(255, 107, 122, 0.08);
      --elim-br: rgba(255, 107, 122, 0.35);

      /* Click-swap armed styling (amber) */
      --swap-bg: rgba(255, 184, 107, 0.14);
      --swap-br: rgba(255, 184, 107, 0.55);

      /* Winner highlight */
      --win-bg: rgba(122, 255, 187, 0.18);
      --win-br: rgba(122, 255, 187, 0.70);
      --win-glow: rgba(122, 255, 187, 0.22);

      /* Orange action buttons */
      --orange-bg-1: rgba(255, 168, 64, 0.28);
      --orange-bg-2: rgba(255, 122, 64, 0.18);
      --orange-br:   rgba(255, 170, 90, 0.70);

      /* Green primary action */
      --green-bg-1: rgba(94, 230, 168, 0.26);
      --green-bg-2: rgba(94, 230, 168, 0.12);
      --green-br:   rgba(94, 230, 168, 0.75);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 800px at 10% 10%, #1c2342 0%, var(--bg) 40%, #070912 100%);
      min-height:100vh;
    }

    header{
      padding: 18px 20px 8px 20px;
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap: wrap;
    }
    header h1{
      font-size: 19px;
      font-weight: 700;
      margin:0 0 8px 0;
      letter-spacing: 0.2px;
    }
    header .hint{
      color:var(--muted);
      font-size: 12.5px;
      line-height: 1.45;
      max-width: 95ch;
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .hint-line{ padding-left: 2px; }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
      padding-top: 2px;
    }

    /* Base buttons */
    button{
      background: linear-gradient(135deg, rgba(122,162,255,0.22), rgba(94,230,255,0.12));
      color: var(--text);
      border: 1px solid rgba(122,162,255,0.55);
      padding: 11px 14px;
      border-radius: 12px;
      font-size: 12.5px;
      cursor: pointer;
      white-space: nowrap;
      box-shadow: 0 0 0 1px rgba(122,162,255,0.08) inset;
    }
    button:hover{
      background: linear-gradient(135deg, rgba(122,162,255,0.30), rgba(94,230,255,0.18));
    }
    button:disabled{ opacity: 0.55; cursor: not-allowed; }

    .btn-mini{
      padding: 8px 10px;
      font-size: 11px;
      border-radius: 10px;
    }

    /* Orange action buttons */
    .btn-orange{
      background: linear-gradient(135deg, var(--orange-bg-1), var(--orange-bg-2));
      border: 1px solid var(--orange-br);
      box-shadow:
        0 0 0 1px rgba(255,170,90,0.10) inset,
        0 6px 16px rgba(0,0,0,0.18);
    }
    .btn-orange:hover{
      background: linear-gradient(135deg, rgba(255, 180, 90, 0.35), rgba(255, 120, 70, 0.22));
    }

    /* Green primary button */
    .btn-green{
      background: linear-gradient(135deg, var(--green-bg-1), var(--green-bg-2));
      border: 1px solid var(--green-br);
      box-shadow:
        0 0 0 1px rgba(94,230,168,0.10) inset,
        0 6px 16px rgba(0,0,0,0.18);
    }
    .btn-green:hover{
      background: linear-gradient(135deg, rgba(94,230,168,0.34), rgba(94,230,168,0.18));
    }

      /* ==========================
     Result image preview modal
  ========================== */
  .result-modal{
    position: fixed;
    inset: 0;
    background: rgba(3,6,16,0.86);
    backdrop-filter: blur(10px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    padding: 18px;
  }
  .result-modal.open{ display: flex; }

  .result-modal-card{
    width: min(1100px, 96vw);
    max-height: 92vh;
    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 16px;
    box-shadow: 0 18px 60px rgba(0,0,0,0.45);
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  .result-modal-head{
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    padding: 10px 12px;
    border-bottom: 1px solid rgba(255,255,255,0.08);
  }
  .result-modal-head .title{
    font-size: 12px;
    color: rgba(255,255,255,0.7);
    letter-spacing: 0.3px;
  }
  .result-modal-body{
    padding: 10px;
    display: flex;
    justify-content: center;
    overflow: auto;
  }
  .result-modal-body img{
    width: 100%;
    height: auto;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.08);
  }

    /* ==========================
       R32 out-of-date badge
    ========================== */
    .outofdate-badge{
      display: inline-block;
      margin-left: 8px;
      padding: 2px 7px;
      font-size: 9px;
      font-weight: 800;
      letter-spacing: 0.25px;
      border-radius: 999px;
      border: 1px solid rgba(255, 184, 107, 0.70);
      background: rgba(255, 184, 107, 0.16);
      color: var(--text);
      vertical-align: middle;
      line-height: 1.1;

      animation: badgeGlowPulse 1.8s ease-in-out infinite;
      transform-origin: left center;
    }
    @keyframes badgeGlowPulse{
      0%, 100%{
        box-shadow:
          0 0 0 0 rgba(255,184,107,0.00),
          0 0 0 0 rgba(255,184,107,0.00);
        filter: saturate(1);
        transform: scale(1);
      }
      50%{
        box-shadow:
          0 0 0 2px rgba(255,184,107,0.18),
          0 0 10px rgba(255,184,107,0.22);
        filter: saturate(1.08);
        transform: scale(1.03);
      }
    }
    @media (prefers-reduced-motion: reduce){
      .outofdate-badge{ animation: none; }
    }

    /* Board grid */
    .board{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
      padding: 8px 16px 30px 16px;
    }
    @media (min-width: 780px){
      .board{ grid-template-columns: 1fr 1fr; }
    }
    @media (min-width: 1100px){
      .board{ grid-template-columns: 1fr 1fr 1fr; }
    }
    @media (min-width: 1400px){
      .board{ grid-template-columns: 1fr 1fr 1fr 1fr; }
    }
/* Prevent Stage header overlap on small screens */
    
    @media (max-width: 560px){
      .stage-separator{
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
    
      .stage-left{
        width: 100%;
      }
    
      .stage-right{
        width: 100%;
        justify-content: flex-start;
      }
    
      /* Allow wrapping just on small screens */
      .stage-title{
        white-space: normal;
      }
    
      .stage-line{
        display: none; /* optional: removes the line to reduce clutter */
      }
    }

    

    /* Stage separators */
    .stage-separator{
      grid-column: 1 / -1;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 14px 6px 4px 6px;
      flex-wrap: wrap;
    }
    .stage-left{
      display:flex;
      align-items:center;
      gap: 12px;
      min-width: 0;
      flex: 1;
    }
    .stage-title{
      font-size: 14.5px;
      font-weight: 800;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      color: rgba(255,255,255,0.80);
      white-space: nowrap;
    }
    .stage-line{
      height: 1px;
      background: var(--border);
      flex: 1;
      min-width: 30px;
    }
    .stage-right{
      display:flex;
      gap: 8px;
      align-items:center;
      flex-wrap: wrap;
    }

    /* Column */
    .column{
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      min-height: 160px;
      display:flex;
      flex-direction:column;
    }
 

        .column-header{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--border);
      gap: 10px;
    }

    /* NEW: right side container so we can show Expand + count */
    .column-header-right{
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    /* Small expand button */
    .group-expand-btn{
      font-size: 10.5px;
      padding: 5px 8px;
      border-radius: 999px;
    }

    /* Fixtures modal content */
    .group-fixtures{
      max-height: 60vh;
      overflow: auto;
      padding-right: 4px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: 12.5px;
      color: var(--text);
    }
    .fixture-day{
      font-weight: 700;
      font-size: 12px;
      letter-spacing: 0.4px;
      text-transform: uppercase;
      color: var(--muted);
      margin-top: 2px;
    }
    .fixture-line{
      padding-left: 8px;
      padding-top: 2px;
      padding-bottom: 2px;
      border-left: 2px solid var(--border);
      color: var(--text);
    }
    .fixture-empty{
      font-size: 12px;
      color: var(--muted);
    }

    .column-title{
      font-size: 12.2px;
      letter-spacing: 0.35px;
      text-transform: uppercase;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 80%;
    }
    .count{
      font-size: 10.5px;
      color: var(--muted);
      opacity: 0.9;
      white-space: nowrap;
    }

    .zone{
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap: 8px;
      flex: 1;
    }

    .zone-moved-indicator{
        margin-left: 6px;
        font-size: 9.5px;
        font-weight: 700;
        letter-spacing: 0.2px;
        padding: 2px 6px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,0.10);
        background: rgba(255,255,255,0.06);
        color: var(--muted);
        display: inline-block;
      }

    /* Zone-level "User moved" badge (header) */
    .zone-moved-badge{
      display: none;
      margin-left: 8px;
      padding: 2px 8px;
      font-size: 9.5px;
      font-weight: 700;
      letter-spacing: 0.25px;
      border-radius: 999px;

      color: var(--text);
      border: 1px solid rgba(122,162,255,0.45);
      background: rgba(122,162,255,0.10);

      vertical-align: middle;
      line-height: 1.15;
      box-shadow: 0 0 0 1px rgba(122,162,255,0.06) inset;
    }
    .zone-moved-badge.zone-moved-warm{
      border-color: rgba(255,184,107,0.60);
      background: rgba(255,184,107,0.12);
      box-shadow: 0 0 0 1px rgba(255,184,107,0.08) inset;
    }

    /* Card */
    .card{
      background: rgba(255,255,255,0.04);
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      user-select: none;
      cursor: pointer;
      transition: background 120ms ease, border-color 120ms ease, box-shadow 120ms ease;
    }
    .card.locked{
      cursor: default;
      opacity: 0.9;
    }

    .name{
      font-size: 13.8px;
      font-weight: 560;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display:flex;
      align-items:center;
      gap: 0;
      min-width: 0;
    }
    .tag{
      font-size: 9.8px;
      color: var(--muted);
      border:1px solid var(--border);
      padding: 3px 7px;
      border-radius: 999px;
      white-space: nowrap;
    }

    /* Rank highlights */
    .rank-strong{
      background: var(--hl-strong-bg);
      border-color: var(--hl-strong-br);
    }
    .rank-mild{
      background: var(--hl-mild-bg);
      border-color: var(--hl-mild-br);
    }

    /* Qualified/Eliminated */
    .qualified{
      border-color: var(--qualified-br);
      box-shadow: 0 0 0 1px var(--qualified-glow) inset;
    }
    .eliminated{
      background: var(--elim-bg);
      border-color: var(--elim-br);
    }

    /* First-click armed swap */
    .swap-armed{
      background: var(--swap-bg);
      border-color: var(--swap-br);
      box-shadow: 0 0 0 1px rgba(255,184,107,0.18) inset;
    }

    .footer{
      padding: 0 16px 24px 16px;
      color: var(--muted);
      font-size: 11px;
    }

    .top8-summary{
      margin-top: 10px;
      padding: 10px 12px;
      font-size: 14px;
      font-weight: 800;
      color: var(--text);
      border: 1px dashed var(--border);
      border-radius: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      text-align: center;
      background: rgba(255,255,255,0.03);
    }

    /* Flag images */
   .flag-img{
  width: 18px;
  height: 13px;
  object-fit: cover;
  border-radius: 2px;
  margin-right: 6px;
  vertical-align: -1px;
  box-shadow: 0 0 0 1px rgba(255,255,255,0.08);
  flex: 0 0 auto;
}


    /* ==========================
       Knockout layout + section border
    ========================== */
    .ko-section{
      grid-column: 1 / -1;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      box-shadow: var(--shadow);
    }

    /* Mild different tints per stage */
    .ko-r32{
      background: linear-gradient(180deg, rgba(122,162,255,0.08), rgba(122,162,255,0.02));
    }
    .ko-r16{
      background: linear-gradient(180deg, rgba(94,230,168,0.08), rgba(94,230,168,0.02));
    }
    .ko-qf{
      background: linear-gradient(180deg, rgba(94,230,255,0.08), rgba(94,230,255,0.02));
    }
    .ko-sf{
      background: linear-gradient(180deg, rgba(255,184,107,0.08), rgba(255,184,107,0.02));
    }
    .ko-third{
      background: linear-gradient(180deg, rgba(255,107,122,0.07), rgba(255,107,122,0.02));
    }
    .ko-final{
      background: linear-gradient(180deg, rgba(122,255,187,0.08), rgba(122,255,187,0.02));
    }

    .ko-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 780px){
      .ko-grid{ grid-template-columns: 1fr 1fr; }
    }
    @media (min-width: 1100px){
      .ko-grid{ grid-template-columns: 1fr 1fr 1fr; }
    }
    @media (min-width: 1400px){
      .ko-grid{ grid-template-columns: 1fr 1fr 1fr 1fr; }
    }

    /* Centered rounds (SF/3P/Final) */
    .ko-grid.centered{
      grid-template-columns: 1fr;
      justify-items: center;
    }
    .ko-grid.centered .match-card{
      width: min(760px, 100%);
    }

   .match-card {
  position: relative;
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 12px;
  padding: 10px 12px;
  background: rgba(255,255,255,0.04);
  transition: transform 120ms ease, box-shadow 120ms ease, border-color 120ms ease;
}

    .match-card .match-tag {
  position: absolute;
  top: 10px;
  right: 10px;
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.20);
  background: rgba(0,0,0,0.25);
  backdrop-filter: blur(6px);
  letter-spacing: 0.2px;
  user-select: none;
}

    .match--first-base  { border-color: rgba(255,255,255,0.30); box-shadow: 0 0 0 2px rgba(255,255,255,0.06); }
.match--second-base { border-color: rgba(255,255,255,0.45); box-shadow: 0 0 0 2px rgba(255,255,255,0.10); }
.match--third-base  { border-color: rgba(255,255,255,0.70); box-shadow: 0 0 0 2px rgba(255,255,255,0.14); }

.match--home-run {
  border-color: rgba(255,255,255,0.90);
  box-shadow: 0 0 0 2px rgba(255,255,255,0.18), 0 8px 24px rgba(0,0,0,0.30);
  transform: translateY(-1px);
}

.match--grand-slam {
  border-color: rgba(255,255,255,1);
  box-shadow: 0 0 0 2px rgba(255,255,255,0.22), 0 10px 30px rgba(0,0,0,0.35);
  transform: translateY(-2px);
}

/* Optional: make the badge “feel” more premium as priority increases */
.match--first-base  .match-tag { opacity: 0.85; }
.match--second-base .match-tag { opacity: 0.90; }
.match--third-base  .match-tag { opacity: 0.95; font-weight: 600; }
.match--home-run    .match-tag { font-weight: 700; }
.match--grand-slam  .match-tag { font-weight: 800; }

    
    /* Match index top-left */
    .match-index{
      position:absolute;
      top: 8px;
      left: 10px;
      font-size: 10px;
      font-weight: 800;
      letter-spacing: 0.4px;
      color: rgba(255,255,255,0.7);
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
    }

    /* Center label above the mid box */
    .match-vs{
      grid-column: 1 / -1;
      text-align: center;
      font-weight: 800;
      font-size: 12.2px;
      letter-spacing: 0.35px;
      color: rgba(255,255,255,0.9);
      margin-top: 2px;
      margin-bottom: 2px;
    }

    .match-team{
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      font-size: 12.8px;
      cursor: pointer;
      text-align: center;
      user-select: none;
      transition: background 120ms ease, border-color 120ms ease, box-shadow 120ms ease;
    }
    .match-team.locked{
      cursor: default;
      opacity: 0.9;
    }

    .match-team.winning{
      background: var(--win-bg);
      border-color: var(--win-br);
      box-shadow:
        0 0 0 1px var(--win-glow) inset,
        0 0 14px rgba(122,255,187,0.12);
    }

    .match-mid{
      min-width: 56px;
      text-align: center;
      font-weight: 900;
      font-size: 12.5px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      letter-spacing: 1px;
    }

    /* Bottom meta */
    .match-bottom{
      grid-column: 1 / -1;
      display:flex;
      justify-content: space-between;
      gap: 10px;
      margin-top: 2px;
      color: var(--muted);
      flex-wrap: wrap;
    }
    .match-bottom .chip{
      display:inline-block;
      padding: 3px 7px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(255,255,255,0.04);
      font-size: 10.8px;
      white-space: nowrap;
    }

    .r32-note{
      margin-top: 8px;
      font-size: 10.8px;
      color: var(--muted);
      opacity: 0.9;
    }

    /* ==========================
       PRINT MODAL
    ========================== */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(6px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 14px;
    }
    .modal-backdrop.show{ display: flex; }

    .modal{
      width: min(980px, 100%);
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .modal-head{
      padding: 14px 16px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      gap: 10px;
    }
    .modal-title{
      font-size: 13.5px;
      font-weight: 800;
      letter-spacing: 0.4px;
      text-transform: uppercase;
      color: rgba(255,255,255,0.85);
    }
    .modal-body{
      padding: 14px 16px 6px 16px;
      display:grid;
      gap: 12px;
    }
    .modal-preview{
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(255,255,255,0.03);
      padding: 10px;
      display:flex;
      justify-content: center;
      align-items: center;
      min-height: 220px;
    }
    .modal-preview img{
      max-width: 100%;
      height: auto;
      border-radius: 10px;
      box-shadow: 0 8px 22px rgba(0,0,0,0.28);
    }
    .modal-foot{
      padding: 12px 16px 16px 16px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
      border-top: 1px solid var(--border);
    }
    .modal-note{
      font-size: 11px;
      color: var(--muted);
    }
  </style>
</head>

<body>
  <header>
    <div>
      <h1>Qualifier Pools → Groups → Third Ranking → Knockouts</h1>
      <div class="hint">
        <div class="hint-line">Click/tap two teams in the same editable zone to swap positions.</div>
        <div class="hint-line">Use “Place qualifiers to the groups” to copy pool winners into groups.</div>
        <div class="hint-line">
          R32 third-place assignments are frozen once generated — reordering the Third Ranking won’t update R32
          and subsequent fixtures until you click “Regenerate R32”.
        </div>
      </div>
    </div>

    <div class="actions">
      <button id="clearMovedBtn">Clear moved flags</button>
      <button id="resetBtn">Reset ALL</button>
    </div>
  </header>

  <main class="board" id="board"></main>

  <div class="footer">
    Pools editable only in Pool mode. Groups + Third-place ranking editable only in Group mode.
  </div>

  <!-- ==========================
       PRINT RESULT MODAL
  ========================== -->
  <div id="printModalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="printModalTitle">
      <div class="modal-head">
        <div class="modal-title" id="printModalTitle">Your Knockout Bracket Image</div>
        <button id="closePrintModal" class="btn-mini">Close</button>
      </div>
      <div class="modal-body">
        <div class="modal-note">
          This image includes your path from <b>R16 → QF → SF → Final + 3rd Place</b> using <b>FLAG + ABBR</b>.
        </div>
        <div class="modal-preview">
          <img id="printPreviewImg" alt="Prediction preview" />
        </div>
      </div>
      <div class="modal-foot">
        <button id="viewPrintImgBtn" class="btn-orange">View image</button>
        <button id="downloadPrintImgBtn" class="btn-green">Download PNG</button>
      </div>
    </div>
  </div>

    <!-- ==========================
       GROUP SCHEDULE MODAL
  ========================== -->
  <div id="groupScheduleBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="groupScheduleTitle">
      <div class="modal-head">
        <div class="modal-title" id="groupScheduleTitle">Group – Match Schedule</div>
        <button id="closeGroupScheduleModal" class="btn-mini">Close</button>
      </div>
      <div class="modal-body">
     <div class="modal-note">
        Fixtures for the selected group (stadium time and your local time).
          </div>
        <div id="groupScheduleContent" class="group-fixtures"></div>
      </div>
    </div>
  </div>


  <script>
    /* ==============================
       1) GROUPS + PATHS
    ============================== */
    const DEFAULT_GROUPS = {
      A: ["Mexico","South Africa","South Korea","UEFA Path D"],
      B: ["Canada","UEFA Path A","Qatar","Switzerland"],
      C: ["Brazil","Morocco","Haiti","Scotland"],
      D: ["United States","Paraguay","Australia","UEFA Path C"],
      E: ["Germany","Curaçao","Ivory Coast","Ecuador"],
      F: ["Netherlands","Japan","UEFA Path B","Tunisia"],
      G: ["Belgium","Egypt","Iran","New Zealand"],
      H: ["Spain","Cape Verde","Saudi Arabia","Uruguay"],
      I: ["France","Senegal","FIFA IC Path 2","Norway"],
      J: ["Argentina","Algeria","Austria","Jordan"],
      K: ["Portugal","FIFA IC Path 1","Uzbekistan","Colombia"],
      L: ["England","Croatia","Ghana","Panama"]
    };

    const PATHS = [
      { id: "uefapath-a", label: "UEFA Path A",
        candidates: ["Wales", "Bosnia and Herzegovina", "Italy", "Northern Ireland"], group: "B" },
      { id: "uefapath-b", label: "UEFA Path B",
        candidates: ["Ukraine", "Sweden", "Poland", "Albania"], group: "F" },
      { id: "uefapath-c", label: "UEFA Path C",
        candidates: ["Slovakia", "Kosovo", "Turkey", "Romania"], group: "D" },
      { id: "uefapath-d", label: "UEFA Path D",
        candidates: ["Czech Republic", "Republic of Ireland", "Denmark", "North Macedonia"], group: "A" },
      { id: "fifaicpath-1", label: "FIFA IC Path 1",
        candidates: ["New Caledonia", "Jamaica", "DR Congo"], group: "K" },
      { id: "fifaicpath-2", label: "FIFA IC Path 2",
        candidates: ["Bolivia", "Suriname", "Iraq"], group: "I" }
    ];

    const PATH_BY_ID = Object.fromEntries(PATHS.map(p => [p.id, p]));
    const PATH_ID_BY_LABEL = Object.fromEntries(PATHS.map(p => [p.label, p.id]));
    const GROUP_KEYS = Object.keys(DEFAULT_GROUPS);

    const SLOT_IDS = new Set(PATHS.map(p => p.id)); // e.g. "UEFA Path D", "FIFA IC Path 1"

function resolveSlotTeam(labelOrId) {
  // Only resolve placeholders/paths while editing Groups
  if (editMode !== "groups") return labelOrId;

  if (!labelOrId) return labelOrId;

  const pathId = SLOT_IDS.has(labelOrId) ? labelOrId : PATH_ID_BY_LABEL[labelOrId];
  if (!pathId) return labelOrId; // real team name, not a slot

  const chosenObj  = state.paths?.[pathId]?.[0]; // selected team object (if any)
  const chosenName = chosenObj?.name;

  // If reset cleared selections, chosenName is empty -> show placeholder
  return chosenName || PATH_BY_ID[pathId]?.label || labelOrId;
}


function getResolvedGroupFixtures(groupKey) {
  return (GROUP_FIXTURES[groupKey] || []).map(f => ({
    ...f,                    // clone row (do NOT mutate base)
    home: resolveSlotTeam(f.home),
    away: resolveSlotTeam(f.away),
  }));
}



    const toId = (name) =>
      String(name || "")
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/(^-|-$)/g, "");
    /* ==============================
       GROUP FIXTURES (FULL SCHEDULE)
    ============================== */
    const GROUP_FIXTURES = {
     A:[
  { date:"Thursday, June 11, 2026", match:1,  home:"Mexico",                    away:"South Africa",                 stadium:"Estadio Banorte",           city:"Mexico City",     localTime:"1:00 p.m.",  offsetHours:-6 },
  { date:"Thursday, June 11, 2026", match:2,  home:"South Korea",               away:"UEFA Path D",                  stadium:"Estadio Akron",             city:"Zapopan",         localTime:"8:00 p.m.",  offsetHours:-6 },
  { date:"Thursday, June 18, 2026", match:25, home:"UEFA Path D",               away:"South Africa",                 stadium:"Mercedes-Benz Stadium",     city:"Atlanta",         localTime:"12:00 p.m.", offsetHours:-4 },
  { date:"Thursday, June 18, 2026", match:28, home:"Mexico",                    away:"South Korea",                 stadium:"Estadio Akron",             city:"Zapopan",         localTime:"9:00 p.m.",  offsetHours:-6 },
  { date:"Wednesday, June 24, 2026",match:53, home:"UEFA Path D",               away:"Mexico",                       stadium:"Estadio Banorte",           city:"Mexico City",     localTime:"7:00 p.m.",  offsetHours:-6 },
  { date:"Wednesday, June 24, 2026",match:54, home:"South Africa",              away:"South Korea",                 stadium:"Estadio BBVA",              city:"Guadalupe",       localTime:"7:00 p.m.",  offsetHours:-6 }
],

B:[
  { date:"Friday, June 12, 2026",   match:3,  home:"Canada",                    away:"UEFA Path A",                  stadium:"BMO Field",                 city:"Toronto",         localTime:"3:00 p.m.",  offsetHours:-4 },
  { date:"Saturday, June 13, 2026", match:5,  home:"Qatar",                     away:"Switzerland",                 stadium:"Levi's Stadium",            city:"Santa Clara",     localTime:"12:00 p.m.", offsetHours:-7 },
  { date:"Thursday, June 18, 2026", match:26, home:"Switzerland",               away:"UEFA Path A",                  stadium:"SoFi Stadium",              city:"Inglewood",       localTime:"12:00 p.m.", offsetHours:-7 },
  { date:"Thursday, June 18, 2026", match:27, home:"Canada",                    away:"Qatar",                        stadium:"BC Place",                  city:"Vancouver",       localTime:"3:00 p.m.",  offsetHours:-7 },
  { date:"Wednesday, June 24, 2026",match:49, home:"Switzerland",               away:"Canada",                      stadium:"BC Place",                  city:"Vancouver",       localTime:"12:00 p.m.", offsetHours:-7 },
  { date:"Wednesday, June 24, 2026",match:50, home:"UEFA Path A",              away:"Qatar",                        stadium:"Lumen Field",               city:"Seattle",         localTime:"12:00 p.m.", offsetHours:-7 }
],

C:[
  { date:"Saturday, June 13, 2026", match:6,  home:"Brazil",                    away:"Morocco",                     stadium:"MetLife Stadium",           city:"East Rutherford", localTime:"6:00 p.m.",  offsetHours:-4 },
  { date:"Saturday, June 13, 2026", match:7,  home:"Haiti",                     away:"Scotland",                    stadium:"Gillette Stadium",          city:"Foxborough",      localTime:"9:00 p.m.",  offsetHours:-4 },
  { date:"Friday, June 19, 2026",   match:30, home:"Scotland",                  away:"Morocco",                     stadium:"Gillette Stadium",          city:"Foxborough",      localTime:"6:00 p.m.",  offsetHours:-4 },
  { date:"Friday, June 19, 2026",   match:31, home:"Brazil",                    away:"Haiti",                       stadium:"Lincoln Financial Field",   city:"Philadelphia",    localTime:"9:00 p.m.",  offsetHours:-4 },
  { date:"Wednesday, June 24, 2026",match:51, home:"Scotland",                  away:"Brazil",                      stadium:"Hard Rock Stadium",         city:"Miami Gardens",   localTime:"6:00 p.m.",  offsetHours:-4 },
  { date:"Wednesday, June 24, 2026",match:52, home:"Morocco",                   away:"Haiti",                       stadium:"Mercedes-Benz Stadium",     city:"Atlanta",         localTime:"6:00 p.m.",  offsetHours:-4 }
],

D:[
  { date:"Friday, June 12, 2026",   match:4,  home:"United States",             away:"Paraguay",                    stadium:"SoFi Stadium",              city:"Inglewood",       localTime:"6:00 p.m.",  offsetHours:-7 },
  { date:"Saturday, June 13, 2026", match:8,  home:"Australia",                 away:"UEFA Path C",                  stadium:"BC Place",                  city:"Vancouver",       localTime:"9:00 p.m.",  offsetHours:-7 },
  { date:"Friday, June 19, 2026",   match:29, home:"United States",             away:"Australia",                   stadium:"Lumen Field",               city:"Seattle",         localTime:"12:00 p.m.", offsetHours:-7 },
  { date:"Friday, June 19, 2026",   match:32, home:"UEFA Path C",                away:"Paraguay",                    stadium:"Levi's Stadium",            city:"Santa Clara",     localTime:"9:00 p.m.",  offsetHours:-7 },
  { date:"Thursday, June 25, 2026", match:59, home:"UEFA Path C",                away:"United States",               stadium:"SoFi Stadium",              city:"Inglewood",       localTime:"7:00 p.m.",  offsetHours:-7 },
  { date:"Thursday, June 25, 2026", match:60, home:"Paraguay",                  away:"Australia",                   stadium:"Levi's Stadium",            city:"Santa Clara",     localTime:"7:00 p.m.",  offsetHours:-7 }
],

E:[
  { date:"Sunday, June 14, 2026",   match:9,  home:"Germany",                   away:"Curaçao",                     stadium:"NRG Stadium",               city:"Houston",         localTime:"12:00 p.m.", offsetHours:-5 },
  { date:"Sunday, June 14, 2026",   match:11, home:"Ivory Coast",               away:"Ecuador",                     stadium:"Lincoln Financial Field",   city:"Philadelphia",    localTime:"7:00 p.m.",  offsetHours:-4 },
  { date:"Saturday, June 20, 2026", match:34, home:"Germany",                   away:"Ivory Coast",                 stadium:"BMO Field",                 city:"Toronto",         localTime:"4:00 p.m.",  offsetHours:-4 },
  { date:"Saturday, June 20, 2026", match:35, home:"Ecuador",                   away:"Curaçao",                     stadium:"Arrowhead Stadium",         city:"Kansas City",     localTime:"7:00 p.m.",  offsetHours:-5 },
  { date:"Thursday, June 25, 2026", match:55, home:"Ecuador",                   away:"Germany",                     stadium:"MetLife Stadium",           city:"East Rutherford", localTime:"4:00 p.m.",  offsetHours:-4 },
  { date:"Thursday, June 25, 2026", match:56, home:"Curaçao",                   away:"Ivory Coast",                 stadium:"Lincoln Financial Field",   city:"Philadelphia",    localTime:"4:00 p.m.",  offsetHours:-4 }
],

F:[
  { date:"Sunday, June 14, 2026",   match:10, home:"Netherlands",               away:"Japan",                       stadium:"AT&T Stadium",              city:"Arlington",       localTime:"3:00 p.m.",  offsetHours:-5 },
  { date:"Sunday, June 14, 2026",   match:12, home:"UEFA Path B",                away:"Tunisia",                     stadium:"Estadio BBVA",              city:"Guadalupe",       localTime:"8:00 p.m.",  offsetHours:-6 },
  { date:"Saturday, June 20, 2026", match:33, home:"Netherlands",               away:"UEFA Path B",                  stadium:"NRG Stadium",               city:"Houston",         localTime:"12:00 p.m.", offsetHours:-5 },
  { date:"Saturday, June 20, 2026", match:36, home:"Tunisia",                   away:"Japan",                       stadium:"Estadio BBVA",              city:"Guadalupe",       localTime:"10:00 p.m.", offsetHours:-6 },
  { date:"Thursday, June 25, 2026", match:57, home:"Japan",                     away:"UEFA Path B",                  stadium:"AT&T Stadium",              city:"Arlington",       localTime:"6:00 p.m.",  offsetHours:-5 },
  { date:"Thursday, June 25, 2026", match:58, home:"Tunisia",                   away:"Netherlands",                 stadium:"Arrowhead Stadium",         city:"Kansas City",     localTime:"6:00 p.m.",  offsetHours:-5 }
],

G:[
  { date:"Monday, June 15, 2026",   match:14, home:"Belgium",                   away:"Egypt",                       stadium:"Lumen Field",               city:"Seattle",         localTime:"3:00 p.m.",  offsetHours:-7 },
  { date:"Monday, June 15, 2026",   match:16, home:"Iran",                      away:"New Zealand",                 stadium:"SoFi Stadium",              city:"Inglewood",       localTime:"9:00 p.m.",  offsetHours:-7 },
  { date:"Sunday, June 21, 2026",   match:38, home:"Belgium",                   away:"Iran",                        stadium:"SoFi Stadium",              city:"Inglewood",       localTime:"12:00 p.m.", offsetHours:-7 },
  { date:"Sunday, June 21, 2026",   match:40, home:"New Zealand",              away:"Egypt",                       stadium:"BC Place",                  city:"Vancouver",       localTime:"6:00 p.m.",  offsetHours:-7 },
  { date:"Friday, June 26, 2026",   match:65, home:"Egypt",                     away:"Iran",                        stadium:"Lumen Field",               city:"Seattle",         localTime:"8:00 p.m.",  offsetHours:-7 },
  { date:"Friday, June 26, 2026",   match:66, home:"New Zealand",              away:"Belgium",                     stadium:"BC Place",                  city:"Vancouver",       localTime:"8:00 p.m.",  offsetHours:-7 }
],

H:[
  { date:"Monday, June 15, 2026",   match:13, home:"Spain",                     away:"Cape Verde",                  stadium:"Mercedes-Benz Stadium",     city:"Atlanta",         localTime:"12:00 p.m.", offsetHours:-4 },
  { date:"Monday, June 15, 2026",   match:15, home:"Saudi Arabia",             away:"Uruguay",                     stadium:"Hard Rock Stadium",         city:"Miami Gardens",   localTime:"6:00 p.m.",  offsetHours:-4 },
  { date:"Sunday, June 21, 2026",   match:37, home:"Spain",                     away:"Saudi Arabia",               stadium:"Mercedes-Benz Stadium",     city:"Atlanta",         localTime:"12:00 p.m.", offsetHours:-4 },
  { date:"Sunday, June 21, 2026",   match:39, home:"Uruguay",                   away:"Cape Verde",                 stadium:"Hard Rock Stadium",         city:"Miami Gardens",   localTime:"6:00 p.m.",  offsetHours:-4 },
  { date:"Friday, June 26, 2026",   match:63, home:"Cape Verde",                away:"Saudi Arabia",               stadium:"NRG Stadium",               city:"Houston",         localTime:"7:00 p.m.",  offsetHours:-5 },
  { date:"Friday, June 26, 2026",   match:64, home:"Uruguay",                   away:"Spain",                      stadium:"Estadio Akron",             city:"Zapopan",         localTime:"6:00 p.m.",  offsetHours:-6 }
],

I:[
  { date:"Tuesday, June 16, 2026",  match:17, home:"France",                    away:"Senegal",                     stadium:"MetLife Stadium",           city:"East Rutherford", localTime:"3:00 p.m.",  offsetHours:-4 },
  { date:"Tuesday, June 16, 2026",  match:18, home:"FIFA IC Path 2",            away:"Norway",                      stadium:"Gillette Stadium",          city:"Foxborough",      localTime:"6:00 p.m.",  offsetHours:-4 },
  { date:"Monday, June 22, 2026",   match:42, home:"France",                    away:"FIFA IC Path 2",              stadium:"Lincoln Financial Field",   city:"Philadelphia",    localTime:"5:00 p.m.",  offsetHours:-4 },
  { date:"Monday, June 22, 2026",   match:43, home:"Norway",                    away:"Senegal",                    stadium:"MetLife Stadium",           city:"East Rutherford", localTime:"8:00 p.m.",  offsetHours:-4 },
  { date:"Friday, June 26, 2026",   match:61, home:"Norway",                    away:"France",                     stadium:"Gillette Stadium",          city:"Foxborough",      localTime:"3:00 p.m.",  offsetHours:-4 },
  { date:"Friday, June 26, 2026",   match:62, home:"Senegal",                   away:"FIFA IC Path 2",              stadium:"BMO Field",                 city:"Toronto",         localTime:"3:00 p.m.",  offsetHours:-4 }
],

J:[
  { date:"Tuesday, June 16, 2026",  match:19, home:"Argentina",                 away:"Algeria",                     stadium:"Arrowhead Stadium",         city:"Kansas City",     localTime:"8:00 p.m.",  offsetHours:-5 },
  { date:"Tuesday, June 16, 2026",  match:20, home:"Austria",                   away:"Jordan",                     stadium:"Levi's Stadium",            city:"Santa Clara",     localTime:"9:00 p.m.",  offsetHours:-7 },
  { date:"Monday, June 22, 2026",   match:41, home:"Argentina",                 away:"Austria",                    stadium:"AT&T Stadium",              city:"Arlington",       localTime:"12:00 p.m.", offsetHours:-5 },
  { date:"Monday, June 22, 2026",   match:44, home:"Jordan",                    away:"Algeria",                    stadium:"Levi's Stadium",            city:"Santa Clara",     localTime:"8:00 p.m.",  offsetHours:-7 },
  { date:"Saturday, June 27, 2026", match:71, home:"Algeria",                   away:"Austria",                    stadium:"Arrowhead Stadium",         city:"Kansas City",     localTime:"9:00 p.m.",  offsetHours:-5 },
  { date:"Saturday, June 27, 2026", match:72, home:"Jordan",                    away:"Argentina",                  stadium:"AT&T Stadium",              city:"Arlington",       localTime:"9:00 p.m.",  offsetHours:-5 }
],

K:[
  { date:"Wednesday, June 17, 2026",match:21, home:"Portugal",                  away:"FIFA IC Path 1",              stadium:"NRG Stadium",               city:"Houston",         localTime:"12:00 p.m.", offsetHours:-5 },
  { date:"Wednesday, June 17, 2026",match:24, home:"Uzbekistan",                away:"Colombia",                   stadium:"Estadio Banorte",           city:"Mexico City",     localTime:"8:00 p.m.",  offsetHours:-6 },
  { date:"Tuesday, June 23, 2026",  match:45, home:"Portugal",                  away:"Uzbekistan",                 stadium:"NRG Stadium",               city:"Houston",         localTime:"12:00 p.m.", offsetHours:-5 },
  { date:"Tuesday, June 23, 2026",  match:48, home:"Colombia",                  away:"FIFA IC Path 1",              stadium:"Estadio Akron",             city:"Zapopan",         localTime:"8:00 p.m.",  offsetHours:-6 },
  { date:"Saturday, June 27, 2026", match:69, home:"Colombia",                  away:"Portugal",                   stadium:"Hard Rock Stadium",         city:"Miami Gardens",   localTime:"7:30 p.m.",  offsetHours:-4 },
  { date:"Saturday, June 27, 2026", match:70, home:"FIFA IC Path 1",             away:"Uzbekistan",                 stadium:"Mercedes-Benz Stadium",     city:"Atlanta",         localTime:"7:30 p.m.",  offsetHours:-4 }
],

L:[
  { date:"Wednesday, June 17, 2026",match:22, home:"England",                   away:"Croatia",                    stadium:"AT&T Stadium",              city:"Arlington",       localTime:"3:00 p.m.",  offsetHours:-5 },
  { date:"Wednesday, June 17, 2026",match:23, home:"Ghana",                     away:"Panama",                     stadium:"BMO Field",                 city:"Toronto",         localTime:"7:00 p.m.",  offsetHours:-4 },
  { date:"Tuesday, June 23, 2026",  match:46, home:"England",                   away:"Ghana",                      stadium:"Gillette Stadium",          city:"Foxborough",      localTime:"4:00 p.m.",  offsetHours:-4 },
  { date:"Tuesday, June 23, 2026",  match:47, home:"Panama",                    away:"Croatia",                    stadium:"BMO Field",                 city:"Toronto",         localTime:"7:00 p.m.",  offsetHours:-4 },
  { date:"Saturday, June 27, 2026", match:67, home:"Panama",                    away:"England",                    stadium:"MetLife Stadium",           city:"East Rutherford", localTime:"5:00 p.m.",  offsetHours:-4 },
  { date:"Saturday, June 27, 2026", match:68, home:"Croatia",                   away:"Ghana",                      stadium:"Lincoln Financial Field",   city:"Philadelphia",    localTime:"5:00 p.m.",  offsetHours:-4 }
]

    };

    // ==============================
// Time conversion helpers
// ==============================

function parseTwelveHourTime(str){
  // Expect formats like "1:00 p.m." / "3:30 a.m."
  if(!str) return null;
  const m = str.match(/(\d{1,2}):(\d{2})\s*(a\.m\.|p\.m\.)/i);
  if(!m) return null;

  let hour = parseInt(m[1], 10);
  const minute = parseInt(m[2], 10);
  const ampm = m[3].toLowerCase();

  const isPM = ampm.startsWith("p");
  if(hour === 12){
    hour = isPM ? 12 : 0;
  } else if(isPM){
    hour += 12;
  }

  return { hour, minute };
}

/**
 * Given fixture {date, localTime, offsetHours}, return the same
 * moment in the user's local time zone.
 *
 * offsetHours = stadium offset from UTC (e.g. -5 for UTC-5).
 */
function fixtureToUserLocalDate(fixture){
  if(!fixture || typeof fixture.offsetHours !== "number" || !fixture.date || !fixture.localTime){
    return null;
  }

  const tm = parseTwelveHourTime(fixture.localTime);
  if(!tm) return null;

  // Parse the calendar date. JS understands strings like "Tuesday, June 16, 2026"
  const tmp = new Date(fixture.date);
  if(isNaN(tmp.getTime())) return null;

  const y = tmp.getFullYear();
  const m = tmp.getMonth();      // 0-based
  const d = tmp.getDate();

  // Stadium local time -> UTC:
  // local = UTC + offsetHours  =>  UTC = local - offsetHours
  const utcMs = Date.UTC(
    y, m, d,
    tm.hour - fixture.offsetHours,
    tm.minute
  );

  return new Date(utcMs); // in user's local timezone when formatted
}

function formatUserLocalForFixture(fixture){
  const userDate = fixtureToUserLocalDate(fixture);
  if(!userDate) return { dateText: "", timeText: "" };

  const dateText = userDate.toLocaleDateString(undefined, {
    weekday: "short",
    month: "short",
    day: "numeric"
  });

  const timeText = userDate.toLocaleTimeString(undefined, {
    hour: "numeric",
    minute: "2-digit"
  });

  return { dateText, timeText };
}


    /* ==============================
       2) Rank + odds models (AUTO)
    ============================== */
    const RANK_BY_NAME = {
      "Spain":1,
      "Argentina":2,
      "France":3,
      "England":4,
      "Brazil":5,
      "Portugal":6,
      "Netherlands":7,
      "Belgium":8,
      "Germany":9,
      "Croatia":10,
      "Morocco":11,
      "Italy":12,
      "Colombia":13,
      "United States":14,
      "USA":14,
      "Mexico":15,
      "Uruguay":16,
      "Switzerland":17,
      "Japan":18,
      "Senegal":19,
      "Iran":20,
      "Denmark":21,
      "South Korea":22,
      "Ecuador":23,
      "Austria":24,
      "Turkey":25,
      "Türkiye":25,
      "Australia":26,
      "Canada":27,
      "Ukraine":28,
      "Norway":29,
      "Panama":30,
      "Poland":31,
      "Wales":32,
      "Scotland":36,
      "Serbia":37,
      "Nigeria":38,
      "Czechia":39,
      "Czech Republic":39,
      "Tunisia":40,
      "Ivory Coast":42,
      "Côte d'Ivoire":42,
      "Sweden":43,
      "Slovakia":45,
      "Romania":47,
      "Uzbekistan":50,
      "Qatar":51,
      "Saudi Arabia":60,
      "South Africa":61,
      "Albania":63,
      "Jordan":64,
      "Cape Verde":68,
      "Cabo Verde":68,
      "Jamaica":70,
      "Kosovo":80,
      "Curaçao":82,
      "New Zealand":104
    };

    const ODDS_POSITIVE = {
      "Spain": 400,
      "England": 550,
      "France": 700,
      "Brazil": 750,
      "Argentina": 800,
      "Germany": 1200,
      "Portugal": 1200,
      "Netherlands": 1200
    };

    function rankOf(name){
      if(!name) return 999;
      return RANK_BY_NAME[name] ?? 999;
    }

    function impliedProbFromPositiveOdds(x){
      return 100 / (x + 100);
    }

    function pickWinnerNameAuto(a, b){
      const aOdds = ODDS_POSITIVE[a];
      const bOdds = ODDS_POSITIVE[b];

      if(aOdds && bOdds){
        const pa = impliedProbFromPositiveOdds(aOdds);
        const pb = impliedProbFromPositiveOdds(bOdds);
        const sum = pa + pb;
        const ra = pa / sum;
        return Math.random() < ra ? a : b;
      }

      const ra = rankOf(a);
      const rb = rankOf(b);
      if(ra === rb){
        return String(a).localeCompare(String(b)) <= 0 ? a : b;
      }
      return ra < rb ? a : b;
    }

    /* ==============================
       3) Flags (image-based for DOM)
    ============================== */
    const FLAG_CODE_BY_NAME = {
      "Mexico":"mx",
      "South Africa":"za",
      "South Korea":"kr",
      "Canada":"ca",
      "Qatar":"qa",
      "Switzerland":"ch",
      "Brazil":"br",
      "Morocco":"ma",
      "Haiti":"ht",
      "Scotland":"gb",
      "United States":"us",
      "United States of America":"us",
      "USA":"us",
      "Paraguay":"py",
      "Australia":"au",
      "Germany":"de",
      "Curaçao":"cw",
      "Ivory Coast":"ci",
      "Côte d'Ivoire":"ci",
      "Ecuador":"ec",
      "Netherlands":"nl",
      "Japan":"jp",
      "Tunisia":"tn",
      "Belgium":"be",
      "Egypt":"eg",
      "Iran":"ir",
      "New Zealand":"nz",
      "Spain":"es",
      "Cape Verde":"cv",
      "Cabo Verde":"cv",
      "Saudi Arabia":"sa",
      "Uruguay":"uy",
      "France":"fr",
      "Senegal":"sn",
      "Norway":"no",
      "Argentina":"ar",
      "Algeria":"dz",
      "Austria":"at",
      "Jordan":"jo",
      "Portugal":"pt",
      "Uzbekistan":"uz",
      "Colombia":"co",
      "England":"gb",
      "Croatia":"hr",
      "Ghana":"gh",
      "Panama":"pa",
      "Wales":"gb",
      "Bosnia and Herzegovina":"ba",
      "Italy":"it",
      "Northern Ireland":"gb",
      "Ukraine":"ua",
      "Sweden":"se",
      "Poland":"pl",
      "Albania":"al",
      "Slovakia":"sk",
      "Kosovo":"xk",
      "Turkey":"tr",
      "Türkiye":"tr",
      "Romania":"ro",
      "Czech Republic":"cz",
      "Czechia":"cz",
      "Republic of Ireland":"ie",
      "Denmark":"dk",
      "North Macedonia":"mk",
      "New Caledonia":"nc",
      "Jamaica":"jm",
      "DR Congo":"cd",
      "Bolivia":"bo",
      "Suriname":"sr",
      "Iraq":"iq",
      "Serbia":"rs",
      "Nigeria":"ng"
    };

   /* ==============================
   FLAGS (LOCAL SVG)
============================== */

const FLAG_BASE = "./svg/"; // same level as index.html

function flagURLByName(name){
  if(!name) return "";

  // skip placeholders/paths
  if(
    name.startsWith("UEFA Path") ||
    name.startsWith("FIFA IC Path") ||
    name.includes("UEFA Path") ||
    name.includes("FIFA IC Path")
  ) return "";

  const code = FLAG_CODE_BY_NAME[name];
  if(!code) return "";

  return `${FLAG_BASE}${code}.svg`;
}

function flagHTML(name, extraClass=""){
  const url = flagURLByName(name);
  if(!url) return "";

  // Use SVG from local folder
  return `
    <img
      class="flag-img ${extraClass}"
      src="${url}"
      alt=""
      loading="lazy"
      onerror="this.style.display='none'"
    >
  `;
}

function nameWithFlagHTML(name){
  return `${flagHTML(name)}${name ?? ""}`;
}


    /* ==============================
       3b) Flags for CANVAS (emoji)
    ============================== */
    function isoToFlagEmoji(iso){
      if(!iso || iso.length !== 2) return "";
      const cc = iso.toUpperCase();
      const A = 0x1F1E6;
      const base = "A".charCodeAt(0);
      const c1 = cc.charCodeAt(0) - base;
      const c2 = cc.charCodeAt(1) - base;
      if(c1 < 0 || c2 < 0) return "";
      return String.fromCodePoint(A + c1, A + c2);
    }
    function flagEmojiForName(name){
      if(!name) return "";
      if(name.startsWith("UEFA Path") || name.startsWith("FIFA IC Path") || name.includes("UEFA Path")) return "";
      const code = FLAG_CODE_BY_NAME[name];
      // Kosovo "xk" isn't a standard flag emoji in many fonts
      if(code === "xk") return "";
      if(!code || code.length !== 2) return "";
      return isoToFlagEmoji(code);
    }

    /* ==============================
       4) Edit mode + click-swap state
    ============================== */
    let editMode = "pools";
    let swapSelection = null;

    let qualifiedThirdGroupLetters = "";
    let qualifiedThirdPlacedTeams = [];

    let thirdRankingDirty = false;

    /* ==============================
       5) Build state
    ============================== */
    function buildGroupsFromDefaults(){
      const groups = {};
      GROUP_KEYS.forEach(g => {
        groups[g] = DEFAULT_GROUPS[g].map(entryName => {
          const pathId = PATH_ID_BY_LABEL[entryName];
          if(pathId){
            return {
              id: `ph-${pathId}-${g}`,
              name: entryName,
              tag: "Placeholder",
              isPlaceholder: true,
              pathId,
              userMoved: false
            };
          }
          return {
            id: toId(`${g}-${entryName}`),
            name: entryName,
            tag: `Group ${g}`,
            isPlaceholder: false,
            userMoved: false
          };
        });
      });
      return groups;
    }

    function buildPaths(){
      const paths = {};
      PATHS.forEach(p => {
        paths[p.id] = p.candidates.map(name => ({
          id: toId(`${p.id}-${name}`),
          name,
          tag: p.label,
          originPathId: p.id,
          isQualified: false,
          isEliminated: false,
          userMoved: false
        }));
      });
      return paths;
    }

    function fallbackPathNameForGroup(g){
      const p = PATHS.find(x => x.group === g);
      if(!p) return "TBD";

      if(p.id.startsWith("uefapath-")){
        const letter = p.id.replace("uefapath-","");
        const map = { a: 1, b: 2, c: 3, d: 4 };
        const n = map[letter] ?? letter.toUpperCase();
        return `UEFA Path ${letter.toUpperCase()}`;
      }
      if(p.id.startsWith("fifaicpath-")){
        const n = p.id.replace("fifaicpath-","");
        return `FIFA IC Path ${n}`;
      }
      return p.label;
    }

    function buildThirdRankingFromGroups(groups){
      const base = [];
      GROUP_KEYS.forEach(g => {
        const third = groups[g]?.[2];
        base.push({
          id: toId(`third-${g}`),
          groupKey: g,
          name: third?.name ?? fallbackPathNameForGroup(g),
          userMoved: false
        });
      });
      return base;
    }

    const initialState = () => {
      const groups = buildGroupsFromDefaults();
      const paths  = buildPaths();
      const qualifiedByPath = {};
      PATHS.forEach(p => qualifiedByPath[p.id] = false);

      return {
        paths,
        groups,
        qualifiedByPath,
        thirdRanking: buildThirdRankingFromGroups(groups),

        r32Generated: false,
        winners: {},
        r32ThirdSnapshot: null
      };
    };

    let state = initialState();

    /* ==============================
       6) Zones
    ============================== */
    const pathZones  = PATHS.map(p => `path-${p.id}`);
    const groupZones = GROUP_KEYS.map(g => `group-${g}`);

    const THIRD_RANK_ZONE = "third-ranking";
    const CHAMP_ZONE      = "champions-view";
    const RUNNERS_ZONE    = "runners-view";
    const TOP8_ZONE       = "top8-third-view";

    const zones = [
      ...pathZones,
      ...groupZones,
      THIRD_RANK_ZONE,
      CHAMP_ZONE,
      RUNNERS_ZONE,
      TOP8_ZONE
    ];

    const isPathZone = (z) => z.startsWith("path-");
    const isGroupZone = (z) => z.startsWith("group-");
    const pathIdFromZone = (z) => z.replace("path-","");
    const groupKeyFromZone = (z) => {
      const m = z.match(/^group-([A-L])$/);
      return m ? m[1] : null;
    };

    /* ==============================
       7) KO structure
    ============================== */
    const R32_INFO = {
      73: { date: "June 28, 2026", time: "12:00 p.m.", offsetHours:-7, stadium: "SoFi Stadium", city: "Inglewood" },
      74: { date: "June 29, 2026", time: "4:30 p.m.",  offsetHours:-4, stadium: "Gillette Stadium", city: "Foxborough" },
      75: { date: "June 29, 2026", time: "7:00 p.m.",  offsetHours:-6, stadium: "Estadio BBVA", city: "Guadalupe" },
      76: { date: "June 29, 2026", time: "12:00 p.m.", offsetHours:-5, stadium: "NRG Stadium", city: "Houston" },
      77: { date: "June 30, 2026", time: "5:00 p.m.",  offsetHours:-4, stadium: "MetLife Stadium", city: "East Rutherford" },
      78: { date: "June 30, 2026", time: "12:00 p.m.", offsetHours:-5, stadium: "AT&T Stadium", city: "Arlington" },
      79: { date: "June 30, 2026", time: "7:00 p.m.",  offsetHours:-6, stadium: "Estadio Azteca", city: "Mexico City" },
      80: { date: "July 1, 2026",  time: "12:00 p.m.", offsetHours:-4, stadium: "Mercedes-Benz Stadium", city: "Atlanta" },
      81: { date: "July 1, 2026",  time: "5:00 p.m.",  offsetHours:-7, stadium: "Levi's Stadium", city: "Santa Clara" },
      82: { date: "July 1, 2026",  time: "1:00 p.m.",  offsetHours:-7, stadium: "Lumen Field", city: "Seattle" },
      83: { date: "July 2, 2026",  time: "7:00 p.m.",  offsetHours:-4, stadium: "BMO Field", city: "Toronto" },
      84: { date: "July 2, 2026",  time: "12:00 p.m.", offsetHours:-7, stadium: "SoFi Stadium", city: "Inglewood" },
      85: { date: "July 2, 2026",  time: "8:00 p.m.",  offsetHours:-7, stadium: "BC Place", city: "Vancouver" },
      86: { date: "July 3, 2026",  time: "6:00 p.m.",  offsetHours:-4, stadium: "Hard Rock Stadium", city: "Miami Gardens" },
      87: { date: "July 3, 2026",  time: "8:30 p.m.",  offsetHours:-5, stadium: "Arrowhead Stadium", city: "Kansas City" },
      88: { date: "July 3, 2026",  time: "1:00 p.m.",  offsetHours:-5, stadium: "AT&T Stadium", city: "Arlington" }
    };

    const R16_INFO = {
      89: { date:"July 4, 2026", time:"5:00 p.m.",  offsetHours:-4, stadium:"Lincoln Financial Field", city:"Philadelphia" },
      90: { date:"July 4, 2026", time:"12:00 p.m.", offsetHours:-5, stadium:"NRG Stadium", city:"Houston" },
      91: { date:"July 5, 2026", time:"4:00 p.m.",  offsetHours:-4, stadium:"MetLife Stadium", city:"East Rutherford" },
      92: { date:"July 5, 2026", time:"6:00 p.m.",  offsetHours:-6, stadium:"Estadio Azteca", city:"Mexico City" },
      93: { date:"July 6, 2026", time:"2:00 p.m.",  offsetHours:-5, stadium:"AT&T Stadium", city:"Arlington" },
      94: { date:"July 6, 2026", time:"5:00 p.m.",  offsetHours:-7, stadium:"Lumen Field", city:"Seattle" },
      95: { date:"July 7, 2026", time:"12:00 p.m.", offsetHours:-4, stadium:"Mercedes-Benz Stadium", city:"Atlanta" },
      96: { date:"July 7, 2026", time:"1:00 p.m.",  offsetHours:-7, stadium:"BC Place", city:"Vancouver" }
    };

    const QF_INFO = {
      97: { date:"July 9, 2026",  time:"4:00 p.m.",  offsetHours:-4, stadium:"Gillette Stadium", city:"Foxborough" },
      98: { date:"July 10, 2026", time:"12:00 p.m.", offsetHours:-7, stadium:"SoFi Stadium", city:"Inglewood" },
      99: { date:"July 11, 2026", time:"5:00 p.m.",  offsetHours:-4, stadium:"Hard Rock Stadium", city:"Miami Gardens" },
      100:{ date:"July 11, 2026", time:"8:00 p.m.",  offsetHours:-5, stadium:"Arrowhead Stadium", city:"Kansas City" }
    };

    const SF_INFO = {
      101:{ date:"July 14, 2026", time:"2:00 p.m.", offsetHours:-5, stadium:"AT&T Stadium", city:"Arlington" },
      102:{ date:"July 15, 2026", time:"3:00 p.m.", offsetHours:-4, stadium:"Mercedes-Benz Stadium", city:"Atlanta" }
    };

    const THIRD_INFO = {
      103:{ date:"July 18, 2026", time:"5:00 p.m.", offsetHours:-4, stadium:"Hard Rock Stadium", city:"Miami Gardens" }
    };

    const FINAL_INFO = {
      104:{ date:"July 19, 2026", time:"3:00 p.m.", offsetHours:-4, stadium:"MetLife Stadium", city:"East Rutherford" }
    };

    const R32_MATCHES = [
      { id: 73, left: {type:"RU", g:"A"}, right:{type:"RU", g:"B"} },
      { id: 74, left: {type:"W",  g:"E"}, right:{type:"3SET", set:"A/B/C/D/F"} },
      { id: 75, left: {type:"W",  g:"F"}, right:{type:"RU", g:"C"} },
      { id: 76, left: {type:"W",  g:"C"}, right:{type:"RU", g:"F"} },
      { id: 77, left: {type:"W",  g:"I"}, right:{type:"3SET", set:"C/D/F/G/H"} },
      { id: 78, left: {type:"RU", g:"E"}, right:{type:"RU", g:"I"} },
      { id: 79, left: {type:"W",  g:"A"}, right:{type:"3SET", set:"C/E/F/H/I"} },
      { id: 80, left: {type:"W",  g:"L"}, right:{type:"3SET", set:"E/H/I/J/K"} },
      { id: 81, left: {type:"W",  g:"D"}, right:{type:"3SET", set:"B/E/F/I/J"} },
      { id: 82, left: {type:"W",  g:"G"}, right:{type:"3SET", set:"A/E/H/I/J"} },
      { id: 83, left: {type:"RU", g:"K"}, right:{type:"RU", g:"L"} },
      { id: 84, left: {type:"W",  g:"H"}, right:{type:"RU", g:"J"} },
      { id: 85, left: {type:"W",  g:"B"}, right:{type:"3SET", set:"E/F/G/I/J"} },
      { id: 86, left: {type:"W",  g:"J"}, right:{type:"RU", g:"H"} },
      { id: 87, left: {type:"W",  g:"K"}, right:{type:"3SET", set:"D/E/I/J/L"} },
      { id: 88, left: {type:"RU", g:"D"}, right:{type:"RU", g:"G"} }
    ];

    const R16_MATCHES = [
      { id: 90, left:{type:"WM", id:73}, right:{type:"WM", id:75} },
      { id: 89, left:{type:"WM", id:74}, right:{type:"WM", id:77} },
      { id: 91, left:{type:"WM", id:76}, right:{type:"WM", id:78} },
      { id: 92, left:{type:"WM", id:79}, right:{type:"WM", id:80} },
      { id: 93, left:{type:"WM", id:83}, right:{type:"WM", id:84} },
      { id: 94, left:{type:"WM", id:81}, right:{type:"WM", id:82} },
      { id: 95, left:{type:"WM", id:86}, right:{type:"WM", id:88} },
      { id: 96, left:{type:"WM", id:85}, right:{type:"WM", id:87} }
    ];

    const QF_MATCHES = [
      { id: 97, left:{type:"WM", id:89}, right:{type:"WM", id:90} },
      { id: 98, left:{type:"WM", id:93}, right:{type:"WM", id:94} },
      { id: 99, left:{type:"WM", id:91}, right:{type:"WM", id:92} },
      { id:100, left:{type:"WM", id:95}, right:{type:"WM", id:96} }
    ];

    const SF_MATCHES = [
      { id:101, left:{type:"WM", id:97}, right:{type:"WM", id:98} },
      { id:102, left:{type:"WM", id:99}, right:{type:"WM", id:100} }
    ];

    const THIRD_MATCH = [
      { id:103, left:{type:"LM", id:101}, right:{type:"LM", id:102} }
    ];

    const FINAL_MATCH = [
      { id:104, left:{type:"WM", id:101}, right:{type:"WM", id:102} }
    ];

    const ALL_ROUNDS = {
      r32: R32_MATCHES,
      r16: R16_MATCHES,
      qf:  QF_MATCHES,
      sf:  SF_MATCHES,
      third: THIRD_MATCH,
      final: FINAL_MATCH
    };

    const INFO_BY_MATCH = {
      ...R32_INFO, ...R16_INFO, ...QF_INFO, ...SF_INFO, ...THIRD_INFO, ...FINAL_INFO
    };

    /* ==============================
       8) Third-place mapping table
    ============================== */
    const THIRD_MATCH_ID_ORDER = [79, 85, 81, 74, 82, 77, 87, 80];
    
    const THIRD_TABLE_RAW = {
       "EFGHIJKL ": ["3E","3J","3I","3F","3H","3G","3L","3K"],
 "DFGHIJKL ": ["3H","3G","3I","3D","3J","3F","3L","3K"],
 "DEGHIJKL ": ["3E","3J","3I","3D","3H","3G","3L","3K"],
 "DEFHIJKL ": ["3E","3J","3I","3D","3H","3F","3L","3K"],
 "DEFGIJKL ": ["3E","3G","3I","3D","3J","3F","3L","3K"],
 "DEFGHJKL ": ["3E","3G","3J","3D","3H","3F","3L","3K"],
 "DEFGHIKL ": ["3E","3G","3I","3D","3H","3F","3L","3K"],
 "DEFGHIJL ": ["3E","3G","3J","3D","3H","3F","3L","3I"],
 "DEFGHIJK ": ["3E","3G","3J","3D","3H","3F","3I","3K"],
 "CFGHIJKL ": ["3H","3G","3I","3C","3J","3F","3L","3K"],
 "CEGHIJKL ": ["3E","3J","3I","3C","3H","3G","3L","3K"],
 "CEFHIJKL ": ["3E","3J","3I","3C","3H","3F","3L","3K"],
 "CEFGIJKL ": ["3E","3G","3I","3C","3J","3F","3L","3K"],
 "CEFGHJKL ": ["3E","3G","3J","3C","3H","3F","3L","3K"],
 "CEFGHIKL ": ["3E","3G","3I","3C","3H","3F","3L","3K"],
 "CEFGHIJL ": ["3E","3G","3J","3C","3H","3F","3L","3I"],
 "CEFGHIJK ": ["3E","3G","3J","3C","3H","3F","3I","3K"],
 "CDGHIJKL ": ["3H","3G","3I","3C","3J","3D","3L","3K"],
 "CDFHIJKL ": ["3C","3J","3I","3D","3H","3F","3L","3K"],
 "CDFGIJKL ": ["3C","3G","3I","3D","3J","3F","3L","3K"],
 "CDFGHJKL ": ["3C","3G","3J","3D","3H","3F","3L","3K"],
 "CDFGHIKL ": ["3C","3G","3I","3D","3H","3F","3L","3K"],
 "CDFGHIJL ": ["3C","3G","3J","3D","3H","3F","3L","3I"],
 "CDFGHIJK ": ["3C","3G","3J","3D","3H","3F","3I","3K"],
 "CDEHIJKL ": ["3E","3J","3I","3C","3H","3D","3L","3K"],
 "CDEGIJKL ": ["3E","3G","3I","3C","3J","3D","3L","3K"],
 "CDEGHJKL ": ["3E","3G","3J","3C","3H","3D","3L","3K"],
 "CDEGHIKL ": ["3E","3G","3I","3C","3H","3D","3L","3K"],
 "CDEGHIJL ": ["3E","3G","3J","3C","3H","3D","3L","3I"],
 "CDEGHIJK ": ["3E","3G","3J","3C","3H","3D","3I","3K"],
 "CDEFIJKL ": ["3C","3J","3E","3D","3I","3F","3L","3K"],
 "CDEFHJKL ": ["3C","3J","3E","3D","3H","3F","3L","3K"],
 "CDEFHIKL ": ["3C","3E","3I","3D","3H","3F","3L","3K"],
 "CDEFHIJL ": ["3C","3J","3E","3D","3H","3F","3L","3I"],
 "CDEFHIJK ": ["3C","3J","3E","3D","3H","3F","3I","3K"],
 "CDEFGJKL ": ["3C","3G","3E","3D","3J","3F","3L","3K"],
 "CDEFGIKL ": ["3C","3G","3E","3D","3I","3F","3L","3K"],
 "CDEFGIJL ": ["3C","3G","3E","3D","3J","3F","3L","3I"],
 "CDEFGIJK ": ["3C","3G","3E","3D","3J","3F","3I","3K"],
 "CDEFGHKL ": ["3C","3G","3E","3D","3H","3F","3L","3K"],
 "CDEFGHJL ": ["3C","3G","3J","3D","3H","3F","3L","3E"],
 "CDEFGHJK ": ["3C","3G","3J","3D","3H","3F","3E","3K"],
 "CDEFGHIL ": ["3C","3G","3E","3D","3H","3F","3L","3I"],
 "CDEFGHIK ": ["3C","3G","3E","3D","3H","3F","3I","3K"],
 "CDEFGHIJ ": ["3C","3G","3J","3D","3H","3F","3E","3I"],
 "BFGHIJKL ": ["3H","3J","3B","3F","3I","3G","3L","3K"],
 "BEGHIJKL ": ["3E","3J","3I","3B","3H","3G","3L","3K"],
 "BEFHIJKL ": ["3E","3J","3B","3F","3I","3H","3L","3K"],
 "BEFGIJKL ": ["3E","3J","3B","3F","3I","3G","3L","3K"],
 "BEFGHJKL ": ["3E","3J","3B","3F","3H","3G","3L","3K"],
 "BEFGHIKL ": ["3E","3G","3B","3F","3I","3H","3L","3K"],
 "BEFGHIJL ": ["3E","3J","3B","3F","3H","3G","3L","3I"],
 "BEFGHIJK ": ["3E","3J","3B","3F","3H","3G","3I","3K"],
 "BDGHIJKL ": ["3H","3J","3B","3D","3I","3G","3L","3K"],
 "BDFHIJKL ": ["3H","3J","3B","3D","3I","3F","3L","3K"],
 "BDFGIJKL ": ["3I","3G","3B","3D","3J","3F","3L","3K"],
 "BDFGHJKL ": ["3H","3G","3B","3D","3J","3F","3L","3K"],
 "BDFGHIKL ": ["3H","3G","3B","3D","3I","3F","3L","3K"],
 "BDFGHIJL ": ["3H","3G","3B","3D","3J","3F","3L","3I"],
 "BDFGHIJK ": ["3H","3G","3B","3D","3J","3F","3I","3K"],
 "BDEHIJKL ": ["3E","3J","3B","3D","3I","3H","3L","3K"],
 "BDEGIJKL ": ["3E","3J","3B","3D","3I","3G","3L","3K"],
 "BDEGHJKL ": ["3E","3J","3B","3D","3H","3G","3L","3K"],
 "BDEGHIKL ": ["3E","3G","3B","3D","3I","3H","3L","3K"],
 "BDEGHIJL ": ["3E","3J","3B","3D","3H","3G","3L","3I"],
 "BDEGHIJK ": ["3E","3J","3B","3D","3H","3G","3I","3K"],
 "BDEFIJKL ": ["3E","3J","3B","3D","3I","3F","3L","3K"],
 "BDEFHJKL ": ["3E","3J","3B","3D","3H","3F","3L","3K"],
 "BDEFHIKL ": ["3E","3I","3B","3D","3H","3F","3L","3K"],
 "BDEFHIJL ": ["3E","3J","3B","3D","3H","3F","3L","3I"],
 "BDEFHIJK ": ["3E","3J","3B","3D","3H","3F","3I","3K"],
 "BDEFGJKL ": ["3E","3G","3B","3D","3J","3F","3L","3K"],
 "BDEFGIKL ": ["3E","3G","3B","3D","3I","3F","3L","3K"],
 "BDEFGIJL ": ["3E","3G","3B","3D","3J","3F","3L","3I"],
 "BDEFGIJK ": ["3E","3G","3B","3D","3J","3F","3I","3K"],
 "BDEFGHKL ": ["3E","3G","3B","3D","3H","3F","3L","3K"],
 "BDEFGHJL ": ["3H","3G","3B","3D","3J","3F","3L","3E"],
 "BDEFGHJK ": ["3H","3G","3B","3D","3J","3F","3E","3K"],
 "BDEFGHIL ": ["3E","3G","3B","3D","3H","3F","3L","3I"],
 "BDEFGHIK ": ["3E","3G","3B","3D","3H","3F","3I","3K"],
 "BDEFGHIJ ": ["3H","3G","3B","3D","3J","3F","3E","3I"],
 "BCGHIJKL ": ["3H","3J","3B","3C","3I","3G","3L","3K"],
 "BCFHIJKL ": ["3H","3J","3B","3C","3I","3F","3L","3K"],
 "BCFGIJKL ": ["3I","3G","3B","3C","3J","3F","3L","3K"],
 "BCFGHJKL ": ["3H","3G","3B","3C","3J","3F","3L","3K"],
 "BCFGHIKL ": ["3H","3G","3B","3C","3I","3F","3L","3K"],
 "BCFGHIJL ": ["3H","3G","3B","3C","3J","3F","3L","3I"],
 "BCFGHIJK ": ["3H","3G","3B","3C","3J","3F","3I","3K"],
 "BCEHIJKL ": ["3E","3J","3B","3C","3I","3H","3L","3K"],
 "BCEGIJKL ": ["3E","3J","3B","3C","3I","3G","3L","3K"],
 "BCEGHJKL ": ["3E","3J","3B","3C","3H","3G","3L","3K"],
 "BCEGHIKL ": ["3E","3G","3B","3C","3I","3H","3L","3K"],
 "BCEGHIJL ": ["3E","3J","3B","3C","3H","3G","3L","3I"],
 "BCEGHIJK ": ["3E","3J","3B","3C","3H","3G","3I","3K"],
 "BCEFIJKL ": ["3E","3J","3B","3C","3I","3F","3L","3K"],
 "BCEFHJKL ": ["3E","3J","3B","3C","3H","3F","3L","3K"],
 "BCEFHIKL ": ["3E","3I","3B","3C","3H","3F","3L","3K"],
 "BCEFHIJL ": ["3E","3J","3B","3C","3H","3F","3L","3I"],
 "BCEFHIJK ": ["3E","3J","3B","3C","3H","3F","3I","3K"],
 "BCEFGJKL ": ["3E","3G","3B","3C","3J","3F","3L","3K"],
 "BCEFGIKL ": ["3E","3G","3B","3C","3I","3F","3L","3K"],
 "BCEFGIJL ": ["3E","3G","3B","3C","3J","3F","3L","3I"],
 "BCEFGIJK ": ["3E","3G","3B","3C","3J","3F","3I","3K"],
 "BCEFGHKL ": ["3E","3G","3B","3C","3H","3F","3L","3K"],
 "BCEFGHJL ": ["3H","3G","3B","3C","3J","3F","3L","3E"],
 "BCEFGHJK ": ["3H","3G","3B","3C","3J","3F","3E","3K"],
 "BCEFGHIL ": ["3E","3G","3B","3C","3H","3F","3L","3I"],
 "BCEFGHIK ": ["3E","3G","3B","3C","3H","3F","3I","3K"],
 "BCEFGHIJ ": ["3H","3G","3B","3C","3J","3F","3E","3I"],
 "BCDHIJKL ": ["3H","3J","3B","3C","3I","3D","3L","3K"],
 "BCDGIJKL ": ["3I","3G","3B","3C","3J","3D","3L","3K"],
 "BCDGHJKL ": ["3H","3G","3B","3C","3J","3D","3L","3K"],
 "BCDGHIKL ": ["3H","3G","3B","3C","3I","3D","3L","3K"],
 "BCDGHIJL ": ["3H","3G","3B","3C","3J","3D","3L","3I"],
 "BCDGHIJK ": ["3H","3G","3B","3C","3J","3D","3I","3K"],
 "BCDFIJKL ": ["3C","3J","3B","3D","3I","3F","3L","3K"],
 "BCDFHJKL ": ["3C","3J","3B","3D","3H","3F","3L","3K"],
 "BCDFHIKL ": ["3C","3I","3B","3D","3H","3F","3L","3K"],
 "BCDFHIJL ": ["3C","3J","3B","3D","3H","3F","3L","3I"],
 "BCDFHIJK ": ["3C","3J","3B","3D","3H","3F","3I","3K"],
 "BCDFGJKL ": ["3C","3G","3B","3D","3J","3F","3L","3K"],
 "BCDFGIKL ": ["3C","3G","3B","3D","3I","3F","3L","3K"],
 "BCDFGIJL ": ["3C","3G","3B","3D","3J","3F","3L","3I"],
 "BCDFGIJK ": ["3C","3G","3B","3D","3J","3F","3I","3K"],
 "BCDFGHKL ": ["3C","3G","3B","3D","3H","3F","3L","3K"],
 "BCDFGHJL ": ["3C","3G","3B","3D","3H","3F","3L","3J"],
 "BCDFGHJK ": ["3H","3G","3B","3C","3J","3F","3D","3K"],
 "BCDFGHIL ": ["3C","3G","3B","3D","3H","3F","3L","3I"],
 "BCDFGHIK ": ["3C","3G","3B","3D","3H","3F","3I","3K"],
 "BCDFGHIJ ": ["3H","3G","3B","3C","3J","3F","3D","3I"],
 "BCDEIJKL ": ["3E","3J","3B","3C","3I","3D","3L","3K"],
 "BCDEHJKL ": ["3E","3J","3B","3C","3H","3D","3L","3K"],
 "BCDEHIKL ": ["3E","3I","3B","3C","3H","3D","3L","3K"],
 "BCDEHIJL ": ["3E","3J","3B","3C","3H","3D","3L","3I"],
 "BCDEHIJK ": ["3E","3J","3B","3C","3H","3D","3I","3K"],
 "BCDEGJKL ": ["3E","3G","3B","3C","3J","3D","3L","3K"],
 "BCDEGIKL ": ["3E","3G","3B","3C","3I","3D","3L","3K"],
 "BCDEGIJL ": ["3E","3G","3B","3C","3J","3D","3L","3I"],
 "BCDEGIJK ": ["3E","3G","3B","3C","3J","3D","3I","3K"],
 "BCDEGHKL ": ["3E","3G","3B","3C","3H","3D","3L","3K"],
 "BCDEGHJL ": ["3H","3G","3B","3C","3J","3D","3L","3E"],
 "BCDEGHJK ": ["3H","3G","3B","3C","3J","3D","3E","3K"],
 "BCDEGHIL ": ["3E","3G","3B","3C","3H","3D","3L","3I"],
 "BCDEGHIK ": ["3E","3G","3B","3C","3H","3D","3I","3K"],
 "BCDEGHIJ ": ["3H","3G","3B","3C","3J","3D","3E","3I"],
 "BCDEFJKL ": ["3C","3J","3B","3D","3E","3F","3L","3K"],
 "BCDEFIKL ": ["3C","3E","3B","3D","3I","3F","3L","3K"],
 "BCDEFIJL ": ["3C","3J","3B","3D","3E","3F","3L","3I"],
 "BCDEFIJK ": ["3C","3J","3B","3D","3E","3F","3I","3K"],
 "BCDEFHKL ": ["3C","3E","3B","3D","3H","3F","3L","3K"],
 "BCDEFHJL ": ["3C","3J","3B","3D","3H","3F","3L","3E"],
 "BCDEFHJK ": ["3C","3J","3B","3D","3H","3F","3E","3K"],
 "BCDEFHIL ": ["3C","3E","3B","3D","3H","3F","3L","3I"],
 "BCDEFHIK ": ["3C","3E","3B","3D","3H","3F","3I","3K"],
 "BCDEFHIJ ": ["3C","3J","3B","3D","3H","3F","3E","3I"],
 "BCDEFGKL ": ["3C","3G","3B","3D","3E","3F","3L","3K"],
 "BCDEFGJL ": ["3C","3G","3B","3D","3J","3F","3L","3E"],
 "BCDEFGJK ": ["3C","3G","3B","3D","3J","3F","3E","3K"],
 "BCDEFGIL ": ["3C","3G","3B","3D","3E","3F","3L","3I"],
 "BCDEFGIK ": ["3C","3G","3B","3D","3E","3F","3I","3K"],
 "BCDEFGIJ ": ["3C","3G","3B","3D","3J","3F","3E","3I"],
 "BCDEFGHL ": ["3C","3G","3B","3D","3H","3F","3L","3E"],
 "BCDEFGHK ": ["3C","3G","3B","3D","3H","3F","3E","3K"],
 "BCDEFGHJ ": ["3H","3G","3B","3C","3J","3F","3D","3E"],
 "BCDEFGHI ": ["3C","3G","3B","3D","3H","3F","3E","3I"],
 "AFGHIJKL ": ["3H","3J","3I","3F","3A","3G","3L","3K"],
 "AEGHIJKL ": ["3E","3J","3I","3A","3H","3G","3L","3K"],
 "AEFHIJKL ": ["3E","3J","3I","3F","3A","3H","3L","3K"],
 "AEFGIJKL ": ["3E","3J","3I","3F","3A","3G","3L","3K"],
 "AEFGHJKL ": ["3E","3G","3J","3F","3A","3H","3L","3K"],
 "AEFGHIKL ": ["3E","3G","3I","3F","3A","3H","3L","3K"],
 "AEFGHIJL ": ["3E","3G","3J","3F","3A","3H","3L","3I"],
 "AEFGHIJK ": ["3E","3G","3J","3F","3A","3H","3I","3K"],
 "ADGHIJKL ": ["3H","3J","3I","3D","3A","3G","3L","3K"],
 "ADFHIJKL ": ["3H","3J","3I","3D","3A","3F","3L","3K"],
 "ADFGIJKL ": ["3I","3G","3J","3D","3A","3F","3L","3K"],
 "ADFGHJKL ": ["3H","3G","3J","3D","3A","3F","3L","3K"],
 "ADFGHIKL ": ["3H","3G","3I","3D","3A","3F","3L","3K"],
 "ADFGHIJL ": ["3H","3G","3J","3D","3A","3F","3L","3I"],
 "ADFGHIJK ": ["3H","3G","3J","3D","3A","3F","3I","3K"],
 "ADEHIJKL ": ["3E","3J","3I","3D","3A","3H","3L","3K"],
 "ADEGIJKL ": ["3E","3J","3I","3D","3A","3G","3L","3K"],
 "ADEGHJKL ": ["3E","3G","3J","3D","3A","3H","3L","3K"],
 "ADEGHIKL ": ["3E","3G","3I","3D","3A","3H","3L","3K"],
 "ADEGHIJL ": ["3E","3G","3J","3D","3A","3H","3L","3I"],
 "ADEGHIJK ": ["3E","3G","3J","3D","3A","3H","3I","3K"],
 "ADEFIJKL ": ["3E","3J","3I","3D","3A","3F","3L","3K"],
 "ADEFHJKL ": ["3H","3J","3E","3D","3A","3F","3L","3K"],
 "ADEFHIKL ": ["3H","3E","3I","3D","3A","3F","3L","3K"],
 "ADEFHIJL ": ["3H","3J","3E","3D","3A","3F","3L","3I"],
 "ADEFHIJK ": ["3H","3J","3E","3D","3A","3F","3I","3K"],
 "ADEFGJKL ": ["3E","3G","3J","3D","3A","3F","3L","3K"],
 "ADEFGIKL ": ["3E","3G","3I","3D","3A","3F","3L","3K"],
 "ADEFGIJL ": ["3E","3G","3J","3D","3A","3F","3L","3I"],
 "ADEFGIJK ": ["3E","3G","3J","3D","3A","3F","3I","3K"],
 "ADEFGHKL ": ["3H","3G","3E","3D","3A","3F","3L","3K"],
 "ADEFGHJL ": ["3H","3G","3J","3D","3A","3F","3L","3E"],
 "ADEFGHJK ": ["3H","3G","3J","3D","3A","3F","3E","3K"],
 "ADEFGHIL ": ["3H","3G","3E","3D","3A","3F","3L","3I"],
 "ADEFGHIK ": ["3H","3G","3E","3D","3A","3F","3I","3K"],
 "ADEFGHIJ ": ["3H","3G","3J","3D","3A","3F","3E","3I"],
 "ACGHIJKL ": ["3H","3J","3I","3C","3A","3G","3L","3K"],
 "ACFHIJKL ": ["3H","3J","3I","3C","3A","3F","3L","3K"],
 "ACFGIJKL ": ["3I","3G","3J","3C","3A","3F","3L","3K"],
 "ACFGHJKL ": ["3H","3G","3J","3C","3A","3F","3L","3K"],
 "ACFGHIKL ": ["3H","3G","3I","3C","3A","3F","3L","3K"],
 "ACFGHIJL ": ["3H","3G","3J","3C","3A","3F","3L","3I"],
 "ACFGHIJK ": ["3H","3G","3J","3C","3A","3F","3I","3K"],
 "ACEHIJKL ": ["3E","3J","3I","3C","3A","3H","3L","3K"],
 "ACEGIJKL ": ["3E","3J","3I","3C","3A","3G","3L","3K"],
 "ACEGHJKL ": ["3E","3G","3J","3C","3A","3H","3L","3K"],
 "ACEGHIKL ": ["3E","3G","3I","3C","3A","3H","3L","3K"],
 "ACEGHIJL ": ["3E","3G","3J","3C","3A","3H","3L","3I"],
 "ACEGHIJK ": ["3E","3G","3J","3C","3A","3H","3I","3K"],
 "ACEFIJKL ": ["3E","3J","3I","3C","3A","3F","3L","3K"],
 "ACEFHJKL ": ["3H","3J","3E","3C","3A","3F","3L","3K"],
 "ACEFHIKL ": ["3H","3E","3I","3C","3A","3F","3L","3K"],
 "ACEFHIJL ": ["3H","3J","3E","3C","3A","3F","3L","3I"],
 "ACEFHIJK ": ["3H","3J","3E","3C","3A","3F","3I","3K"],
 "ACEFGJKL ": ["3E","3G","3J","3C","3A","3F","3L","3K"],
 "ACEFGIKL ": ["3E","3G","3I","3C","3A","3F","3L","3K"],
 "ACEFGIJL ": ["3E","3G","3J","3C","3A","3F","3L","3I"],
 "ACEFGIJK ": ["3E","3G","3J","3C","3A","3F","3I","3K"],
 "ACEFGHKL ": ["3H","3G","3E","3C","3A","3F","3L","3K"],
 "ACEFGHJL ": ["3H","3G","3J","3C","3A","3F","3L","3E"],
 "ACEFGHJK ": ["3H","3G","3J","3C","3A","3F","3E","3K"],
 "ACEFGHIL ": ["3H","3G","3E","3C","3A","3F","3L","3I"],
 "ACEFGHIK ": ["3H","3G","3E","3C","3A","3F","3I","3K"],
 "ACEFGHIJ ": ["3H","3G","3J","3C","3A","3F","3E","3I"],
 "ACDHIJKL ": ["3H","3J","3I","3C","3A","3D","3L","3K"],
 "ACDGIJKL ": ["3I","3G","3J","3C","3A","3D","3L","3K"],
 "ACDGHJKL ": ["3H","3G","3J","3C","3A","3D","3L","3K"],
 "ACDGHIKL ": ["3H","3G","3I","3C","3A","3D","3L","3K"],
 "ACDGHIJL ": ["3H","3G","3J","3C","3A","3D","3L","3I"],
 "ACDGHIJK ": ["3H","3G","3J","3C","3A","3D","3I","3K"],
 "ACDFIJKL ": ["3C","3J","3I","3D","3A","3F","3L","3K"],
 "ACDFHJKL ": ["3H","3J","3F","3C","3A","3D","3L","3K"],
 "ACDFHIKL ": ["3H","3F","3I","3C","3A","3D","3L","3K"],
 "ACDFHIJL ": ["3H","3J","3F","3C","3A","3D","3L","3I"],
 "ACDFHIJK ": ["3H","3J","3F","3C","3A","3D","3I","3K"],
 "ACDFGJKL ": ["3C","3G","3J","3D","3A","3F","3L","3K"],
 "ACDFGIKL ": ["3C","3G","3I","3D","3A","3F","3L","3K"],
 "ACDFGIJL ": ["3C","3G","3J","3D","3A","3F","3L","3I"],
 "ACDFGIJK ": ["3C","3G","3J","3D","3A","3F","3I","3K"],
 "ACDFGHKL ": ["3H","3G","3F","3C","3A","3D","3L","3K"],
 "ACDFGHJL ": ["3C","3G","3J","3D","3A","3F","3L","3H"],
 "ACDFGHJK ": ["3H","3G","3J","3C","3A","3F","3D","3K"],
 "ACDFGHIL ": ["3H","3G","3F","3C","3A","3D","3L","3I"],
 "ACDFGHIK ": ["3H","3G","3F","3C","3A","3D","3I","3K"],
 "ACDFGHIJ ": ["3H","3G","3J","3C","3A","3F","3D","3I"],
 "ACDEIJKL ": ["3E","3J","3I","3C","3A","3D","3L","3K"],
 "ACDEHJKL ": ["3H","3J","3E","3C","3A","3D","3L","3K"],
 "ACDEHIKL ": ["3H","3E","3I","3C","3A","3D","3L","3K"],
 "ACDEHIJL ": ["3H","3J","3E","3C","3A","3D","3L","3I"],
 "ACDEHIJK ": ["3H","3J","3E","3C","3A","3D","3I","3K"],
 "ACDEGJKL ": ["3E","3G","3J","3C","3A","3D","3L","3K"],
 "ACDEGIKL ": ["3E","3G","3I","3C","3A","3D","3L","3K"],
 "ACDEGIJL ": ["3E","3G","3J","3C","3A","3D","3L","3I"],
 "ACDEGIJK ": ["3E","3G","3J","3C","3A","3D","3I","3K"],
 "ACDEGHKL ": ["3H","3G","3E","3C","3A","3D","3L","3K"],
 "ACDEGHJL ": ["3H","3G","3J","3C","3A","3D","3L","3E"],
 "ACDEGHJK ": ["3H","3G","3J","3C","3A","3D","3E","3K"],
 "ACDEGHIL ": ["3H","3G","3E","3C","3A","3D","3L","3I"],
 "ACDEGHIK ": ["3H","3G","3E","3C","3A","3D","3I","3K"],
 "ACDEGHIJ ": ["3H","3G","3J","3C","3A","3D","3E","3I"],
 "ACDEFJKL ": ["3C","3J","3E","3D","3A","3F","3L","3K"],
 "ACDEFIKL ": ["3C","3E","3I","3D","3A","3F","3L","3K"],
 "ACDEFIJL ": ["3C","3J","3E","3D","3A","3F","3L","3I"],
 "ACDEFIJK ": ["3C","3J","3E","3D","3A","3F","3I","3K"],
 "ACDEFHKL ": ["3H","3E","3F","3C","3A","3D","3L","3K"],
 "ACDEFHJL ": ["3H","3J","3F","3C","3A","3D","3L","3E"],
 "ACDEFHJK ": ["3H","3J","3E","3C","3A","3F","3D","3K"],
 "ACDEFHIL ": ["3H","3E","3F","3C","3A","3D","3L","3I"],
 "ACDEFHIK ": ["3H","3E","3F","3C","3A","3D","3I","3K"],
 "ACDEFHIJ ": ["3H","3J","3E","3C","3A","3F","3D","3I"],
 "ACDEFGKL ": ["3C","3G","3E","3D","3A","3F","3L","3K"],
 "ACDEFGJL ": ["3C","3G","3J","3D","3A","3F","3L","3E"],
 "ACDEFGJK ": ["3C","3G","3J","3D","3A","3F","3E","3K"],
 "ACDEFGIL ": ["3C","3G","3E","3D","3A","3F","3L","3I"],
 "ACDEFGIK ": ["3C","3G","3E","3D","3A","3F","3I","3K"],
 "ACDEFGIJ ": ["3C","3G","3J","3D","3A","3F","3E","3I"],
 "ACDEFGHL ": ["3H","3G","3F","3C","3A","3D","3L","3E"],
 "ACDEFGHK ": ["3H","3G","3E","3C","3A","3F","3D","3K"],
 "ACDEFGHJ ": ["3H","3G","3J","3C","3A","3F","3D","3E"],
 "ACDEFGHI ": ["3H","3G","3E","3C","3A","3F","3D","3I"],
 "ABGHIJKL ": ["3H","3J","3B","3A","3I","3G","3L","3K"],
 "ABFHIJKL ": ["3H","3J","3B","3A","3I","3F","3L","3K"],
 "ABFGIJKL ": ["3I","3J","3B","3F","3A","3G","3L","3K"],
 "ABFGHJKL ": ["3H","3J","3B","3F","3A","3G","3L","3K"],
 "ABFGHIKL ": ["3H","3G","3B","3A","3I","3F","3L","3K"],
 "ABFGHIJL ": ["3H","3J","3B","3F","3A","3G","3L","3I"],
 "ABFGHIJK ": ["3H","3J","3B","3F","3A","3G","3I","3K"],
 "ABEHIJKL ": ["3E","3J","3B","3A","3I","3H","3L","3K"],
 "ABEGIJKL ": ["3E","3J","3B","3A","3I","3G","3L","3K"],
 "ABEGHJKL ": ["3E","3J","3B","3A","3H","3G","3L","3K"],
 "ABEGHIKL ": ["3E","3G","3B","3A","3I","3H","3L","3K"],
 "ABEGHIJL ": ["3E","3J","3B","3A","3H","3G","3L","3I"],
 "ABEGHIJK ": ["3E","3J","3B","3A","3H","3G","3I","3K"],
 "ABEFIJKL ": ["3E","3J","3B","3A","3I","3F","3L","3K"],
 "ABEFHJKL ": ["3E","3J","3B","3F","3A","3H","3L","3K"],
 "ABEFHIKL ": ["3E","3I","3B","3F","3A","3H","3L","3K"],
 "ABEFHIJL ": ["3E","3J","3B","3F","3A","3H","3L","3I"],
 "ABEFHIJK ": ["3E","3J","3B","3F","3A","3H","3I","3K"],
 "ABEFGJKL ": ["3E","3J","3B","3F","3A","3G","3L","3K"],
 "ABEFGIKL ": ["3E","3G","3B","3A","3I","3F","3L","3K"],
 "ABEFGIJL ": ["3E","3J","3B","3F","3A","3G","3L","3I"],
 "ABEFGIJK ": ["3E","3J","3B","3F","3A","3G","3I","3K"],
 "ABEFGHKL ": ["3E","3G","3B","3F","3A","3H","3L","3K"],
 "ABEFGHJL ": ["3H","3J","3B","3F","3A","3G","3L","3E"],
 "ABEFGHJK ": ["3H","3J","3B","3F","3A","3G","3E","3K"],
 "ABEFGHIL ": ["3E","3G","3B","3F","3A","3H","3L","3I"],
 "ABEFGHIK ": ["3E","3G","3B","3F","3A","3H","3I","3K"],
 "ABEFGHIJ ": ["3H","3J","3B","3F","3A","3G","3E","3I"],
 "ABDHIJKL ": ["3I","3J","3B","3D","3A","3H","3L","3K"],
 "ABDGIJKL ": ["3I","3J","3B","3D","3A","3G","3L","3K"],
 "ABDGHJKL ": ["3H","3J","3B","3D","3A","3G","3L","3K"],
 "ABDGHIKL ": ["3I","3G","3B","3D","3A","3H","3L","3K"],
 "ABDGHIJL ": ["3H","3J","3B","3D","3A","3G","3L","3I"],
 "ABDGHIJK ": ["3H","3J","3B","3D","3A","3G","3I","3K"],
 "ABDFIJKL ": ["3I","3J","3B","3D","3A","3F","3L","3K"],
 "ABDFHJKL ": ["3H","3J","3B","3D","3A","3F","3L","3K"],
 "ABDFHIKL ": ["3H","3I","3B","3D","3A","3F","3L","3K"],
 "ABDFHIJL ": ["3H","3J","3B","3D","3A","3F","3L","3I"],
 "ABDFHIJK ": ["3H","3J","3B","3D","3A","3F","3I","3K"],
 "ABDFGJKL ": ["3F","3J","3B","3D","3A","3G","3L","3K"],
 "ABDFGIKL ": ["3I","3G","3B","3D","3A","3F","3L","3K"],
 "ABDFGIJL ": ["3F","3J","3B","3D","3A","3G","3L","3I"],
 "ABDFGIJK ": ["3F","3J","3B","3D","3A","3G","3I","3K"],
 "ABDFGHKL ": ["3H","3G","3B","3D","3A","3F","3L","3K"],
 "ABDFGHJL ": ["3H","3G","3B","3D","3A","3F","3L","3J"],
 "ABDFGHJK ": ["3H","3G","3B","3D","3A","3F","3J","3K"],
 "ABDFGHIL ": ["3H","3G","3B","3D","3A","3F","3L","3I"],
 "ABDFGHIK ": ["3H","3G","3B","3D","3A","3F","3I","3K"],
 "ABDFGHIJ ": ["3H","3G","3B","3D","3A","3F","3I","3J"],
 "ABDEIJKL ": ["3E","3J","3B","3A","3I","3D","3L","3K"],
 "ABDEHJKL ": ["3E","3J","3B","3D","3A","3H","3L","3K"],
 "ABDEHIKL ": ["3E","3I","3B","3D","3A","3H","3L","3K"],
 "ABDEHIJL ": ["3E","3J","3B","3D","3A","3H","3L","3I"],
 "ABDEHIJK ": ["3E","3J","3B","3D","3A","3H","3I","3K"],
 "ABDEGJKL ": ["3E","3J","3B","3D","3A","3G","3L","3K"],
 "ABDEGIKL ": ["3E","3G","3B","3A","3I","3D","3L","3K"],
 "ABDEGIJL ": ["3E","3J","3B","3D","3A","3G","3L","3I"],
 "ABDEGIJK ": ["3E","3J","3B","3D","3A","3G","3I","3K"],
 "ABDEGHKL ": ["3E","3G","3B","3D","3A","3H","3L","3K"],
 "ABDEGHJL ": ["3H","3J","3B","3D","3A","3G","3L","3E"],
 "ABDEGHJK ": ["3H","3J","3B","3D","3A","3G","3E","3K"],
 "ABDEGHIL ": ["3E","3G","3B","3D","3A","3H","3L","3I"],
 "ABDEGHIK ": ["3E","3G","3B","3D","3A","3H","3I","3K"],
 "ABDEGHIJ ": ["3H","3J","3B","3D","3A","3G","3E","3I"],
 "ABDEFJKL ": ["3E","3J","3B","3D","3A","3F","3L","3K"],
 "ABDEFIKL ": ["3E","3I","3B","3D","3A","3F","3L","3K"],
 "ABDEFIJL ": ["3E","3J","3B","3D","3A","3F","3L","3I"],
 "ABDEFIJK ": ["3E","3J","3B","3D","3A","3F","3I","3K"],
 "ABDEFHKL ": ["3H","3E","3B","3D","3A","3F","3L","3K"],
 "ABDEFHJL ": ["3H","3J","3B","3D","3A","3F","3L","3E"],
 "ABDEFHJK ": ["3H","3J","3B","3D","3A","3F","3E","3K"],
 "ABDEFHIL ": ["3H","3E","3B","3D","3A","3F","3L","3I"],
 "ABDEFHIK ": ["3H","3E","3B","3D","3A","3F","3I","3K"],
 "ABDEFHIJ ": ["3H","3J","3B","3D","3A","3F","3E","3I"],
 "ABDEFGKL ": ["3E","3G","3B","3D","3A","3F","3L","3K"],
 "ABDEFGJL ": ["3E","3G","3B","3D","3A","3F","3L","3J"],
 "ABDEFGJK ": ["3E","3G","3B","3D","3A","3F","3J","3K"],
 "ABDEFGIL ": ["3E","3G","3B","3D","3A","3F","3L","3I"],
 "ABDEFGIK ": ["3E","3G","3B","3D","3A","3F","3I","3K"],
 "ABDEFGIJ ": ["3E","3G","3B","3D","3A","3F","3I","3J"],
 "ABDEFGHL ": ["3H","3G","3B","3D","3A","3F","3L","3E"],
 "ABDEFGHK ": ["3H","3G","3B","3D","3A","3F","3E","3K"],
 "ABDEFGHJ ": ["3H","3G","3B","3D","3A","3F","3E","3J"],
 "ABDEFGHI ": ["3H","3G","3B","3D","3A","3F","3E","3I"],
 "ABCHIJKL ": ["3I","3J","3B","3C","3A","3H","3L","3K"],
 "ABCGIJKL ": ["3I","3J","3B","3C","3A","3G","3L","3K"],
 "ABCGHJKL ": ["3H","3J","3B","3C","3A","3G","3L","3K"],
 "ABCGHIKL ": ["3I","3G","3B","3C","3A","3H","3L","3K"],
 "ABCGHIJL ": ["3H","3J","3B","3C","3A","3G","3L","3I"],
 "ABCGHIJK ": ["3H","3J","3B","3C","3A","3G","3I","3K"],
 "ABCFIJKL ": ["3I","3J","3B","3C","3A","3F","3L","3K"],
 "ABCFHJKL ": ["3H","3J","3B","3C","3A","3F","3L","3K"],
 "ABCFHIKL ": ["3H","3I","3B","3C","3A","3F","3L","3K"],
 "ABCFHIJL ": ["3H","3J","3B","3C","3A","3F","3L","3I"],
 "ABCFHIJK ": ["3H","3J","3B","3C","3A","3F","3I","3K"],
 "ABCFGJKL ": ["3C","3J","3B","3F","3A","3G","3L","3K"],
 "ABCFGIKL ": ["3I","3G","3B","3C","3A","3F","3L","3K"],
 "ABCFGIJL ": ["3C","3J","3B","3F","3A","3G","3L","3I"],
 "ABCFGIJK ": ["3C","3J","3B","3F","3A","3G","3I","3K"],
 "ABCFGHKL ": ["3H","3G","3B","3C","3A","3F","3L","3K"],
 "ABCFGHJL ": ["3H","3G","3B","3C","3A","3F","3L","3J"],
 "ABCFGHJK ": ["3H","3G","3B","3C","3A","3F","3J","3K"],
 "ABCFGHIL ": ["3H","3G","3B","3C","3A","3F","3L","3I"],
 "ABCFGHIK ": ["3H","3G","3B","3C","3A","3F","3I","3K"],
 "ABCFGHIJ ": ["3H","3G","3B","3C","3A","3F","3I","3J"],
 "ABCEIJKL ": ["3E","3J","3B","3A","3I","3C","3L","3K"],
 "ABCEHJKL ": ["3E","3J","3B","3C","3A","3H","3L","3K"],
 "ABCEHIKL ": ["3E","3I","3B","3C","3A","3H","3L","3K"],
 "ABCEHIJL ": ["3E","3J","3B","3C","3A","3H","3L","3I"],
 "ABCEHIJK ": ["3E","3J","3B","3C","3A","3H","3I","3K"],
 "ABCEGJKL ": ["3E","3J","3B","3C","3A","3G","3L","3K"],
 "ABCEGIKL ": ["3E","3G","3B","3A","3I","3C","3L","3K"],
 "ABCEGIJL ": ["3E","3J","3B","3C","3A","3G","3L","3I"],
 "ABCEGIJK ": ["3E","3J","3B","3C","3A","3G","3I","3K"],
 "ABCEGHKL ": ["3E","3G","3B","3C","3A","3H","3L","3K"],
 "ABCEGHJL ": ["3H","3J","3B","3C","3A","3G","3L","3E"],
 "ABCEGHJK ": ["3H","3J","3B","3C","3A","3G","3E","3K"],
 "ABCEGHIL ": ["3E","3G","3B","3C","3A","3H","3L","3I"],
 "ABCEGHIK ": ["3E","3G","3B","3C","3A","3H","3I","3K"],
 "ABCEGHIJ ": ["3H","3J","3B","3C","3A","3G","3E","3I"],
 "ABCEFJKL ": ["3E","3J","3B","3C","3A","3F","3L","3K"],
 "ABCEFIKL ": ["3E","3I","3B","3C","3A","3F","3L","3K"],
 "ABCEFIJL ": ["3E","3J","3B","3C","3A","3F","3L","3I"],
 "ABCEFIJK ": ["3E","3J","3B","3C","3A","3F","3I","3K"],
 "ABCEFHKL ": ["3H","3E","3B","3C","3A","3F","3L","3K"],
 "ABCEFHJL ": ["3H","3J","3B","3C","3A","3F","3L","3E"],
 "ABCEFHJK ": ["3H","3J","3B","3C","3A","3F","3E","3K"],
 "ABCEFHIL ": ["3H","3E","3B","3C","3A","3F","3L","3I"],
 "ABCEFHIK ": ["3H","3E","3B","3C","3A","3F","3I","3K"],
 "ABCEFHIJ ": ["3H","3J","3B","3C","3A","3F","3E","3I"],
 "ABCEFGKL ": ["3E","3G","3B","3C","3A","3F","3L","3K"],
 "ABCEFGJL ": ["3E","3G","3B","3C","3A","3F","3L","3J"],
 "ABCEFGJK ": ["3E","3G","3B","3C","3A","3F","3J","3K"],
 "ABCEFGIL ": ["3E","3G","3B","3C","3A","3F","3L","3I"],
 "ABCEFGIK ": ["3E","3G","3B","3C","3A","3F","3I","3K"],
 "ABCEFGIJ ": ["3E","3G","3B","3C","3A","3F","3I","3J"],
 "ABCEFGHL ": ["3H","3G","3B","3C","3A","3F","3L","3E"],
 "ABCEFGHK ": ["3H","3G","3B","3C","3A","3F","3E","3K"],
 "ABCEFGHJ ": ["3H","3G","3B","3C","3A","3F","3E","3J"],
 "ABCEFGHI ": ["3H","3G","3B","3C","3A","3F","3E","3I"],
 "ABCDIJKL ": ["3I","3J","3B","3C","3A","3D","3L","3K"],
 "ABCDHJKL ": ["3H","3J","3B","3C","3A","3D","3L","3K"],
 "ABCDHIKL ": ["3H","3I","3B","3C","3A","3D","3L","3K"],
 "ABCDHIJL ": ["3H","3J","3B","3C","3A","3D","3L","3I"],
 "ABCDHIJK ": ["3H","3J","3B","3C","3A","3D","3I","3K"],
 "ABCDGJKL ": ["3C","3J","3B","3D","3A","3G","3L","3K"],
 "ABCDGIKL ": ["3I","3G","3B","3C","3A","3D","3L","3K"],
 "ABCDGIJL ": ["3C","3J","3B","3D","3A","3G","3L","3I"],
 "ABCDGIJK ": ["3C","3J","3B","3D","3A","3G","3I","3K"],
 "ABCDGHKL ": ["3H","3G","3B","3C","3A","3D","3L","3K"],
 "ABCDGHJL ": ["3H","3G","3B","3C","3A","3D","3L","3J"],
 "ABCDGHJK ": ["3H","3G","3B","3C","3A","3D","3J","3K"],
 "ABCDGHIL ": ["3H","3G","3B","3C","3A","3D","3L","3I"],
 "ABCDGHIK ": ["3H","3G","3B","3C","3A","3D","3I","3K"],
 "ABCDGHIJ ": ["3H","3G","3B","3C","3A","3D","3I","3J"],
 "ABCDFJKL ": ["3C","3J","3B","3D","3A","3F","3L","3K"],
 "ABCDFIKL ": ["3C","3I","3B","3D","3A","3F","3L","3K"],
 "ABCDFIJL ": ["3C","3J","3B","3D","3A","3F","3L","3I"],
 "ABCDFIJK": ["3C","3J","3B","3D","3A","3F","3I","3K"],
 "ABCDFHKL": ["3H","3F","3B","3C","3A","3D","3L","3K"],
 "ABCDFHJL": ["3C","3J","3B","3D","3A","3F","3L","3H"],
 "ABCDFHJK": ["3H","3J","3B","3C","3A","3F","3D","3K"],
 "ABCDFHIL": ["3H","3F","3B","3C","3A","3D","3L","3I"],
 "ABCDFHIK": ["3H","3F","3B","3C","3A","3D","3I","3K"],
 "ABCDFHIJ": ["3H","3J","3B","3C","3A","3F","3D","3I"],
 "ABCDFGKL": ["3C","3G","3B","3D","3A","3F","3L","3K"],
 "ABCDFGJL": ["3C","3G","3B","3D","3A","3F","3L","3J"],
 "ABCDFGJK": ["3C","3G","3B","3D","3A","3F","3J","3K"],
 "ABCDFGIL": ["3C","3G","3B","3D","3A","3F","3L","3I"],
 "ABCDFGIK": ["3C","3G","3B","3D","3A","3F","3I","3K"],
 "ABCDFGIJ": ["3C","3G","3B","3D","3A","3F","3I","3J"],
 "ABCDFGHL": ["3C","3G","3B","3D","3A","3F","3L","3H"],
 "ABCDFGHK": ["3H","3G","3B","3C","3A","3F","3D","3K"],
 "ABCDFGHJ": ["3H","3G","3B","3C","3A","3F","3D","3J"],
 "ABCDFGHI": ["3H","3G","3B","3C","3A","3F","3D","3I"],
 "ABCDEJKL": ["3E","3J","3B","3C","3A","3D","3L","3K"],
 "ABCDEIKL": ["3E","3I","3B","3C","3A","3D","3L","3K"],
 "ABCDEIJL": ["3E","3J","3B","3C","3A","3D","3L","3I"],
 "ABCDEIJK": ["3E","3J","3B","3C","3A","3D","3I","3K"],
 "ABCDEHKL": ["3H","3E","3B","3C","3A","3D","3L","3K"],
 "ABCDEHJL": ["3H","3J","3B","3C","3A","3D","3L","3E"],
 "ABCDEHJK": ["3H","3J","3B","3C","3A","3D","3E","3K"],
 "ABCDEHIL": ["3H","3E","3B","3C","3A","3D","3L","3I"],
 "ABCDEHIK": ["3H","3E","3B","3C","3A","3D","3I","3K"],
 "ABCDEHIJ": ["3H","3J","3B","3C","3A","3D","3E","3I"],
 "ABCDEGKL": ["3E","3G","3B","3C","3A","3D","3L","3K"],
 "ABCDEGJL": ["3E","3G","3B","3C","3A","3D","3L","3J"],
 "ABCDEGJK": ["3E","3G","3B","3C","3A","3D","3J","3K"],
 "ABCDEGIL": ["3E","3G","3B","3C","3A","3D","3L","3I"],
 "ABCDEGIK": ["3E","3G","3B","3C","3A","3D","3I","3K"],
 "ABCDEGIJ": ["3E","3G","3B","3C","3A","3D","3I","3J"],
 "ABCDEGHL": ["3H","3G","3B","3C","3A","3D","3L","3E"],
 "ABCDEGHK": ["3H","3G","3B","3C","3A","3D","3E","3K"],
 "ABCDEGHJ": ["3H","3G","3B","3C","3A","3D","3E","3J"],
 "ABCDEGHI": ["3H","3G","3B","3C","3A","3D","3E","3I"],
 "ABCDEFKL": ["3C","3E","3B","3D","3A","3F","3L","3K"],
 "ABCDEFJL": ["3C","3J","3B","3D","3A","3F","3L","3E"],
 "ABCDEFJK": ["3C","3J","3B","3D","3A","3F","3E","3K"],
 "ABCDEFIL": ["3C","3E","3B","3D","3A","3F","3L","3I"],
 "ABCDEFIK": ["3C","3E","3B","3D","3A","3F","3I","3K"],
 "ABCDEFIJ": ["3C","3J","3B","3D","3A","3F","3E","3I"],
 "ABCDEFHL": ["3H","3F","3B","3C","3A","3D","3L","3E"],
 "ABCDEFHK": ["3H","3E","3B","3C","3A","3F","3D","3K"],
 "ABCDEFHJ": ["3H","3J","3B","3C","3A","3F","3D","3E"],
 "ABCDEFHI": ["3H","3E","3B","3C","3A","3F","3D","3I"],
 "ABCDEFGL": ["3C","3G","3B","3D","3A","3F","3L","3E"],
 "ABCDEFGK": ["3C","3G","3B","3D","3A","3F","3E","3K"],
 "ABCDEFGJ": ["3C","3G","3B","3D","3A","3F","3E","3J"],
 "ABCDEFGI": ["3C","3G","3B","3D","3A","3F","3E","3I"],
 "ABCDEFGH": ["3H","3G","3B","3C","3A","3F","3D","3E"]
    };

    const THIRD_TABLE = Object.fromEntries(
      Object.entries(THIRD_TABLE_RAW).map(([key, arr]) => {
        const cleanKey = String(key).trim();
        const matchMap = {};
        THIRD_MATCH_ID_ORDER.forEach((mid, i) => {
          matchMap[mid] = arr[i];
        });
        return [cleanKey, matchMap];
      })
    );

    /* ==============================
       9) Third-place derived data
    ============================== */
    function getThirdTeamForGroup(g){
      const arr = state.groups[g] ?? [];
      const t = arr[2];
      return t && !t.isPlaceholder ? t : null;
    }

    function syncThirdRankingNames(){
      let arr = Array.isArray(state.thirdRanking) ? state.thirdRanking.slice() : [];
      const byGroup = new Map(arr.map(x => [x.groupKey, x]));

      GROUP_KEYS.forEach(g => {
        if(!byGroup.has(g)){
          const obj = {
            id: toId(`third-${g}`),
            groupKey: g,
            name: fallbackPathNameForGroup(g),
            userMoved: false
          };
          arr.push(obj);
          byGroup.set(g, obj);
        }
      });

      arr = arr.filter(x => GROUP_KEYS.includes(x.groupKey));

      arr.forEach(item => {
        const third = getThirdTeamForGroup(item.groupKey);
        const newName = third ? third.name : fallbackPathNameForGroup(item.groupKey);

        // ✅ Fix you asked for:
        // New team replacing old one shouldn't inherit moved
        if(item.name !== newName){
          item.userMoved = false;
        }

        item.name = newName;
      });

      state.thirdRanking = arr;
    }

    function computeChampions(){
      return GROUP_KEYS.map(g => {
        const t = state.groups[g]?.[0];
        const name = (!t || t.isPlaceholder) ? fallbackPathNameForGroup(g) : t.name;
        return { id: toId(`champ-${g}-${name}`), name, groupKey: g };
      });
    }

    function computeRunners(){
      return GROUP_KEYS.map(g => {
        const t = state.groups[g]?.[1];
        const name = (!t || t.isPlaceholder) ? fallbackPathNameForGroup(g) : t.name;
        return { id: toId(`runner-${g}-${name}`), name, groupKey: g };
      });
    }

    function computeTop8ThirdPlaced(){
      syncThirdRankingNames();

      const top8Source = state.thirdRanking.slice(0, 8);

      qualifiedThirdPlacedTeams = top8Source.map(x => ({ groupKey: x.groupKey, name: x.name }));

      qualifiedThirdGroupLetters = top8Source
        .map(x => x.groupKey)
        .sort((a,b) => a.localeCompare(b))
        .join("");

      const top8 = top8Source.map((x, i) => ({
        id: toId(`top8-third-${i}-${x.groupKey}-${x.name}`),
        name: x.name,
        groupKey: x.groupKey
      }));

      top8.sort((a, b) => a.groupKey.localeCompare(b.groupKey));
      return top8;
    }

    function thirdPlaceholderName(setSpec){
      return setSpec
        .split("/")
        .map(s => s.trim())
        .filter(Boolean)
        .map(g => `3${g}`)
        .join("/");
    }

    function parseAllowedThird(spec){
      return spec.split("/").map(s => s.trim()).filter(Boolean);
    }

    /* ==============================
       10) Build R32 third snapshot
    ============================== */
    function buildR32ThirdSnapshot(){
      computeTop8ThirdPlaced();
      const letters = qualifiedThirdGroupLetters;

      const tableRow = THIRD_TABLE[letters];

      const assignment = {};

      if(tableRow){
        THIRD_MATCH_ID_ORDER.forEach(mid => {
          const tag = tableRow[mid];
          const g = tag.replace("3","");
          const found = state.thirdRanking.find(x => x.groupKey === g);
          assignment[mid] = {
            groupKey: g,
            name: found ? found.name : tag,
            source: "table"
          };
        });
      } else {
        const rankedTop8 = state.thirdRanking.slice(0,8);
        const used = new Set();

        function pickAllowedUnique(allowed){
          const cand1 = rankedTop8.find(x => allowed.includes(x.groupKey) && !used.has(x.groupKey));
          if(cand1) return cand1;
          const cand2 = rankedTop8.find(x => !used.has(x.groupKey));
          return cand2 || null;
        }

        const thirdMatches = R32_MATCHES.filter(m =>
          m.left.type === "3SET" || m.right.type === "3SET"
        );

        thirdMatches.forEach(m => {
          const slot = (m.left.type === "3SET") ? m.left : m.right;
          const allowed = parseAllowedThird(slot.set);
          const pick = pickAllowedUnique(allowed);

          if(pick){
            used.add(pick.groupKey);
            assignment[m.id] = {
              groupKey: pick.groupKey,
              name: pick.name,
              source: "greedy"
            };
          } else {
            assignment[m.id] = {
              groupKey: "?",
              name: "3rd TBD",
              source: "greedy"
            };
          }
        });
      }

      state.r32ThirdSnapshot = { letters, top8: qualifiedThirdPlacedTeams.slice(), assignment };
    }

    /* ==============================
       11) KO slot resolution
    ============================== */
    function getGroupPosTeam(g, idx){
      const t = state.groups[g]?.[idx];
      if(!t || t.isPlaceholder) return { name: fallbackPathNameForGroup(g), groupKey: g };
      return { name: t.name, groupKey: g };
    }

    function teamAbbrev(name){
      if(!name) return "---";
      const SPECIAL = {
        "United States": "USA",
        "United States of America": "USA",
        "South Korea": "KOR",
        "North Macedonia": "MKD",
        "Republic of Ireland": "IRL",
        "Czech Republic": "CZE",
        "Bosnia and Herzegovina": "BIH",
        "New Zealand": "NZL",
        "Cape Verde": "CPV",
        "Cabo Verde": "CPV",
        "Ivory Coast": "CIV",
        "Côte d'Ivoire":"CIV",
        "DR Congo": "COD",
        "Northern Ireland": "NIR"
      };
      if(SPECIAL[name]) return SPECIAL[name];

      if(name.startsWith("UEFA Path")) return "UEF";
      if(name.startsWith("FIFA IC Path")) return "FIC";

      const words = name.replace(/[().]/g,"").split(/\s+/).filter(Boolean);
      if(words.length >= 2){
        const init = words.map(w => w[0]).join("").toUpperCase();
        return init.slice(0,3).padEnd(3, init[0] ?? "X");
      }
      const s = words[0].toUpperCase();
      if(s.length <= 3) return s;
      return s.slice(0,3);
    }

    function resolveSlot(slot, matchId){
      if(slot.type === "W"){
        const t = getGroupPosTeam(slot.g, 0);
        return { name: t.name, label: `1${slot.g}`, placeholder:false };
      }
      if(slot.type === "RU"){
        const t = getGroupPosTeam(slot.g, 1);
        return { name: t.name, label: `2${slot.g}`, placeholder:false };
      }
      if(slot.type === "3SET"){
        if(!state.r32Generated){
          const ph = thirdPlaceholderName(slot.set);
          return { name: ph, label: ph, placeholder:true, source:"placeholder" };
        }

        const snap = state.r32ThirdSnapshot;
        const assign = snap?.assignment?.[matchId];

        if(assign){
          return {
            name: assign.name,
            label: `3${assign.groupKey}`,
            placeholder:false,
            source: assign.source
          };
        }

        return { name:"3rd TBD", label:"3?", placeholder:true, source:"fallback" };
      }
      if(slot.type === "WM"){
        const w = state.winners[slot.id];
        if(!w) return { name:`Winner ${slot.id}`, label:`W${slot.id}`, placeholder:true };
        return { name:w.name, label:`W${slot.id}`, placeholder:false };
      }
      if(slot.type === "LM"){
        const w = state.winners[slot.id];
        if(!w) return { name:`Loser ${slot.id}`, label:`L${slot.id}`, placeholder:true };

        const prev = findMatchById(slot.id);
        if(!prev) return { name:`Loser ${slot.id}`, label:`L${slot.id}`, placeholder:true };

        const p = resolveParticipants(prev);
        const loserName = (p.left.name === w.name) ? p.right.name : p.left.name;

        if(!loserName || p.left.placeholder || p.right.placeholder){
          return { name:`Loser ${slot.id}`, label:`L${slot.id}`, placeholder:true };
        }

        return { name: loserName, label:`L${slot.id}`, placeholder:false };
      }

      return { name:"TBD", label:"---", placeholder:true };
    }

    function findMatchById(id){
      for(const k of Object.keys(ALL_ROUNDS)){
        const m = ALL_ROUNDS[k].find(x => x.id === id);
        if(m) return m;
      }
      return null;
    }

    function getAllMatchesFlat(){
      return [
        ...R32_MATCHES,
        ...R16_MATCHES,
        ...QF_MATCHES,
        ...SF_MATCHES,
        ...THIRD_MATCH,
        ...FINAL_MATCH
      ];
    }

    function getR32ThirdDependentMatchIds(){
      return R32_MATCHES
        .filter(m => m.left.type === "3SET" || m.right.type === "3SET")
        .map(m => m.id);
    }

    function buildDependencyGraph(){
      const graph = new Map();
      const all = getAllMatchesFlat();
      all.forEach(m => {
        [m.left, m.right].forEach(slot => {
          if(slot.type === "WM" || slot.type === "LM"){
            const src = slot.id;
            if(!graph.has(src)) graph.set(src, []);
            graph.get(src).push(m.id);
          }
        });
      });
      return graph;
    }

    const DEP_GRAPH = buildDependencyGraph();

    function collectDownstreamMatchIds(startIds){
      const out = new Set();
      const q = [...startIds];

      while(q.length){
        const cur = q.shift();
        const kids = DEP_GRAPH.get(cur) || [];
        kids.forEach(k => {
          if(!out.has(k)){
            out.add(k);
            q.push(k);
          }
        });
      }
      return out;
    }

    function getAssignedThirdNameFromSnapshot(snapshot, matchId, slot){
      if(!snapshot) return null;
      const assign = snapshot.assignment?.[matchId];
      if(assign) return assign.name;
      return thirdPlaceholderName(slot.set);
    }

    function resolveParticipants(match){
      const L = resolveSlot(match.left, match.id);
      const R = resolveSlot(match.right, match.id);
      return { left:L, right:R };
    }

    /* ==============================
       12) Winner validation (cascade)
    ============================== */
    function validateAllWinners(){
      const order = [
        ...R32_MATCHES.map(m=>m.id),
        ...R16_MATCHES.map(m=>m.id),
        ...QF_MATCHES.map(m=>m.id),
        ...SF_MATCHES.map(m=>m.id),
        103,
        104
      ];

      order.forEach(id => {
        const match = findMatchById(id);
        if(!match) return;

        const stored = state.winners[id];
        if(!stored) return;

        const p = resolveParticipants(match);

        if(p.left.placeholder || p.right.placeholder){
          delete state.winners[id];
          return;
        }

        const currentLeft = p.left.name;
        const currentRight = p.right.name;

        if(stored.leftAtPick !== currentLeft || stored.rightAtPick !== currentRight){
          delete state.winners[id];
          return;
        }

        if(![currentLeft, currentRight].includes(stored.name)){
          delete state.winners[id];
          return;
        }
      });
    }

    function setWinner(matchId, side, name){
      const match = findMatchById(matchId);
      if(!match) return;

      const p = resolveParticipants(match);
      if(p.left.placeholder || p.right.placeholder) return;

      const ab = teamAbbrev(name);

      state.winners[matchId] = {
        side,
        name,
        abbrev: ab,
        leftAtPick: p.left.name,
        rightAtPick: p.right.name
      };

      validateAllWinners();
      render();
    }

    /* ==============================
       13) Edit rules
    ============================== */
    function isClickSwapEnabledForZone(zoneKey){
      if(editMode === "pools") return isPathZone(zoneKey);
      if(editMode === "groups"){
        return isGroupZone(zoneKey) || zoneKey === "third-ranking";
      }
      return false;
    }

    /* ==============================
       14) Zone arrays
    ============================== */
    function getZoneArray(zoneKey){
      if(isPathZone(zoneKey)) return state.paths[pathIdFromZone(zoneKey)];
      if(isGroupZone(zoneKey)) return state.groups[groupKeyFromZone(zoneKey)];
      if(zoneKey === "third-ranking"){ syncThirdRankingNames(); return state.thirdRanking; }
      if(zoneKey === "champions-view") return computeChampions();
      if(zoneKey === "runners-view") return computeRunners();
      if(zoneKey === "top8-third-view") return computeTop8ThirdPlaced();
      return null;
    }

    /* ==============================
       15) Pool status display
    ============================== */
    function clearPoolStatus(){
      PATHS.forEach(p => {
        const arr = state.paths[p.id];
        if(!arr) return;
        arr.forEach(t => { t.isQualified = false; t.isEliminated = false; });
        state.qualifiedByPath[p.id] = false;
      });
    }

    function markQualifiedAndEliminated(pathId){
      const pathArr = state.paths[pathId];
      if(!pathArr || pathArr.length === 0) return;
      pathArr.forEach((t, i) => {
        t.isQualified = (i === 0);
        t.isEliminated = (i !== 0);
      });
      state.qualifiedByPath[pathId] = true;
    }

    /* ==============================
       16) Click-to-swap logic (+ userMoved)
       - Pools/Groups: FULL-ZONE lock
       - Third Ranking: TEAM-WISE lock
    ============================== */
    function swapTeamsInArray(arr, id1, id2){
      const i1 = arr.findIndex(t => t.id === id1);
      const i2 = arr.findIndex(t => t.id === id2);
      if(i1 === -1 || i2 === -1) return { ok:false };

      const t1 = arr[i1];
      const t2 = arr[i2];

      [arr[i1], arr[i2]] = [arr[i2], arr[i1]];

      return { ok:true, t1, t2 };
    }

    function markWholeZoneMoved(arr){
      if(!arr) return;
      arr.forEach(t => {
        if(t && !t.isPlaceholder) t.userMoved = true;
      });
    }

    function markTwoMoved(t1, t2){
      if(t1) t1.userMoved = true;
      if(t2) t2.userMoved = true;
    }

    function handleClickSwap(teamId, zone){
      if(!isClickSwapEnabledForZone(zone)) return;

      if(!swapSelection){
        swapSelection = { teamId, zone };
        render();
        return;
      }

      if(swapSelection.teamId === teamId && swapSelection.zone === zone){
        swapSelection = null;
        render();
        return;
      }

      if(swapSelection.zone !== zone){
        swapSelection = { teamId, zone };
        render();
        return;
      }

      const arr = getZoneArray(zone);
      if(!arr) return;

      const res = swapTeamsInArray(arr, swapSelection.teamId, teamId);
      swapSelection = null;

      if(res.ok){
        if(zone === "third-ranking"){
          markTwoMoved(res.t1, res.t2);
          thirdRankingDirty = true;
        } else if(isPathZone(zone) || isGroupZone(zone)){
          markWholeZoneMoved(arr);
        }

        validateAllWinners();
      }

      render();
    }

    function attachClickSwap(card){
      card.addEventListener("click", () => {
        handleClickSwap(card.dataset.id, card.dataset.zone);
      });
    }

    /* ==============================
       17) Place qualifiers to groups
    ============================== */
    function upsertPathTeamInGroup(groupKey, pathId, chosenTeam){
      const arr = state.groups[groupKey];
      if(!arr) return;

      const newObj = {
        id: toId(`grp-${groupKey}-${pathId}-${chosenTeam.name}`),
        name: chosenTeam.name,
        tag: PATH_BY_ID[pathId].label,
        chosenFromPath: true,
        pathId,
        userMoved: false
      };

      const phIndex = arr.findIndex(t => t.isPlaceholder && t.pathId === pathId);
      if(phIndex !== -1){
        arr.splice(phIndex, 1, newObj);
        return;
      }

      const exIndex = arr.findIndex(t => t.chosenFromPath && t.pathId === pathId);
      if(exIndex !== -1){
        arr.splice(exIndex, 1, newObj);
        return;
      }

      arr.push(newObj);
    }

    function placeQualifiersToGroups(){
      PATHS.forEach(p => {
        const pathArr = state.paths[p.id];
        if(!pathArr || pathArr.length === 0) return;
        const chosen = pathArr[0];
        upsertPathTeamInGroup(p.group, p.id, chosen);
        markQualifiedAndEliminated(p.id);
      });

      editMode = "groups";
      swapSelection = null;

      validateAllWinners();
      render();
    }

    function reformPoolMode(){
      editMode = "pools";
      swapSelection = null;
      clearPoolStatus();
      render();
    }

    /* ==============================
       18) AUTO select with lock-on-moved
    ============================== */
    function sortKeyForTeam(t){
      const ph = t?.isPlaceholder ? 1 : 0;
      const r  = rankOf(t?.name);
      return { ph, r, n: String(t?.name ?? "") };
    }

    function sortMovable(arr){
      arr.sort((a,b) => {
        const A = sortKeyForTeam(a);
        const B = sortKeyForTeam(b);
        if(A.ph !== B.ph) return A.ph - B.ph;
        if(A.r !== B.r) return A.r - B.r;
        return A.n.localeCompare(B.n);
      });
    }

function reorderRespectingUserMoved(arr){
  if(!Array.isArray(arr)) return arr;

  const n = arr.length;

  // (Optional) If you want FULL-ZONE lock once anything is moved:
  // if(arr.some(t => t && t.userMoved)) return arr;

  // 1) Capture fixed positions (userMoved === true)
  const fixed = new Map(); // index -> team
  for(let i = 0; i < n; i++){
    const t = arr[i];
    if(t && t.userMoved){
      fixed.set(i, t);
    }
  }

  // 2) Everything else is movable and can be sorted
  const movable = [];
  for(let i = 0; i < n; i++){
    if(!fixed.has(i)) movable.push(arr[i]);
  }

  sortMovable(movable);

  // 3) Rebuild array with fixed slots preserved
  const out = new Array(n);
  fixed.forEach((t, idx) => { out[idx] = t; });

  let j = 0;
  for(let i = 0; i < n; i++){
    if(out[i] !== undefined) continue;
    out[i] = movable[j++];
  }

  // 4) Mutate in place
  arr.splice(0, n, ...out);

  return arr;
}



    function autoPools(){
      PATHS.forEach(p => {
        const arr = state.paths[p.id];
        if(!arr) return;
        state.paths[p.id] = reorderRespectingUserMoved(arr);
      });
      render();
    }

    function autoGroups(){
      GROUP_KEYS.forEach(g => {
        let arr = state.groups[g];
        if(!arr) return;

        arr = arr.slice(0,4);
        const re = reorderRespectingUserMoved(arr);

        state.groups[g] = re;
      });

      validateAllWinners();
      render();
    }

    function autoThirdRanking(){
      syncThirdRankingNames();
      state.thirdRanking = reorderRespectingUserMoved(state.thirdRanking);
      thirdRankingDirty = true;

      validateAllWinners();
      render();
    }

    function autoRound(matches){
      validateAllWinners();

      matches.forEach(m => {
        if(state.winners[m.id]) return;

        const p = resolveParticipants(m);
        if(p.left.placeholder || p.right.placeholder) return;

        const winnerName = pickWinnerNameAuto(p.left.name, p.right.name);
        const side = (winnerName === p.left.name) ? "L" : "R";

        state.winners[m.id] = {
          side,
          name: winnerName,
          abbrev: teamAbbrev(winnerName),
          leftAtPick: p.left.name,
          rightAtPick: p.right.name
        };
      });

      validateAllWinners();
      render();
    }

    /* ==============================
       19) Regenerate R32 (SMART)
    ============================== */
    function regenerateR32(){
      const hadSnapshot = !!state.r32ThirdSnapshot;
      const wasGenerated = !!state.r32Generated;

      if(!wasGenerated || !hadSnapshot){
        state.winners = {};
        state.r32Generated = true;
        buildR32ThirdSnapshot();
        thirdRankingDirty = false;

        validateAllWinners();
        render();
        return;
      }

      if(!thirdRankingDirty){
        buildR32ThirdSnapshot();
        validateAllWinners();
        render();
        return;
      }

      const oldSnap = state.r32ThirdSnapshot;

      buildR32ThirdSnapshot();
      const newSnap = state.r32ThirdSnapshot;

      const thirdR32Ids = getR32ThirdDependentMatchIds();
      const changedR32 = [];

      thirdR32Ids.forEach(mid => {
        const match = findMatchById(mid);
        if(!match) return;

        const thirdSlot =
          (match.left.type === "3SET") ? match.left :
          (match.right.type === "3SET") ? match.right :
          null;

        if(!thirdSlot) return;

        const oldName = getAssignedThirdNameFromSnapshot(oldSnap, mid, thirdSlot);
        const newName = getAssignedThirdNameFromSnapshot(newSnap, mid, thirdSlot);

        if(oldName !== newName){
          changedR32.push(mid);
        }
      });

      if(changedR32.length === 0){
        thirdRankingDirty = false;
        validateAllWinners();
        render();
        return;
      }

      changedR32.forEach(id => { delete state.winners[id]; });

      const downstream = collectDownstreamMatchIds(changedR32);
      downstream.forEach(id => { delete state.winners[id]; });

      state.r32Generated = true;
      thirdRankingDirty = false;

      validateAllWinners();
      render();
    }

    /* ==============================
       20) UI helpers
    ============================== */
    function makeSeparator(text, buttonOptions=null){
      const sep = document.createElement("div");
      sep.className = "stage-separator";

      const left = document.createElement("div");
      left.className = "stage-left";
      left.innerHTML = `
        <span class="stage-title">${text}</span>
        <span class="stage-line"></span>
      `;
      sep.appendChild(left);

      if(buttonOptions){
        const right = document.createElement("div");
        right.className = "stage-right";

        const btns = Array.isArray(buttonOptions) ? buttonOptions : [buttonOptions];
        btns.forEach(opt => {
          const btn = document.createElement("button");
          btn.id = opt.id;
          btn.textContent = opt.text;
          if(opt.mini) btn.classList.add("btn-mini");
          if(opt.orange) btn.classList.add("btn-orange");
          if(opt.green) btn.classList.add("btn-green");
          right.appendChild(btn);
        });

        sep.appendChild(right);
      }

      return sep;
    }

    function makeColumn(title, zoneKey, subtitle = ""){
      const col = document.createElement("section");
      col.className = "column";

      const isGroupZoneKey = /^group-([A-L])$/.test(zoneKey);
      const groupKeyForZone = isGroupZoneKey ? zoneKey.split("-")[1] : "";

      col.innerHTML = `
        <div class="column-header">
          <div class="column-title">
            ${title}${subtitle ? ` • ${subtitle}` : ""}
            <span class="zone-moved-badge" data-zone-moved="${zoneKey}" style="display:none;"></span>
          </div>
          <div class="column-header-right">
            ${isGroupZoneKey ? `<button class="btn-mini group-expand-btn" data-group="${groupKeyForZone}">Matches</button>` : ""}
            <div class="count" data-count-for="${zoneKey}"></div>
          </div>
        </div>
        <div class="zone" data-zone="${zoneKey}"></div>
      `;
      return col;
    }


    function makeKoSection(roundKey, className=""){
      const section = document.createElement("div");
      section.className = `ko-section ko-${roundKey}`.trim();

      const grid = document.createElement("div");
      grid.className = `ko-grid ${className}`.trim();
      grid.dataset.koRound = roundKey;

      section.appendChild(grid);
      return section;
    }

    /* ==============================
       21) Build Board (ORDER)
    ============================== */
    function buildBoard(){
      const board = document.getElementById("board");
      board.innerHTML = "";

      board.appendChild(makeSeparator("Qualifier Pools"));
      PATHS.forEach(p => {
        board.appendChild(makeColumn(p.label, `path-${p.id}`, `feeds Group ${p.group}`));
      });

      board.appendChild(
        makeSeparator(
          "Pool Actions",
          [
            { id:"autoPoolsBtn", text:"Auto-order remaining Pool positions", orange:true },
            { id:"placeQualifiersBtn", text:"Place qualifiers in the Groups", green:true },
            { id:"reformPoolBtn", text:"Reform Pool" }
          ]
        )
      );

      board.appendChild(makeSeparator("Groups"));
      GROUP_KEYS.forEach(g => {
        board.appendChild(makeColumn(`Group ${g}`, `group-${g}`));
      });

      board.appendChild(
        makeSeparator(
          "Group Actions",
          [
            { id:"autoGroupsBtn", text:"Auto-order remaining Group positions", orange:true }
          ]
        )
      );

      board.appendChild(makeSeparator("Third-Place Ranking"));
      board.appendChild(makeColumn("Third Place Team Ranking", "third-ranking", "A3 → L3"));

      board.appendChild(
        makeSeparator(
          "Third-Place Actions",
          [
            { id:"autoThirdBtn", text:"Auto-order remaining Third positions", orange:true }
          ]
        )
      );

      board.appendChild(makeSeparator("Qualified Overview"));
      board.appendChild(makeColumn("Group Champions", "champions-view", "A1 → L1"));
      board.appendChild(makeColumn("Group Runners", "runners-view", "A2 → L2"));
      board.appendChild(makeColumn("Top-8 Third Placed Teams", "top8-third-view", "auto"));

      board.appendChild(
        makeSeparator(
          "R32 Sync",
          [
            { id:"regenerateR32Btn", text:"Regenerate R32", orange:true }
          ]
        )
      );

      board.appendChild(makeSeparator("Round of 32"));
      board.appendChild(makeKoSection("r32"));

      board.appendChild(
        makeSeparator(
          "Round of 32 Actions",
          [
            { id:"autoR32Btn", text:"Auto-Select remaining R32 Winners", orange:true }
          ]
        )
      );

      board.appendChild(makeSeparator("Round of 16"));
      board.appendChild(makeKoSection("r16"));
      board.appendChild(
        makeSeparator(
          "Round of 16 Actions",
          [
            { id:"autoR16Btn", text:"Auto-Select remaining R16 Winners", orange:true }
          ]
        )
      );

      board.appendChild(makeSeparator("Quarterfinals"));
      board.appendChild(makeKoSection("qf"));
      board.appendChild(
        makeSeparator(
          "Quarterfinal Actions",
          [
            { id:"autoQFBtn", text:"Auto-Select remaining QF Winners", orange:true }
          ]
        )
      );

      board.appendChild(makeSeparator("Semifinals"));
      board.appendChild(makeKoSection("sf", "centered"));
      board.appendChild(
        makeSeparator(
          "Semifinal Actions",
          [
            { id:"autoSFBtn", text:"Auto-Select remaining SF Winners", orange:true }
          ]
        )
      );

      board.appendChild(makeSeparator("Third Place Match"));
      board.appendChild(makeKoSection("third", "centered"));
      board.appendChild(
        makeSeparator(
          "Third Place Match Actions",
          [
            { id:"autoThirdMatchBtn", text:"Auto-Select 3rd Place Winner", orange:true }
          ]
        )
      );

      board.appendChild(makeSeparator("Final"));
      board.appendChild(makeKoSection("final", "centered"));
      board.appendChild(
        makeSeparator(
          "Final Actions",
          [
            { id:"autoFinalBtn", text:"Auto-Select The Champion", orange:true }
          ]
        )
      );

      /* ✅ NEW: Result Actions at the end */
      board.appendChild(
        makeSeparator(
          "Result",
          [
            { id:"printResultsBtn", text:"Print Result", green:true }
          ]
        )
      );
    }

    /* ==============================
       22) Render standard zones
    ============================== */
    function applyRankHighlight(cardEl, zone, idx, team){
      cardEl.classList.remove("rank-strong", "rank-mild", "qualified", "eliminated");

      if(isPathZone(zone)){
        if(idx === 0) cardEl.classList.add("rank-strong");
        if(editMode === "groups"){
          if(team.isQualified) cardEl.classList.add("qualified");
          if(team.isEliminated) cardEl.classList.add("eliminated");
        }
        return;
      }

      if(isGroupZone(zone)){
        if(idx === 0 || idx === 1) cardEl.classList.add("rank-strong");
        else if(idx === 2) cardEl.classList.add("rank-mild");
        return;
      }

      if(zone === "third-ranking"){
        if(idx < 8) cardEl.classList.add("rank-strong");
        return;
      }

      if(zone === "top8-third-view"){
        cardEl.classList.add("rank-strong");
      }
    }

    function renderStandardZones(){
      syncThirdRankingNames();

      zones.forEach(zone => {
        const dz = document.querySelector(`.zone[data-zone="${zone}"]`);
        if(!dz) return;

        dz.innerHTML = "";

        const arr = getZoneArray(zone) ?? [];
        const gKey = isGroupZone(zone) ? groupKeyFromZone(zone) : null;

        /* ZONE-LEVEL "User moved" BADGE (Pools + Groups only) */
        const movedBadge = document.querySelector(`[data-zone-moved="${zone}"]`);
        if(movedBadge){
          if(isPathZone(zone) || isGroupZone(zone)){
            const movedAny = (arr || []).some(t => t && t.userMoved && !t.isPlaceholder);
            movedBadge.textContent = movedAny ? "User moved" : "";
            movedBadge.style.display = movedAny ? "inline-block" : "none";
          } else {
            movedBadge.textContent = "";
            movedBadge.style.display = "none";
          }
        }

        arr.forEach((team, idx) => {
          const card = document.createElement("div");
          card.className = "card";
          card.dataset.id = team.id;
          card.dataset.zone = zone;

          const editable =
            isClickSwapEnabledForZone(zone) &&
            !team.isPlaceholder &&
            zone !== "champions-view" &&
            zone !== "runners-view" &&
            zone !== "top8-third-view";

          if(!editable) card.classList.add("locked");

          applyRankHighlight(card, zone, idx, team);

          if(swapSelection && swapSelection.teamId === team.id && swapSelection.zone === zone){
            card.classList.add("swap-armed");
          }

          /* Tag text rules */
          let tagText = "";

          if(isPathZone(zone)){
            if(editMode === "groups"){
              tagText = (team.isQualified ? "Qualified" : "Eliminated");
            } else {
              tagText = team.tag ?? PATH_BY_ID[pathIdFromZone(zone)]?.label ?? "";
            }
          }
          else if(isGroupZone(zone)){
            if(team.isPlaceholder){
              tagText = "Placeholder";
            } else {
              tagText = `${gKey}${idx + 1}`;
            }
          }
          else if(zone === "third-ranking"){
            const moved = team?.userMoved ? " • moved" : "";
            tagText = `${team.groupKey}3${moved}`;
          }
          else if(zone === "champions-view"){
            tagText = `${team.groupKey}1`;
          }
          else if(zone === "runners-view"){
            tagText = `${team.groupKey}2`;
          }
          else if(zone === "top8-third-view"){
            tagText = `${team.groupKey}3`;
          }

          card.innerHTML = `
            <span class="name">${nameWithFlagHTML(team.name)}</span>
            <span class="tag">${tagText}</span>
          `;

          if(!team.isPlaceholder && !["champions-view", "runners-view", "top8-third-view"].includes(zone)){
            attachClickSwap(card);
          }

          dz.appendChild(card);
        });

        if(zone === "top8-third-view"){
          const summary = document.createElement("div");
          summary.className = "top8-summary";
          summary.textContent = qualifiedThirdGroupLetters || "—";
          dz.appendChild(summary);
        }

        const countEl = document.querySelector(`[data-count-for="${zone}"]`);
        if(countEl){
          countEl.textContent = `${arr.length} team${arr.length !== 1 ? "s" : ""}`;
        }
      });
    }

    /* ==============================
       23) Local time rendering helpers
    ============================== */
    const MONTHS = {
      january:0, february:1, march:2, april:3, may:4, june:5,
      july:6, august:7, september:8, october:9, november:10, december:11
    };

    function parseDateStr(dateStr){
      const m = String(dateStr).match(/^([A-Za-z]+)\s+(\d{1,2}),\s+(\d{4})$/);
      if(!m) return null;
      const month = MONTHS[m[1].toLowerCase()];
      const day = Number(m[2]);
      const year = Number(m[3]);
      if(month == null) return null;
      return { year, month, day };
    }

    function parseTime12h(timeStr){
      const s = String(timeStr).toLowerCase().replace(/\s+/g," ").trim();
      const m = s.match(/^(\d{1,2}):(\d{2})\s*(a\.m\.|p\.m\.)$/);
      if(!m) return null;
      let h = Number(m[1]);
      const min = Number(m[2]);
      const ampm = m[3];
      if(ampm.startsWith("p") && h !== 12) h += 12;
      if(ampm.startsWith("a") && h === 12) h = 0;
      return { h, min };
    }

    function utcMillisFromVenueInfo(info){
      if(!info || info.offsetHours == null) return null;
      const d = parseDateStr(info.date);
      const t = parseTime12h(info.time);
      if(!d || !t) return null;

      const utcHour = t.h - info.offsetHours;
      return Date.UTC(d.year, d.month, d.day, utcHour, t.min, 0);
    }

    function formatLocalKickoff(info){
      const ms = utcMillisFromVenueInfo(info);
      if(ms == null) return info?.time ? info.time : "Time TBD";

      const dt = new Date(ms);
      const fmt = new Intl.DateTimeFormat(undefined, {
        dateStyle: "medium",
        timeStyle: "short"
      });
      return fmt.format(dt);
    }

    /* ==============================
       24) Render KO rounds
    ============================== */
   function buildMatchCard(match){
  const p = resolveParticipants(match);
  const L = p.left;
  const R = p.right;

  const winner = state.winners[match.id];
  const info = INFO_BY_MATCH[match.id];

  const card = document.createElement("div");
  card.className = "match-card";
  card.dataset.matchId = match.id;

  // ✅ for match highlighting
  card.setAttribute("data-team-a", L.name || "");
  card.setAttribute("data-team-b", R.name || "");

  const idx = document.createElement("div");
  idx.className = "match-index";
  idx.textContent = `Match ${match.id}`;
  card.appendChild(idx);

  const vs = document.createElement("div");
  vs.className = "match-vs";
  vs.textContent = `${L.label} vs ${R.label}`;
  card.appendChild(vs);

  const leftBtn = document.createElement("div");
  leftBtn.className = "match-team team-a";
  leftBtn.innerHTML = nameWithFlagHTML(L.name);

  const mid = document.createElement("div");
  mid.className = "match-mid";

  const rightBtn = document.createElement("div");
  rightBtn.className = "match-team team-b";
  rightBtn.innerHTML = nameWithFlagHTML(R.name);

  const inR32Range = (match.id >= 73 && match.id <= 88);
  const canPick =
    (!inR32Range || state.r32Generated) &&
    !L.placeholder && !R.placeholder;

  if(!canPick){
    leftBtn.classList.add("locked");
    rightBtn.classList.add("locked");
    mid.textContent = "---";
  } else {
    leftBtn.addEventListener("click", () => setWinner(match.id, "L", L.name));
    rightBtn.addEventListener("click", () => setWinner(match.id, "R", R.name));
    mid.textContent = winner ? winner.abbrev : "---";
  }

  if(winner && canPick){
    if(winner.name === L.name) leftBtn.classList.add("winning");
    if(winner.name === R.name) rightBtn.classList.add("winning");
  }

  card.appendChild(leftBtn);
  card.appendChild(mid);
  card.appendChild(rightBtn);

  const bottom = document.createElement("div");
  bottom.className = "match-bottom";

  const leftMeta = document.createElement("span");
  const rightMeta = document.createElement("span");

  if(info){
    leftMeta.innerHTML = `
      <span class="chip">${info.date}</span>
      <span class="chip">Local time: ${formatLocalKickoff(info)}</span>
    `;
    rightMeta.innerHTML = `
      <span class="chip">${info.stadium}</span>
      <span class="chip">${info.city}</span>
    `;
  } else {
    leftMeta.innerHTML = `<span class="chip">Date/Time TBD</span>`;
    rightMeta.innerHTML = `<span class="chip">Venue TBD</span>`;
  }

  bottom.appendChild(leftMeta);
  bottom.appendChild(rightMeta);
  card.appendChild(bottom);

  return card;
}


    function renderKoRound(roundKey){
      const grid = document.querySelector(`.ko-grid[data-ko-round="${roundKey}"]`);
      if(!grid) return;

      grid.innerHTML = "";

      const matches = ALL_ROUNDS[roundKey] ?? [];
      matches.forEach(m => grid.appendChild(buildMatchCard(m)));

      if(roundKey === "r32"){
        const parent = grid.parentElement;
        parent.querySelectorAll(".r32-note").forEach(n => n.remove());

        const note = document.createElement("div");
        note.className = "r32-note";
        note.textContent = (!state.r32Generated)
          ? "R32 not generated yet. Third-place slots are placeholders from the mapping sets."
          : "R32 3rd-place teams are frozen from your last Regenerate click.";
        parent.appendChild(note);
      }
    }

    function renderAllKo(){
      validateAllWinners();
      renderKoRound("r32");
      renderKoRound("r16");
      renderKoRound("qf");
      renderKoRound("sf");
      renderKoRound("third");
      renderKoRound("final");
    }

    /* ==============================
       25) R32 badge updater
    ============================== */
    function updateRegenerateR32Badge(){
      const btn = document.getElementById("regenerateR32Btn");
      if(!btn) return;

      const base = "Regenerate R32";
      if(thirdRankingDirty){
        btn.innerHTML = `${base}<span class="outofdate-badge">R32 out-of-date</span>`;
      } else {
        btn.textContent = base;
      }
    }

      /* ==============================
       25) Match Highlight
    ============================== */
(() => {
  // Prevent double-initialization if script is pasted twice or loaded twice
  if (window.__wc26_match_highlight_init) return;
  window.__wc26_match_highlight_init = true;

  // ---------- TEAM SETS ----------
  const TIER_1 = new Set(["argentina","england","portugal","brazil","spain","france","germany"]);
  const TIER_2 = new Set(["netherlands","belgium","croatia","italy"]);

  function normTeamName(name) {
    if (!name) return "";
    const s = String(name).trim().toLowerCase();
    const aliases = {
      "brésil": "brazil",
      "deutschland": "germany",
      "españa": "spain",
      "holland": "netherlands",
    };
    return aliases[s] || s;
  }

  function getMatchCategory(teamA, teamB) {
    const a = normTeamName(teamA);
    const b = normTeamName(teamB);

    // Treat placeholders as invalid (covers "Winner 73", "Runner-up A", etc.)
    if (!a || !b) return null;
    if (a.startsWith("winner") || b.startsWith("winner")) return null;
    if (a.startsWith("runner") || b.startsWith("runner")) return null;
    if (a.includes("tbd") || b.includes("tbd")) return null;

    const isTier1A = TIER_1.has(a);
    const isTier1B = TIER_1.has(b);
    const isTier2A = TIER_2.has(a);
    const isTier2B = TIER_2.has(b);

    const isArgentinaPortugal =
      (a === "argentina" && b === "portugal") || (a === "portugal" && b === "argentina");
    const isBrazilArgentina =
      (a === "brazil" && b === "argentina") || (a === "argentina" && b === "brazil");

    if (isArgentinaPortugal) return { tag: "Grand Slam", cls: "match--grand-slam" };
    if (isBrazilArgentina)   return { tag: "Home Run",   cls: "match--home-run" };
    if (isTier1A && isTier1B) return { tag: "Third Base", cls: "match--third-base" };
    if ((isTier1A && isTier2B) || (isTier2A && isTier1B)) return { tag: "Second Base", cls: "match--second-base" };
    if (isTier1A || isTier1B) return { tag: "First Base", cls: "match--first-base" };

    return null;
  }

  const MATCH_CLASSES = [
    "match--first-base",
    "match--second-base",
    "match--third-base",
    "match--home-run",
    "match--grand-slam",
  ];

  function ensureTagBadge(matchEl) {
    let badge = matchEl.querySelector(".match-tag");
    if (!badge) {
      badge = document.createElement("div");
      badge.className = "match-tag";
      matchEl.prepend(badge);
    }
    return badge;
  }

  function readTeamsFromMatch(matchEl) {
    const a1 = matchEl.getAttribute("data-team-a") || "";
    const b1 = matchEl.getAttribute("data-team-b") || "";
    if (a1 || b1) return { teamA: a1, teamB: b1 };

    const aEl = matchEl.querySelector(".team-a");
    const bEl = matchEl.querySelector(".team-b");
    return { teamA: aEl ? aEl.textContent : "", teamB: bEl ? bEl.textContent : "" };
  }

  function applyMatchHighlight(matchEl) {
    matchEl.classList.remove(...MATCH_CLASSES);
    matchEl.removeAttribute("data-match-tag");

    const badge = ensureTagBadge(matchEl);
    badge.textContent = "";
    badge.style.display = "none";

    const { teamA, teamB } = readTeamsFromMatch(matchEl);
    const cat = getMatchCategory(teamA, teamB);
    if (!cat) return;

    matchEl.classList.add(cat.cls);
    matchEl.setAttribute("data-match-tag", cat.tag);
    badge.textContent = cat.tag;
    badge.style.display = "";
  }

  function updateAllMatchHighlights(root = document) {
    root.querySelectorAll(".match-card").forEach(applyMatchHighlight);
  }

  function safeUpdateHighlights() {
    try { updateAllMatchHighlights(document); } catch(e) {}
  }

  // Wrap renderAllKo safely (only if it exists)
  if (typeof renderAllKo === "function") {
    const _renderAllKo = renderAllKo;
    renderAllKo = function () {
      _renderAllKo();
      safeUpdateHighlights();
    };
  }

  // Run once after DOM paints (safe even if cards aren’t there yet)
  requestAnimationFrame(safeUpdateHighlights);
})();




    /* ==============================
       26) Clear moved flags (GLOBAL)
    ============================== */
    function clearAllUserMoved(){
      Object.values(state.paths || {}).forEach(arr => {
        (arr || []).forEach(t => { if(t) t.userMoved = false; });
      });

      Object.values(state.groups || {}).forEach(arr => {
        (arr || []).forEach(t => { if(t) t.userMoved = false; });
      });

      syncThirdRankingNames();
      (state.thirdRanking || []).forEach(t => { if(t) t.userMoved = false; });

      swapSelection = null;

      validateAllWinners();
      render();
    }

    /* ==============================
       27) PRINT RESULT - NAME + CANVAS
    ============================== */
/* ==============================
   RESULT IMAGE GENERATION v3 (SVG FLAGS)
   - uses local ./svg/*.svg
   - fixes view
   - tighter + colorful
============================== */

const SITE_SOURCE_NAME = "World Cup 2026 Predictor";

function getSiteUrlForImage(){
  try{
    return document.querySelector('link[rel="canonical"]')?.href || location.href;
  } catch(e){
    return "";
  }
}

/* ------------------------------
   Name capture (restored)
------------------------------ */
function ensureUserFirstName(){
  let stored = localStorage.getItem("wc26_user_first_name");
  if(stored) return stored;

  const raw = prompt("Enter your first name for the prediction image (optional):");
  const clean = String(raw || "").trim();
  if(clean){
    const first = clean.split(/\s+/)[0];
    localStorage.setItem("wc26_user_first_name", first);
    return first;
  }
  return "Your";
}
function getUserFirstName(){
  return localStorage.getItem("wc26_user_first_name") || "Your";
}

/* ------------------------------
   Result preview modal
------------------------------ */
function ensureResultModal(){
  let modal = document.getElementById("resultPreviewModal");
  if(modal) return modal;

  modal = document.createElement("div");
  modal.id = "resultPreviewModal";
  modal.className = "result-modal";
  modal.innerHTML = `
    <div class="result-modal-card">
      <div class="result-modal-head">
        <div class="title">Your World Cup 2026 bracket image</div>
        <div>
          <button class="btn-mini" id="resultModalCloseBtn">Close</button>
        </div>
      </div>
      <div class="result-modal-body">
        <img id="resultModalImg" alt="Prediction image">
      </div>
    </div>
  `;
  document.body.appendChild(modal);

  modal.addEventListener("click", (e) => {
    if(e.target === modal) modal.classList.remove("open");
  });

  modal.querySelector("#resultModalCloseBtn")
    .addEventListener("click", () => modal.classList.remove("open"));

  return modal;
}

function showResultPreviewFromUrl(dataUrl){
  const modal = ensureResultModal();
  const img = modal.querySelector("#resultModalImg");
  img.src = dataUrl;
  modal.classList.add("open");
}

/* ------------------------------
   Canvas flag loading (LOCAL SVG)
------------------------------ */
const FLAG_CANVAS_W = 20;
const FLAG_CANVAS_H = 14;
const FLAG_TEXT_GAP = 8;

const _flagCanvasCache = new Map();

function loadFlagImageForName(name){
  const url = flagURLByName(name);
  if(!url) return Promise.resolve(null);

  if(_flagCanvasCache.has(name)) return Promise.resolve(_flagCanvasCache.get(name));

  return new Promise(res => {
    const img = new Image();
    img.onload = () => { _flagCanvasCache.set(name, img); res(img); };
    img.onerror = () => { _flagCanvasCache.set(name, null); res(null); };
    img.src = url;
  });
}

async function preloadFlagsForMatchIds(matchIds){
  const names = new Set();
  matchIds.forEach(id => {
    const m = findMatchById(id);
    if(!m) return;
    const p = resolveParticipants(m);
    if(p.left?.name) names.add(p.left.name);
    if(p.right?.name) names.add(p.right.name);
  });

  await Promise.all([...names].map(n => loadFlagImageForName(n)));
}

/* ------------------------------
   Drawing helpers
------------------------------ */
function roundRectPath(ctx, x,y,w,h,rad){
  const r = Math.min(rad, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.lineTo(x+w-r, y);
  ctx.quadraticCurveTo(x+w, y, x+w, y+r);
  ctx.lineTo(x+w, y+h-r);
  ctx.quadraticCurveTo(x+w, y+h, x+w-r, y+h);
  ctx.lineTo(x+r, y+h);
  ctx.quadraticCurveTo(x, y+h, x, y+h-r);
  ctx.lineTo(x, y+r);
  ctx.quadraticCurveTo(x, y, x+r, y);
  ctx.closePath();
}
function centerOf(pos){
  return { cx: pos.x + pos.w/2, cy: pos.y + pos.h/2 };
}
function normalizeLayout(posById, W, H){
  const vals = Object.values(posById);
  if(!vals.length) return posById;

  const minX = Math.min(...vals.map(p => p.x));
  const minY = Math.min(...vals.map(p => p.y));
  const maxX = Math.max(...vals.map(p => p.x + p.w));
  const maxY = Math.max(...vals.map(p => p.y + p.h));

  const contentW = Math.max(1, maxX - minX);
  const contentH = Math.max(1, maxY - minY);

  const padL = 36;
  const padR = 36;
  const padT = 92;
  const padB = 78;

  const availW = W - padL - padR;
  const availH = H - padT - padB;

  const scale = Math.min(availW / contentW, availH / contentH);

  const out = {};
  for(const [id, p] of Object.entries(posById)){
    out[id] = {
      x: (p.x - minX) * scale + padL,
      y: (p.y - minY) * scale + padT,
      w: p.w * scale,
      h: p.h * scale
    };
  }
  return out;
}

function drawConnector(ctx, fromPos, toPos){
  const a = centerOf(fromPos);
  const b = centerOf(toPos);
  const midX = (a.cx + b.cx) / 2;

  ctx.strokeStyle = "rgba(122,162,255,0.22)";
  ctx.lineWidth = 2;

  ctx.beginPath();
  ctx.moveTo(a.cx + fromPos.w/2 - 6, a.cy);
  ctx.lineTo(midX, a.cy);
  ctx.lineTo(midX, b.cy);
  ctx.lineTo(b.cx - toPos.w/2 + 6, b.cy);
  ctx.stroke();
}

function winnerAccentForRound(label){
  if(label === "R16") return "rgba(94,230,255,0.45)";
  if(label === "QF")  return "rgba(122,162,255,0.50)";
  if(label === "SF")  return "rgba(255,184,107,0.55)";
  if(label === "FINAL") return "rgba(122,255,187,0.65)";
  if(label === "3RD PLACE") return "rgba(255,107,122,0.55)";
  return "rgba(94,230,168,0.45)";
}

function drawBoxFrame(ctx, x,y,w,h, rad, accentColor){
  roundRectPath(ctx, x,y,w,h,rad);

  const g = ctx.createLinearGradient(x, y, x+w, y+h);
  g.addColorStop(0, "rgba(255,255,255,0.06)");
  g.addColorStop(1, "rgba(255,255,255,0.02)");
  ctx.fillStyle = g;
  ctx.fill();

  ctx.strokeStyle = "rgba(255,255,255,0.14)";
  ctx.lineWidth = 1.1;
  ctx.stroke();

  if(accentColor){
    ctx.fillStyle = accentColor;
    ctx.fillRect(x + w - 7, y + 6, 3, h - 12);
  }
}

function drawFlagAndAbbr(ctx, name, x, baselineY, isWinner){
  const ab = teamAbbrev(name);
  const img = _flagCanvasCache.get(name) ?? null;

  let textX = x;
  const imgY = baselineY - FLAG_CANVAS_H + 2;

  if(img){
    ctx.drawImage(img, x, imgY, FLAG_CANVAS_W, FLAG_CANVAS_H);
    textX = x + FLAG_CANVAS_W + FLAG_TEXT_GAP;
  }

  ctx.font = `${isWinner ? "900" : "700"} 17.5px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
  ctx.fillStyle = isWinner ? "rgba(255,255,255,1)" : "rgba(255,255,255,0.88)";
  ctx.fillText(ab, textX, baselineY);
}

/* ------------------------------
   Main builder (ASYNC)
------------------------------ */
function codeForName(name){
  if(!name) return "";
  const code = FLAG_CODE_BY_NAME[name];
  if(!code) return "";
  return code.toUpperCase();
}

function badgeTextForName(name){
  if(!name) return "---";
  return teamAbbrev(name);   // we only show ABBR in the brackets
}

    
async function buildResultsCanvas(){
  // A bit taller cards, still compact
  const W = 1000;
  const H = 760;

  const canvas = document.createElement("canvas");
  canvas.width = W;
  canvas.height = H;
  const ctx = canvas.getContext("2d");

  const firstName = ensureUserFirstName();

  // === Colorful background ===
  ctx.fillStyle = "#050814";
  ctx.fillRect(0,0,W,H);

  const glow1 = ctx.createRadialGradient(W*0.12, H*0.18, 40, W*0.12, H*0.18, W*0.55);
  glow1.addColorStop(0, "rgba(122,162,255,0.18)");
  glow1.addColorStop(1, "rgba(122,162,255,0)");
  ctx.fillStyle = glow1; ctx.fillRect(0,0,W,H);

  const glow2 = ctx.createRadialGradient(W*0.88, H*0.20, 40, W*0.88, H*0.20, W*0.55);
  glow2.addColorStop(0, "rgba(94,230,168,0.16)");
  glow2.addColorStop(1, "rgba(94,230,168,0)");
  ctx.fillStyle = glow2; ctx.fillRect(0,0,W,H);

  const glow3 = ctx.createRadialGradient(W*0.75, H*0.85, 40, W*0.75, H*0.85, W*0.60);
  glow3.addColorStop(0, "rgba(255,184,107,0.14)");
  glow3.addColorStop(1, "rgba(255,184,107,0)");
  ctx.fillStyle = glow3; ctx.fillRect(0,0,W,H);

  // === Title (left) ===
  ctx.font = "800 24px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillStyle = "rgba(255,255,255,0.96)";
  ctx.fillText(`${firstName}'s World Cup 2026 Knockout Prediction`, 32, 48);

  // === Compact match card geometry ===
  const boxW = 155;
  const boxH = 76;  // taller
  const rad = 11;

  const xR16 = 40;
  const xQF  = 240;
  const xSF  = 440;
  const xF2  = 660;

  const matchById = {};
  [...R16_MATCHES, ...QF_MATCHES, ...SF_MATCHES, ...THIRD_MATCH, ...FINAL_MATCH]
    .forEach(m => matchById[m.id] = m);

  function drawBoxFrame(x,y,w,h, accentColor){
    roundRectPath(ctx, x,y,w,h,rad);

    const g = ctx.createLinearGradient(x, y, x+w, y+h);
    g.addColorStop(0, "rgba(255,255,255,0.07)");
    g.addColorStop(1, "rgba(255,255,255,0.02)");
    ctx.fillStyle = g;
    ctx.fill();

    ctx.strokeStyle = "rgba(255,255,255,0.14)";
    ctx.lineWidth = 1.1;
    ctx.stroke();

    if(accentColor){
      ctx.fillStyle = accentColor;
      ctx.fillRect(x + w - 7, y + 8, 3, h - 16);
    }
  }

  function drawConnector(fromPos, toPos){
    const a = centerOf(fromPos);
    const b = centerOf(toPos);
    const midX = (a.cx + b.cx) / 2;

    ctx.strokeStyle = "rgba(122,162,255,0.22)";
    ctx.lineWidth = 2;

    ctx.beginPath();
    ctx.moveTo(a.cx + fromPos.w/2 - 6, a.cy);
    ctx.lineTo(midX, a.cy);
    ctx.lineTo(midX, b.cy);
    ctx.lineTo(b.cx - toPos.w/2 + 6, b.cy);
    ctx.stroke();
  }

  function winnerAccentForRound(label){
    if(label === "R16") return "rgba(94,230,255,0.45)";
    if(label === "QF")  return "rgba(122,162,255,0.50)";
    if(label === "SF")  return "rgba(255,184,107,0.55)";
    if(label === "FINAL") return "rgba(122,255,187,0.65)";
    if(label === "3RD PLACE") return "rgba(255,107,122,0.55)";
    return "rgba(94,230,168,0.45)";
  }


  function drawWinnerMarker(ctx, x, y){
        // subtle gold dot + thin ring
        ctx.beginPath();
        ctx.fillStyle = "rgba(255, 214, 102, 0.95)";
        ctx.arc(x, y - 5, 4, 0, Math.PI * 2);
        ctx.fill();
      
        ctx.strokeStyle = "rgba(255, 214, 102, 0.55)";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.arc(x, y - 5, 6, 0, Math.PI * 2);
        ctx.stroke();
      }

      function drawMatchBox(matchId, pos, labelPrefix){
        const match = matchById[matchId];
        if(!match) return;
      
        const p = resolveParticipants(match);
        const winner = state.winners?.[matchId]?.name ?? null;
      
        const accent = winner ? winnerAccentForRound(labelPrefix) : null;
        drawBoxFrame(pos.x, pos.y, pos.w, pos.h, accent);
      
        // Header: round + match + date/local time
        const info = INFO_BY_MATCH?.[matchId];
        const when = info ? formatLocalKickoff(info) : "Date/Time TBD";
      
        ctx.fillStyle = "rgba(255,255,255,0.72)";
        ctx.font = "800 9.4px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.fillText(`${labelPrefix} • ${matchId}`, pos.x + 9, pos.y + 13);
      
        ctx.fillStyle = "rgba(255,255,255,0.55)";
        ctx.font = "700 9px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.fillText(when, pos.x + 9, pos.y + 24);
      
        const leftIsWinner  = winner && winner === p.left.name;
        const rightIsWinner = winner && winner === p.right.name;
      
        // Text positions
        const leftY  = pos.y + 46;
        const rightY = pos.y + 64;
      
        // Winner marker positions
        const markerX = pos.x + pos.w - 16;
        if(leftIsWinner)  drawWinnerMarker(ctx, markerX, leftY);
        if(rightIsWinner) drawWinnerMarker(ctx, markerX, rightY);
      
        // Lines (FLAG + ABBR)
        drawFlagAndAbbr(ctx, p.left.name,  pos.x + 10, leftY,  leftIsWinner);
        drawFlagAndAbbr(ctx, p.right.name, pos.x + 10, rightY, rightIsWinner);
      }


  // IDs
  const matchIdsR16 = R16_MATCHES.map(m => m.id).slice().sort((a,b)=>a-b);
  const matchIdsQF  = QF_MATCHES.map(m => m.id).slice().sort((a,b)=>a-b);
  const matchIdsSF  = SF_MATCHES.map(m => m.id).slice().sort((a,b)=>a-b);
  const finalId = FINAL_MATCH[0]?.id; // 104
  const thirdId = THIRD_MATCH[0]?.id; // 103

    const idsToPreload = [
    ...matchIdsR16,
    ...matchIdsQF,
    ...matchIdsSF,
    ...(finalId ? [finalId] : []),
    ...(thirdId ? [thirdId] : [])
  ];
  await preloadFlagsForMatchIds(idsToPreload);

  // Base placement
  let posById = {};
  const topY = 98;
  const gapR16 = 78;

  matchIdsR16.forEach((id, i) => {
    posById[id] = { x: xR16, y: topY + i*gapR16, w: boxW, h: boxH };
  });

  matchIdsQF.forEach(id => {
    const m = matchById[id];
    const parents = [m.left, m.right].filter(s => s.type === "WM").map(s => s.id);
    if(parents.length === 2 && posById[parents[0]] && posById[parents[1]]){
      const y1 = centerOf(posById[parents[0]]).cy;
      const y2 = centerOf(posById[parents[1]]).cy;
      posById[id] = { x: xQF, y: (y1+y2)/2 - boxH/2, w: boxW, h: boxH };
    } else {
      posById[id] = { x: xQF, y: topY + 120, w: boxW, h: boxH };
    }
  });

  matchIdsSF.forEach(id => {
    const m = matchById[id];
    const parents = [m.left, m.right].filter(s => s.type === "WM").map(s => s.id);
    if(parents.length === 2 && posById[parents[0]] && posById[parents[1]]){
      const y1 = centerOf(posById[parents[0]]).cy;
      const y2 = centerOf(posById[parents[1]]).cy;
      posById[id] = { x: xSF, y: (y1+y2)/2 - boxH/2, w: boxW, h: boxH };
    } else {
      posById[id] = { x: xSF, y: topY + 220, w: boxW, h: boxH };
    }
  });

  if(finalId){
    const m = matchById[finalId];
    const parents = [m.left, m.right].filter(s => s.type === "WM").map(s => s.id);
    if(parents.length === 2 && posById[parents[0]] && posById[parents[1]]){
      const y1 = centerOf(posById[parents[0]]).cy;
      const y2 = centerOf(posById[parents[1]]).cy;
      posById[finalId] = { x: xF2, y: (y1+y2)/2 - boxH/2, w: boxW, h: boxH };
    } else {
      posById[finalId] = { x: xF2, y: topY + 260, w: boxW, h: boxH };
    }
  }

  if(thirdId){
    const baseY = finalId && posById[finalId] ? posById[finalId].y : (topY + 260);
    posById[thirdId] = { x: xF2, y: baseY + 200, w: boxW, h: boxH };
  }

  // === NEW: Post-Final Summary Blocks ===
  // These are visual-only boxes for clarity.
// === Summary Blocks ===
const SUMMARY_CHAMP_ID  = "summary-champ";
const SUMMARY_RUNNER_ID = "summary-runner";
const SUMMARY_THIRD_ID  = "summary-third";

function mkSummaryPos(anchorPos, fallbackY){
  const baseX = anchorPos ? (anchorPos.x + 210) : 890;
  const baseY = anchorPos ? (anchorPos.y - 6)   : fallbackY;
  return { x: baseX, y: baseY, w: 220, h: 70 };
}

const finalPos = finalId ? posById[finalId] : null;
const thirdPos = thirdId ? posById[thirdId] : null;

// Champion and Third anchored as before
posById[SUMMARY_CHAMP_ID] = mkSummaryPos(finalPos, 250);
posById[SUMMARY_THIRD_ID] = mkSummaryPos(thirdPos, 440);

// Runner-up sneaked between them (same column)
const champY = posById[SUMMARY_CHAMP_ID].y;
const thirdY = posById[SUMMARY_THIRD_ID].y;
posById[SUMMARY_RUNNER_ID] = {
  x: posById[SUMMARY_CHAMP_ID].x,
  y: Math.round((champY + thirdY) / 2),
  w: 220,
  h: 70
};

  // Pack/scale
  posById = normalizeLayout(posById, W, H);

  // Connectors
  matchIdsQF.forEach(qf => {
    const m = matchById[qf];
    [m.left, m.right].forEach(s => {
      if(s.type === "WM" && posById[s.id] && posById[qf]){
        drawConnector(posById[s.id], posById[qf]);
      }
    });
  });

  matchIdsSF.forEach(sf => {
    const m = matchById[sf];
    [m.left, m.right].forEach(s => {
      if(s.type === "WM" && posById[s.id] && posById[sf]){
        drawConnector(posById[s.id], posById[sf]);
      }
    });
  });

  if(finalId){
    const m = matchById[finalId];
    [m.left, m.right].forEach(s => {
      if(s.type === "WM" && posById[s.id] && posById[finalId]){
        drawConnector(posById[s.id], posById[finalId]);
      }
    });
  }

  if(thirdId){
    matchIdsSF.forEach(sf => {
      if(posById[sf] && posById[thirdId]){
        drawConnector(posById[sf], posById[thirdId]);
      }
    });
  }

  // Draw match boxes
  matchIdsR16.forEach(id => drawMatchBox(id, posById[id], "R16"));
  matchIdsQF.forEach(id  => drawMatchBox(id, posById[id], "QF"));
  matchIdsSF.forEach(id  => drawMatchBox(id, posById[id], "SF"));
  if(finalId) drawMatchBox(finalId, posById[finalId], "FINAL");
  if(thirdId) drawMatchBox(thirdId, posById[thirdId], "3RD PLACE");

  // === Draw summary blocks ===

  
function drawSummaryBox(pos, title, teamName, accent){
  drawBoxFrame(pos.x, pos.y, pos.w, pos.h, accent);

  // Title
  ctx.fillStyle = "rgba(255,255,255,0.80)";
  ctx.font = "900 12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText(title, pos.x + 12, pos.y + 20);

  // Flag image (local SVG cached as Image)
  const img = teamName ? (_flagCanvasCache.get(teamName) ?? null) : null;

  const flagW = 24;
  const flagH = 16;

  const flagX = pos.x + 12;

  // Name baseline - single anchor for alignment
  const nameBaselineY = pos.y + 52;

  // Place flag so it's visually centered against the text line
  // (tweak +1/-1 if your eyes want it tighter)
  const flagY = nameBaselineY - flagH + 2;

  // If flag exists, start text after it; otherwise start at left padding
  const textStartX = img ? (flagX + flagW + 8) : flagX;

  if(img){
    ctx.drawImage(img, flagX, flagY, flagW, flagH);
  }

  // Only full name
  const line = teamName || "TBD";

  ctx.fillStyle = "rgba(255,255,255,0.98)";
  ctx.font = "800 14.8px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText(line, textStartX, nameBaselineY);
}


  function drawChampionSummaryBox(pos, title, teamName){
  // Outer "margin"/halo frame
  ctx.save();
  ctx.shadowColor = "rgba(255, 214, 102, 0.45)";
  ctx.shadowBlur = 18;

  // Big outer rounded rect
  roundRectPath(ctx, pos.x - 8, pos.y - 8, pos.w + 16, pos.h + 16, 14);
  ctx.fillStyle = "rgba(255, 214, 102, 0.06)";
  ctx.fill();
  ctx.strokeStyle = "rgba(255, 214, 102, 0.65)";
  ctx.lineWidth = 2.2;
  ctx.stroke();
  ctx.restore();

  // Inner main box with strong green-gold accent
  drawSummaryBox(
    pos,
    title,
    teamName,
    "rgba(122,255,187,0.85)"
  );

  // Optional small crown-like tick mark
  ctx.save();
  ctx.fillStyle = "rgba(255, 214, 102, 0.95)";
  ctx.fillRect(pos.x + pos.w - 10, pos.y + 8, 4, pos.h - 16);
  ctx.restore();
}

  



      function getRunnerUpName(finalId){
      if(!finalId) return "";
      const match = matchById[finalId];
      if(!match) return "";
      const p = resolveParticipants(match);
      const winner = state.winners?.[finalId]?.name ?? "";
      const left = p.left?.name ?? "";
      const right = p.right?.name ?? "";
    
      if(!winner) return "";           // no winner selected
      if(winner && left && winner === left) return right;
      if(winner && right && winner === right) return left;
      return "";
    }

  

  const finalWinner = state.winners?.[104]?.name ?? "";
  const thirdWinner = state.winners?.[103]?.name ?? "";
  const runnerUp    = getRunnerUpName(finalId);

  // Draw summaries (Champion / Runner-up / 3rd)
  if(posById[SUMMARY_CHAMP_ID]){
    drawChampionSummaryBox(
      posById[SUMMARY_CHAMP_ID],
      "2026 FIFA WC CHAMPIONS",
      finalWinner || "TBD"
    );
  }


  if(posById[SUMMARY_RUNNER_ID]){
    drawSummaryBox(
      posById[SUMMARY_RUNNER_ID],
      "RUNNER-UP",
      runnerUp || "TBD",
      "rgba(122,162,255,0.65)"
    );
  }

 if(posById[SUMMARY_THIRD_ID]){
    drawSummaryBox(
      posById[SUMMARY_THIRD_ID],
      "3RD PLACE",
      thirdWinner || "TBD",
      "rgba(255,107,122,0.65)"
    );
  }




  // Legend
  ctx.fillStyle = "rgba(255,255,255,0.62)";
  ctx.font = "700 11.5px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText(
    "Legend: Match cards use 3-letter ABBR. Summary shows full team names.",
    32, H - 30
  );

  // Footer bottom-right
  const SITE_URL = getSiteUrlForImage();
  const rightPad = 32;

  ctx.textAlign = "right";

  ctx.fillStyle = "rgba(255,255,255,0.70)";
  ctx.font = "800 12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText("Source", W - rightPad, H - 90);

  ctx.fillStyle = "rgba(255,255,255,0.98)";
  ctx.font = "800 13.5px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText(SITE_SOURCE_NAME, W - rightPad, H - 72);

  ctx.fillStyle = "rgba(255,255,255,0.72)";
  ctx.font = "700 12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText("Get your predictions at:", W - rightPad, H - 52);

  ctx.fillStyle = "rgba(255,255,255,0.98)";
  ctx.font = "800 12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText(SITE_URL, W - rightPad, H - 32);

  const ts = new Date().toLocaleString();
  ctx.fillStyle = "rgba(255,255,255,0.50)";
  ctx.font = "700 10.5px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText(ts, W - rightPad, H - 12);

  ctx.textAlign = "start";

   // Footer (optional but nice)
  ctx.fillStyle = "rgba(255,255,255,0.45)";
  ctx.font = "700 10.5px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  const url = getSiteUrlForImage();
  ctx.fillText(SITE_SOURCE_NAME, 32, H - 26);
  if(url) ctx.fillText(url, 32, H - 12);

  return canvas;
}


/* ------------------------------
   View + Download (ASYNC)
------------------------------ */
async function downloadResultImage(){
  ensureUserFirstName();
  const canvas = await buildResultsCanvas();
  const a = document.createElement("a");
  a.href = canvas.toDataURL("image/png");
  a.download = "wc2026-prediction.png";
  document.body.appendChild(a);
  a.click();
  a.remove();
}

async function viewResultImage(){
  ensureUserFirstName();
  const canvas = await buildResultsCanvas();
  const url = canvas.toDataURL("image/png");
  showResultPreviewFromUrl(url);
}

/* ------------------------------
   Button wiring (robust)
------------------------------ */
function wireResultImageButtons(){
  const viewBtn =
    document.getElementById("viewResultBtn") ||
    document.getElementById("printViewBtn") ||
    document.getElementById("resultViewBtn");

  const dlBtn =
    document.getElementById("downloadResultBtn") ||
    document.getElementById("printDownloadBtn") ||
    document.getElementById("resultDownloadBtn");

  if(viewBtn) viewBtn.addEventListener("click", viewResultImage);
  if(dlBtn) dlBtn.addEventListener("click", downloadResultImage);
}





async function openPrintModal(){
  ensureUserFirstName();

  const backdrop = document.getElementById("printModalBackdrop");
  const img = document.getElementById("printPreviewImg");

  // ⬇⬇⬇ IMPORTANT: await the async canvas builder
  const canvas = await buildResultsCanvas();
  const dataUrl = canvas.toDataURL("image/png");

  img.src = dataUrl;
  img.dataset.url = dataUrl;

  backdrop.classList.add("show");
  backdrop.setAttribute("aria-hidden","false");
}


function viewPrintImage(){
  const img = document.getElementById("printPreviewImg");
  const url = img.dataset.url;
  if(!url) return;

  // ✅ Use in-page modal instead of window.open
  showResultPreviewFromUrl(url);
}


    function closePrintModal(){
      const backdrop = document.getElementById("printModalBackdrop");
      const img = document.getElementById("printPreviewImg");
      img.src = "";
      img.dataset.url = "";
      backdrop.classList.remove("show");
      backdrop.setAttribute("aria-hidden","true");
    }



    function downloadPrintImage(){
      const img = document.getElementById("printPreviewImg");
      const url = img.dataset.url;
      if(!url) return;

      const a = document.createElement("a");
      const stamp = new Date().toISOString().slice(0,10);
      a.href = url;
      a.download = `wc26-prediction-${stamp}.png`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }
    /* ==============================
       GROUP SCHEDULE MODAL LOGIC
    ============================== */
function renderGroupSchedule(groupKey){
  const container = document.getElementById("groupScheduleContent");
  const fixtures = getResolvedGroupFixtures(groupKey);


  if(!fixtures || !fixtures.length){
    container.innerHTML = '<div class="fixture-empty">No fixtures defined for this group yet.</div>';
    return;
  }

  let html = "";
  let currentDateHeader = null;

  fixtures.forEach(fix => {
    const { dateText: userDateText, timeText: userTimeText } = formatUserLocalForFixture(fix);

    // Day header (keep using official fixture date as the grouping key)
    if(fix.date !== currentDateHeader){
      currentDateHeader = fix.date;
      html += `<div class="fixture-day">${fix.date}</div>`;
    }

    html += `
      <div class="fixture-line">
        <div><strong>Match ${fix.match}</strong> — ${nameWithFlagHTML(resolveSlotTeam(fix.home))} vs ${nameWithFlagHTML(resolveSlotTeam(fix.away))}</div>
        <div>${fix.stadium}, ${fix.city}</div>
        <div>
          ${fix.localTime} (stadium)
          ${typeof fix.offsetHours === "number" ? ` · ${userTimeText} ${userDateText ? "(" + userDateText + ")" : ""} (your time)` : ""}
        </div>
      </div>
    `;
  });

  container.innerHTML = html;
}

    function openGroupScheduleModal(groupKey){
      const backdrop = document.getElementById("groupScheduleBackdrop");
      if(!backdrop) return;

      renderGroupSchedule(groupKey);

      backdrop.classList.add("show");
      backdrop.setAttribute("aria-hidden","false");
    }

    function closeGroupScheduleModal(){
      const backdrop = document.getElementById("groupScheduleBackdrop");
      if(!backdrop) return;
      backdrop.classList.remove("show");
      backdrop.setAttribute("aria-hidden","true");
    }

    /* ==============================
       28) Wire Buttons
    ============================== */
    let _globalKeydownWired = false;
    
    function wireButtons(){
      const resetBtn = document.getElementById("resetBtn");
      const clearMovedBtn = document.getElementById("clearMovedBtn");

      const reformBtn = document.getElementById("reformPoolBtn");
      const placeBtn = document.getElementById("placeQualifiersBtn");
      const autoPoolsBtn = document.getElementById("autoPoolsBtn");

      const autoGroupsBtn = document.getElementById("autoGroupsBtn");
      const autoThirdBtn = document.getElementById("autoThirdBtn");

      const regenerateR32Btn = document.getElementById("regenerateR32Btn");
      const autoR32Btn = document.getElementById("autoR32Btn");
      const autoR16Btn = document.getElementById("autoR16Btn");
      const autoQFBtn = document.getElementById("autoQFBtn");
      const autoSFBtn = document.getElementById("autoSFBtn");
      const autoThirdMatchBtn = document.getElementById("autoThirdMatchBtn");
      const autoFinalBtn = document.getElementById("autoFinalBtn");

      const printBtn = document.getElementById("printResultsBtn");

      const closeModalBtn = document.getElementById("closePrintModal");
      const backdrop = document.getElementById("printModalBackdrop");
      const viewBtn = document.getElementById("viewPrintImgBtn");
      const dlBtn = document.getElementById("downloadPrintImgBtn");

      const groupScheduleBackdrop = document.getElementById("groupScheduleBackdrop");
      const closeGroupScheduleBtn = document.getElementById("closeGroupScheduleModal");


      if(clearMovedBtn){
        clearMovedBtn.addEventListener("click", clearAllUserMoved);
      }

      if(placeBtn){
        placeBtn.addEventListener("click", () => {
          if(editMode !== "pools") return;
          placeQualifiersToGroups();
        });
      }



      if(reformBtn){
        reformBtn.addEventListener("click", () => reformPoolMode());
      }

      if(resetBtn){
        resetBtn.addEventListener("click", () => {
      
        // Reset ALL state
        state = initialState();
      
        // Reset globals
        editMode = "pools";
        swapSelection = null;
        qualifiedThirdGroupLetters = "";
        qualifiedThirdPlacedTeams = [];
        thirdRankingDirty = false;

          buildBoard();
          render();
          wireButtons();
        });
      }

      if(autoPoolsBtn) autoPoolsBtn.addEventListener("click", autoPools);
      if(autoGroupsBtn) autoGroupsBtn.addEventListener("click", autoGroups);
      if(autoThirdBtn) autoThirdBtn.addEventListener("click", autoThirdRanking);

      if(regenerateR32Btn){
        regenerateR32Btn.addEventListener("click", regenerateR32);
      }

      if(autoR32Btn){
        autoR32Btn.addEventListener("click", () => {
          if(!state.r32Generated) regenerateR32();
          autoRound(R32_MATCHES);
        });
      }

      if(autoR16Btn) autoR16Btn.addEventListener("click", () => autoRound(R16_MATCHES));
      if(autoQFBtn)  autoQFBtn.addEventListener("click", () => autoRound(QF_MATCHES));
      if(autoSFBtn)  autoSFBtn.addEventListener("click", () => autoRound(SF_MATCHES));
      if(autoThirdMatchBtn) autoThirdMatchBtn.addEventListener("click", () => autoRound(THIRD_MATCH));
      if(autoFinalBtn) autoFinalBtn.addEventListener("click", () => autoRound(FINAL_MATCH));

      /* ✅ Print result */
      if(printBtn){
       printBtn.addEventListener("click", async () => {
              if(!state.winners[104]) return;
              await openPrintModal();
            });

      }

      /* Modal controls */
      if(closeModalBtn) closeModalBtn.addEventListener("click", closePrintModal);
      if(viewBtn) viewBtn.addEventListener("click", viewPrintImage);
      if(dlBtn) dlBtn.addEventListener("click", downloadPrintImage);

      // click outside dialog to close
      if(backdrop){
        backdrop.addEventListener("click", (e) => {
          if(e.target === backdrop) closePrintModal();
        });
      }

      // ESC
          // ESC closes any open modal (print or group schedule)
if(!_globalKeydownWired){
  document.addEventListener("keydown", (e) => {
    if(e.key !== "Escape") return;
    // close modals...
  });
  _globalKeydownWired = true;
}


        const isPrintOpen = backdrop?.classList.contains("show");
        if(isPrintOpen) closePrintModal();

        const isGroupOpen = groupScheduleBackdrop?.classList.contains("show");
        if(isGroupOpen) closeGroupScheduleModal();
      });


            /* Group expand buttons on Group columns */
      document.querySelectorAll(".group-expand-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const g = btn.getAttribute("data-group");
          if(!g) return;
          openGroupScheduleModal(g);
        });
      });

      /* Group schedule modal controls */
      if(closeGroupScheduleBtn){
        closeGroupScheduleBtn.addEventListener("click", closeGroupScheduleModal);
      }
      if(groupScheduleBackdrop){
        groupScheduleBackdrop.addEventListener("click", (e) => {
          if(e.target === groupScheduleBackdrop){
            closeGroupScheduleModal();
          }
        });
      }


      wireResultImageButtons();

    }

    /* ==============================
       29) Render orchestrator
    ============================== */
    function render(){
      syncThirdRankingNames();
      renderStandardZones();
      renderAllKo();
      updateRegenerateR32Badge();

      const reformBtn = document.getElementById("reformPoolBtn");
      const placeBtn  = document.getElementById("placeQualifiersBtn");
      const printBtn  = document.getElementById("printResultsBtn");

      if(reformBtn) reformBtn.disabled = (editMode === "pools");
      if(placeBtn)  placeBtn.disabled  = (editMode !== "pools");

      // ✅ Enable print only after final winner
      if(printBtn){
        printBtn.disabled = !state.winners[104];
      }
    }

    /* ==============================
       30) Boot
    ============================== */
    document.addEventListener("DOMContentLoaded", () => {
      buildBoard();
      render();
      wireButtons();
    });
  </script>
</body>
</html>
