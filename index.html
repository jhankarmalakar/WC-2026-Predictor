<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>2026 World Cup Mini Predictor (Groups + 3rd Rank + R32)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1220;
      --panel:#151a2e;
      --panel-2:#111527;
      --text:#f5f7ff;
      --muted:#b9c0e6;
      --accent:#7aa2ff;
      --good:#5ee6a8;
      --warn:#ffb86b;
      --bad:#ff6b7a;
      --border:rgba(255,255,255,0.08);
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 14px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 10% -10%, #1b2350 0%, transparent 55%),
                  radial-gradient(900px 700px at 110% 10%, #1a3a4d 0%, transparent 50%),
                  var(--bg);
      color:var(--text);
    }
    header{
      padding: 28px 22px 10px;
      max-width: 1200px;
      margin: 0 auto;
    }
    h1{
      font-size: 28px;
      margin: 0 0 6px 0;
      letter-spacing: 0.2px;
    }
    .sub{
      color: var(--muted);
      font-size: 14px;
      line-height: 1.4;
    }
    .container{
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 22px 60px;
      display: grid;
      gap: 18px;
    }

    .panel{
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px 16px 12px;
    }

    .row{
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items:center;
      justify-content: space-between;
    }

    .btn{
      appearance:none;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 12.5px;
      cursor:pointer;
      transition: 0.15s ease;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,0.18); }
    .btn:active{ transform: translateY(0px); }

    .btn.accent{
      background: linear-gradient(90deg, rgba(122,162,255,0.18), rgba(122,162,255,0.05));
      border-color: rgba(122,162,255,0.35);
    }

    .btn.good{
      background: linear-gradient(90deg, rgba(94,230,168,0.18), rgba(94,230,168,0.05));
      border-color: rgba(94,230,168,0.35);
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      border: 1px solid var(--border);
      color: var(--muted);
      background: rgba(255,255,255,0.04);
    }
    .badge.warn{ color: #ffd3a6; border-color: rgba(255,184,107,0.35); }
    .badge.good{ color: #c9ffe6; border-color: rgba(94,230,168,0.35); }

    /* Groups grid */
    .groups-grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(240px, 1fr));
      gap: 14px;
    }
    @media (max-width: 1100px){
      .groups-grid{ grid-template-columns: repeat(3, minmax(240px, 1fr)); }
    }
    @media (max-width: 820px){
      .groups-grid{ grid-template-columns: repeat(2, minmax(240px, 1fr)); }
    }
    @media (max-width: 520px){
      .groups-grid{ grid-template-columns: 1fr; }
    }

    .group-card h3{
      margin: 2px 0 10px;
      font-size: 16px;
      letter-spacing: 0.3px;
    }

    .team-list{
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 8px;
    }
    .team-item{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 8px 8px;
      border-radius: 10px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      cursor: grab;
    }
    .team-item.dragging{
      opacity: 0.5;
      background: rgba(122,162,255,0.12);
      border-color: rgba(122,162,255,0.5);
    }
    .team-item .handle{
      width: 14px;
      height: 14px;
      border-radius: 3px;
      background:
        linear-gradient(90deg, rgba(255,255,255,0.25) 0 30%, transparent 30% 40%, rgba(255,255,255,0.25) 40% 70%, transparent 70% 80%, rgba(255,255,255,0.25) 80% 100%);
      opacity: 0.6;
      flex: 0 0 auto;
    }
    .flag{
      font-size: 18px;
      width: 22px;
      text-align:center;
      flex: 0 0 auto;
    }
    .team-name{
      flex:1 1 auto;
      min-width: 0;
    }
    .team-name input{
      width: 100%;
      background: transparent;
      border: 1px solid transparent;
      color: var(--text);
      font-size: 13.5px;
      padding: 4px 6px;
      border-radius: 6px;
    }
    .team-name input:focus{
      outline:none;
      border-color: rgba(122,162,255,0.5);
      background: rgba(255,255,255,0.05);
    }

    .pos-tag{
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 6px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: rgba(255,255,255,0.04);
      flex: 0 0 auto;
    }

    /* Third place panel layout */
    .third-grid{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 14px;
    }
    @media (max-width: 900px){
      .third-grid{ grid-template-columns: 1fr; }
    }

    .third-list{
      list-style:none;
      padding:0;
      margin:0;
      display:grid;
      gap: 8px;
    }
    .third-item{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 8px 8px;
      border-radius: 10px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
      cursor: grab;
    }
    .third-item.dragging{
      opacity: 0.5;
      background: rgba(122,162,255,0.12);
      border-color: rgba(122,162,255,0.5);
    }
    .third-code{
      font-weight: 700;
      font-size: 11.5px;
      color: var(--accent);
      min-width: 32px;
    }
    .third-name{
      flex:1;
      font-size: 13.5px;
    }
    .third-meta{
      font-size: 10px;
      color: var(--muted);
      padding-left: 6px;
    }

    /* Qualified overview */
    .qual-grid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 900px){
      .qual-grid{ grid-template-columns: 1fr; }
    }
    .qual-box{
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 10px 6px;
      background: rgba(255,255,255,0.03);
    }
    .qual-box h4{
      margin: 0 0 8px 0;
      font-size: 13.5px;
      color: var(--muted);
      font-weight: 650;
      letter-spacing: 0.2px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      padding: 5px 8px;
      border-radius: 999px;
      margin: 0 6px 6px 0;
      font-size: 11.5px;
      white-space: nowrap;
    }
    .pill.good{ border-color: rgba(94,230,168,0.5); }
    .pill.warn{ border-color: rgba(255,184,107,0.5); }
    .pill .flag{ font-size: 14px; width: auto; }

    /* Mapping textarea */
    textarea{
      width: 100%;
      min-height: 160px;
      resize: vertical;
      background: rgba(255,255,255,0.04);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 11.5px;
      line-height: 1.35;
    }
    textarea:focus{
      outline:none;
      border-color: rgba(122,162,255,0.5);
    }

    /* R32 table */
    .r32-table{
      width: 100%;
      border-collapse: collapse;
      font-size: 12.5px;
      overflow: hidden;
      border-radius: 12px;
    }
    .r32-table th, .r32-table td{
      border-bottom: 1px solid var(--border);
      padding: 9px 10px;
      vertical-align: middle;
    }
    .r32-table thead th{
      text-align:left;
      font-size: 11px;
      letter-spacing: 0.4px;
      text-transform: uppercase;
      color: var(--muted);
      background: rgba(255,255,255,0.04);
    }
    .r32-table tr:last-child td{ border-bottom: none; }
    .match-id{
      color: var(--muted);
      font-weight: 700;
      width: 72px;
    }
    .slot{
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .slot small{
      color: var(--muted);
      font-weight: 600;
      font-size: 10px;
    }

    .note{
      color: var(--muted);
      font-size: 11.5px;
      line-height: 1.4;
    }
    .note strong{ color: var(--text); }

    .divider{
      height: 1px;
      background: var(--border);
      margin: 10px 0 8px;
    }
  </style>
</head>
<body>
<header>
  <h1>2026 World Cup Mini Predictor</h1>
  <div class="sub">
    Drag to set group rankings, rank all 3rd-place teams, then generate a Round of 32 table.
    Flags are automatic for known countries; playoff/undecided entries show üè≥Ô∏è.
  </div>
</header>

<div class="container">

  <!-- GROUPS -->
  <section class="panel">
    <div class="row">
      <div>
        <span class="badge good">Step 1</span>
        <span class="badge">Drag teams inside each group</span>
      </div>
      <div class="row">
        <button class="btn" id="resetGroupsBtn">Reset to draw order</button>
        <button class="btn accent" id="rebuildThirdBtn">Refresh 3rd-place list</button>
      </div>
    </div>
    <div class="divider"></div>
    <div id="groupsGrid" class="groups-grid"></div>
  </section>

  <!-- THIRD PLACE + QUALIFIED SNAPSHOT -->
  <section class="panel">
    <div class="row">
      <div>
        <span class="badge good">Step 2</span>
        <span class="badge">Rank 3rd-place teams overall</span>
      </div>
      <div class="row">
        <span id="thirdStatus" class="badge"></span>
      </div>
    </div>
    <div class="divider"></div>

    <div class="third-grid">
      <div>
        <h3 style="margin:0 0 8px 0; font-size:16px;">3rd-place ranking (drag to order)</h3>
        <div class="note">
          This list is auto-built from your group orders.
          Each entry keeps its original group label (3A, 3B, ...).
        </div>
        <div style="height:10px"></div>
        <ul id="thirdList" class="third-list"></ul>
      </div>

      <div>
        <h3 style="margin:0 0 8px 0; font-size:16px;">Qualification snapshot</h3>
        <div class="qual-grid">
          <div class="qual-box">
            <h4>Group winners (1st)</h4>
            <div id="winnersPills"></div>
          </div>
          <div class="qual-box">
            <h4>Group runners-up (2nd)</h4>
            <div id="runnersPills"></div>
          </div>
          <div class="qual-box">
            <h4>Top 8 third-place qualifiers</h4>
            <div id="third8Pills"></div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="note">
          The Round of 32 for the 48-team format uses 12 group winners, 12 runners-up,
          and the best 8 third-place teams. :contentReference[oaicite:2]{index=2}
        </div>
      </div>
    </div>
  </section>

  <!-- R32 GENERATOR -->
  <section class="panel">
    <div class="row">
      <div>
        <span class="badge good">Step 3</span>
        <span class="badge">Round of 32 generator</span>
      </div>
      <div class="row">
        <button class="btn" id="loadExampleMappingBtn">Load tiny example JSON</button>
        <button class="btn good" id="generateR32Btn">Generate R32</button>
      </div>
    </div>
    <div class="divider"></div>

    <div class="note">
      The official bracket assigns the 8 qualifying third-place teams to specific matches based on
      which groups those third-place teams come from. The match placeholders below follow the published bracket
      (e.g., Winner Group E vs 3rd Group A/B/C/D/F, etc.). :contentReference[oaicite:3]{index=3}
      <br><br>
      Paste your full JSON mapping if you have it. If a key is missing, this app uses a <strong>greedy fallback</strong>
      that may not match the official FIFA allocation.
    </div>

    <div style="height:10px"></div>

    <label class="note"><strong>Third-place allocation mapping (JSON)</strong></label>
    <textarea id="mappingInput" spellcheck="false"></textarea>

    <div class="row" style="margin-top:10px">
      <span id="mappingStatus" class="badge"></span>
      <span class="note">Key format: the 8 qualifying 3rd-place group letters sorted, e.g. <strong>"BCEFGHJL"</strong>.</span>
    </div>

    <div class="divider"></div>

    <h3 style="margin:0 0 8px 0; font-size:16px;">Round of 32</h3>
    <table class="r32-table">
      <thead>
        <tr>
          <th>Match</th>
          <th>Home</th>
          <th>Away</th>
          <th>Source slots</th>
        </tr>
      </thead>
      <tbody id="r32Body"></tbody>
    </table>
  </section>

</div>

<script>
/* =========================================================
   DEFAULT DATA (based on widely reported draw listings)
   You can edit names freely in the UI.
   ========================================================= */

const DEFAULT_GROUPS = {
  A: [
    "Mexico",
    "South Africa",
    "South Korea",
    "European Playoff D"
  ],
  B: [
    "Canada",
    "European Playoff A",
    "Qatar",
    "Switzerland"
  ],
  C: [
    "Brazil",
    "Morocco",
    "Haiti",
    "Scotland"
  ],
  D: [
    "United States",
    "Paraguay",
    "Australia",
    "European Playoff C"
  ],
  E: [
    "Germany",
    "Cura√ßao",
    "Ivory Coast",
    "Ecuador"
  ],
  F: [
    "Netherlands",
    "Japan",
    "European Playoff B",
    "Tunisia"
  ],
  G: [
    "Belgium",
    "Egypt",
    "Iran",
    "New Zealand"
  ],
  H: [
    "Spain",
    "Cape Verde",
    "Saudi Arabia",
    "Uruguay"
  ],
  I: [
    "France",
    "Senegal",
    "FIFA Intercontinental Playoff Tournament 2",
    "Norway"
  ],
  J: [
    "Argentina",
    "Algeria",
    "Austria",
    "Jordan"
  ],
  K: [
    "Portugal",
    "FIFA Intercontinental Playoff Tournament 1",
    "Uzbekistan",
    "Colombia"
  ],
  L: [
    "England",
    "Croatia",
    "Ghana",
    "Panama"
  ]
};

/* =========================================================
   FLAG HELPERS
   ========================================================= */

const NAME_TO_ISO = {
  "Mexico":"MX",
  "South Africa":"ZA",
  "South Korea":"KR",
  "Korea Republic":"KR",
  "Denmark":"DK",
  "North Macedonia":"MK",
  "Czechia":"CZ",
  "Czech Republic":"CZ",
  "Ireland":"IE",
  "Canada":"CA",
  "Italy":"IT",
  "Northern Ireland":"GB", // neutral-ish; no separate emoji
  "Wales":"GB",
  "Bosnia & Herzegovina":"BA",
  "Bosnia and Herzegovina":"BA",
  "Qatar":"QA",
  "Switzerland":"CH",
  "Brazil":"BR",
  "Morocco":"MA",
  "Haiti":"HT",
  "Scotland":"GB",
  "United States":"US",
  "USA":"US",
  "Paraguay":"PY",
  "Australia":"AU",
  "T√ºrkiye":"TR",
  "Turkey":"TR",
  "Romania":"RO",
  "Slovakia":"SK",
  "Kosovo":"XK",
  "Germany":"DE",
  "Cura√ßao":"CW",
  "Ivory Coast":"CI",
  "C√¥te d‚ÄôIvoire":"CI",
  "Ecuador":"EC",
  "Netherlands":"NL",
  "Holland":"NL",
  "Japan":"JP",
  "Ukraine":"UA",
  "Sweden":"SE",
  "Poland":"PL",
  "Albania":"AL",
  "Tunisia":"TN",
  "Belgium":"BE",
  "Egypt":"EG",
  "Iran":"IR",
  "New Zealand":"NZ",
  "Spain":"ES",
  "Cape Verde":"CV",
  "Saudi Arabia":"SA",
  "Uruguay":"UY",
  "France":"FR",
  "Senegal":"SN",
  "Norway":"NO",
  "Argentina":"AR",
  "Algeria":"DZ",
  "Austria":"AT",
  "Jordan":"JO",
  "Portugal":"PT",
  "Uzbekistan":"UZ",
  "Colombia":"CO",
  "England":"GB",
  "Croatia":"HR",
  "Ghana":"GH",
  "Panama":"PA",
  "Jamaica":"JM",
  "New Caledonia":"NC",
  "DR Congo":"CD",
  "Democratic Republic of the Congo":"CD",
  "Bolivia":"BO",
  "Suriname":"SR",
  "Iraq":"IQ"
};

function isoToFlag(iso){
  if(!iso || iso.length !== 2) return "üè≥Ô∏è";
  const code = iso.toUpperCase();
  const A = 0x1F1E6;
  const base = "A".charCodeAt(0);
  const c1 = code.charCodeAt(0) - base + A;
  const c2 = code.charCodeAt(1) - base + A;
  return String.fromCodePoint(c1, c2);
}

function isPlayoffName(name){
  return /playoff|intercontinental|tournament/i.test(name);
}

function flagForName(name){
  if(!name) return "üè≥Ô∏è";
  if(isPlayoffName(name)) return "üè≥Ô∏è";
  const iso = NAME_TO_ISO[name.trim()];
  if(!iso) return "üè≥Ô∏è";
  return isoToFlag(iso);
}

/* =========================================================
   STATE
   ========================================================= */

let groupsState = deepClone(DEFAULT_GROUPS);
let thirdOrderState = []; // array of objects {group, name}

/* =========================================================
   DOM HOOKS
   ========================================================= */

const groupsGrid = document.getElementById("groupsGrid");
const thirdList = document.getElementById("thirdList");

const winnersPills = document.getElementById("winnersPills");
const runnersPills = document.getElementById("runnersPills");
const third8Pills = document.getElementById("third8Pills");

const resetGroupsBtn = document.getElementById("resetGroupsBtn");
const rebuildThirdBtn = document.getElementById("rebuildThirdBtn");

const mappingInput = document.getElementById("mappingInput");
const generateR32Btn = document.getElementById("generateR32Btn");
const loadExampleMappingBtn = document.getElementById("loadExampleMappingBtn");
const mappingStatus = document.getElementById("mappingStatus");
const thirdStatus = document.getElementById("thirdStatus");
const r32Body = document.getElementById("r32Body");

/* =========================================================
   RENDER GROUPS
   ========================================================= */

function renderGroups(){
  groupsGrid.innerHTML = "";
  const letters = Object.keys(groupsState);

  letters.forEach(letter => {
    const card = document.createElement("div");
    card.className = "panel group-card";
    card.style.padding = "12px 12px 10px";

    const h = document.createElement("h3");
    h.textContent = `Group ${letter}`;
    card.appendChild(h);

    const ul = document.createElement("ul");
    ul.className = "team-list";
    ul.dataset.group = letter;

    groupsState[letter].forEach((team, idx) => {
      const li = makeTeamItem(letter, team, idx);
      ul.appendChild(li);
    });

    // Enable drag sorting within group list
    enableSortableList(ul, onGroupReorder);

    card.appendChild(ul);
    groupsGrid.appendChild(card);
  });
}

function makeTeamItem(groupLetter, teamName, idx){
  const li = document.createElement("li");
  li.className = "team-item";
  li.draggable = true;
  li.dataset.group = groupLetter;

  const handle = document.createElement("span");
  handle.className = "handle";

  const flag = document.createElement("span");
  flag.className = "flag";
  flag.textContent = flagForName(teamName);

  const nameWrap = document.createElement("span");
  nameWrap.className = "team-name";

  const input = document.createElement("input");
  input.type = "text";
  input.value = teamName;
  input.addEventListener("input", () => {
    // Update state
    const list = groupsState[groupLetter];
    const index = Array.from(li.parentElement.children).indexOf(li);
    list[index] = input.value.trim();
    flag.textContent = flagForName(input.value.trim());
    rebuildThirdFromGroups(false);
    renderQualificationSnapshot();
  });

  nameWrap.appendChild(input);

  const pos = document.createElement("span");
  pos.className = "pos-tag";
  pos.textContent = `#${idx+1}`;

  li.appendChild(handle);
  li.appendChild(flag);
  li.appendChild(nameWrap);
  li.appendChild(pos);

  return li;
}

function refreshGroupPositionTags(){
  document.querySelectorAll(".team-list").forEach(ul => {
    Array.from(ul.children).forEach((li, i) => {
      const tag = li.querySelector(".pos-tag");
      if(tag) tag.textContent = `#${i+1}`;
    });
  });
}

/* =========================================================
   SORTABLE LIST (HTML5 DnD)
   ========================================================= */

function enableSortableList(listEl, onUpdate){
  let dragged = null;

  listEl.addEventListener("dragstart", e => {
    const li = e.target.closest("li");
    if(!li) return;
    dragged = li;
    li.classList.add("dragging");
    e.dataTransfer.effectAllowed = "move";
  });

  listEl.addEventListener("dragend", e => {
    const li = e.target.closest("li");
    if(li) li.classList.remove("dragging");
    dragged = null;
  });

  listEl.addEventListener("dragover", e => {
    e.preventDefault();
    const after = getDragAfterElement(listEl, e.clientY);
    if(!dragged) return;
    if(after == null){
      listEl.appendChild(dragged);
    } else {
      listEl.insertBefore(dragged, after);
    }
  });

  listEl.addEventListener("drop", e => {
    e.preventDefault();
    if(typeof onUpdate === "function") onUpdate(listEl);
  });
}

function getDragAfterElement(container, y){
  const els = [...container.querySelectorAll("li:not(.dragging)")];
  return els.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
    if(offset < 0 && offset > closest.offset){
      return { offset, element: child };
    } else {
      return closest;
    }
  }, { offset: Number.NEGATIVE_INFINITY }).element;
}

/* =========================================================
   GROUP REORDER HANDLER
   ========================================================= */

function onGroupReorder(ul){
  const groupLetter = ul.dataset.group;
  const newOrder = Array.from(ul.querySelectorAll("input")).map(i => i.value.trim());
  groupsState[groupLetter] = newOrder;

  // Rebuild LI position tags
  refreshGroupPositionTags();

  // Update third list
  rebuildThirdFromGroups(false);
  renderQualificationSnapshot();
}

/* =========================================================
   THIRD PLACE LIST
   ========================================================= */

function rebuildThirdFromGroups(resetOrder = true){
  const letters = Object.keys(groupsState).sort();
  const thirds = letters.map(letter => {
    const team = groupsState[letter][2] || "";
    return { group: letter, name: team };
  });

  if(resetOrder || thirdOrderState.length === 0){
    thirdOrderState = thirds;
  } else {
    // preserve existing order where possible by group id
    const byGroup = new Map(thirds.map(t => [t.group, t]));
    thirdOrderState = thirdOrderState.map(old => byGroup.get(old.group) || old);
  }

  renderThirdList();
  updateThirdStatus();
}

function renderThirdList(){
  thirdList.innerHTML = "";
  thirdOrderState.forEach(item => {
    const li = document.createElement("li");
    li.className = "third-item";
    li.draggable = true;
    li.dataset.group = item.group;

    const handle = document.createElement("span");
    handle.className = "handle";

    const flag = document.createElement("span");
    flag.className = "flag";
    flag.textContent = flagForName(item.name);

    const code = document.createElement("span");
    code.className = "third-code";
    code.textContent = `3${item.group}`;

    const name = document.createElement("span");
    name.className = "third-name";
    name.textContent = item.name || "TBD";

    const meta = document.createElement("span");
    meta.className = "third-meta";
    meta.textContent = `from Group ${item.group}`;

    li.appendChild(handle);
    li.appendChild(flag);
    li.appendChild(code);
    li.appendChild(name);
    li.appendChild(meta);

    thirdList.appendChild(li);
  });

  enableSortableList(thirdList, onThirdReorder);
  renderQualificationSnapshot();
}

function onThirdReorder(ul){
  thirdOrderState = Array.from(ul.querySelectorAll("li")).map(li => {
    const group = li.dataset.group;
    // rebuild name from current group third (authoritative)
    const name = (groupsState[group] && groupsState[group][2]) ? groupsState[group][2] : "";
    return { group, name };
  });

  renderThirdList(); // refresh text + flags
}

function updateThirdStatus(){
  const top8 = getTop8Thirds();
  const key = top8.map(t => t.group).sort().join("");
  thirdStatus.textContent = top8.length === 8
    ? `Top-8 third groups: ${key}`
    : `Waiting for 3rd-place list`;
}

/* =========================================================
   QUALIFICATION SNAPSHOT
   ========================================================= */

function getWinners(){
  return Object.keys(groupsState).sort().map(g => ({ group:g, name: groupsState[g][0] || "" }));
}
function getRunners(){
  return Object.keys(groupsState).sort().map(g => ({ group:g, name: groupsState[g][1] || "" }));
}
function getThirds(){
  return Object.keys(groupsState).sort().map(g => ({ group:g, name: groupsState[g][2] || "" }));
}
function getTop8Thirds(){
  // Use thirdOrderState order
  return thirdOrderState.slice(0, 8).filter(t => t && t.group);
}

function renderQualificationSnapshot(){
  winnersPills.innerHTML = "";
  runnersPills.innerHTML = "";
  third8Pills.innerHTML = "";

  getWinners().forEach(t => winnersPills.appendChild(makePill(`1${t.group}`, t.name, "good")));
  getRunners().forEach(t => runnersPills.appendChild(makePill(`2${t.group}`, t.name, "")));

  getTop8Thirds().forEach((t, i) => {
    const cls = i < 8 ? "warn" : "";
    third8Pills.appendChild(makePill(`3${t.group}`, t.name, cls));
  });

  updateThirdStatus();
}

function makePill(code, name, cls){
  const span = document.createElement("span");
  span.className = `pill ${cls || ""}`;
  const flag = document.createElement("span");
  flag.className = "flag";
  flag.textContent = flagForName(name);
  const txt = document.createElement("span");
  txt.innerHTML = `<strong>${code}</strong> ${escapeHtml(name || "TBD")}`;
  span.appendChild(flag);
  span.appendChild(txt);
  return span;
}

/* =========================================================
   R32 STRUCTURE (per bracket placeholders)
   Matches 73-88
   ========================================================= */

const THIRD_MATCHES = [
  { matchId: 74, winnerGroup: "E", candidates: ["A","B","C","D","F"] },
  { matchId: 77, winnerGroup: "I", candidates: ["C","D","F","G","H"] },
  { matchId: 79, winnerGroup: "A", candidates: ["C","E","F","H","I"] },
  { matchId: 80, winnerGroup: "L", candidates: ["E","H","I","J","K"] },
  { matchId: 81, winnerGroup: "D", candidates: ["B","E","F","I","J"] },
  { matchId: 82, winnerGroup: "G", candidates: ["A","E","H","I","J"] },
  { matchId: 85, winnerGroup: "B", candidates: ["E","F","G","I","J"] },
  { matchId: 87, winnerGroup: "K", candidates: ["D","E","I","J","L"] }
];

const R32_TEMPLATE = [
  { matchId: 73, home: {type:"runner", group:"A"}, away:{type:"runner", group:"B"} },
  { matchId: 74, home: {type:"winner", group:"E"}, away:{type:"third", matchId:74} },
  { matchId: 75, home: {type:"winner", group:"F"}, away:{type:"runner", group:"C"} },
  { matchId: 76, home: {type:"winner", group:"C"}, away:{type:"runner", group:"F"} },
  { matchId: 77, home: {type:"winner", group:"I"}, away:{type:"third", matchId:77} },
  { matchId: 78, home: {type:"runner", group:"E"}, away:{type:"runner", group:"I"} },
  { matchId: 79, home: {type:"winner", group:"A"}, away:{type:"third", matchId:79} },
  { matchId: 80, home: {type:"winner", group:"L"}, away:{type:"third", matchId:80} },
  { matchId: 81, home: {type:"winner", group:"D"}, away:{type:"third", matchId:81} },
  { matchId: 82, home: {type:"winner", group:"G"}, away:{type:"third", matchId:82} },
  { matchId: 83, home: {type:"runner", group:"K"}, away:{type:"runner", group:"L"} },
  { matchId: 84, home: {type:"winner", group:"H"}, away:{type:"runner", group:"J"} },
  { matchId: 85, home: {type:"winner", group:"B"}, away:{type:"third", matchId:85} },
  { matchId: 86, home: {type:"winner", group:"J"}, away:{type:"runner", group:"H"} },
  { matchId: 87, home: {type:"winner", group:"K"}, away:{type:"third", matchId:87} },
  { matchId: 88, home: {type:"runner", group:"D"}, away:{type:"runner", group:"G"} }
];

/* =========================================================
   THIRD-PLACE ALLOCATION LOGIC
   JSON mapping format (flexible):
   {
     "BCEFGHJL": {
        "74":"J",
        "77":"F",
        "79":"I",
        "80":"E",
        "81":"H",
        "82":"G",
        "85":"L",
        "87":"K"
     }
   }
   You may also use keys like "1E","1I"... etc; both supported.
   ========================================================= */

function parseMapping(){
  const txt = mappingInput.value.trim();
  if(!txt){
    mappingStatus.textContent = "No JSON provided (will use fallback)";
    mappingStatus.className = "badge warn";
    return {};
  }
  try{
    const obj = JSON.parse(txt);
    mappingStatus.textContent = "JSON loaded";
    mappingStatus.className = "badge good";
    return obj;
  }catch(e){
    mappingStatus.textContent = "Invalid JSON (fallback only)";
    mappingStatus.className = "badge warn";
    return {};
  }
}

function getThirdAllocation(mappingObj){
  const top8 = getTop8Thirds();
  const key = top8.map(t => t.group).sort().join("");
  const entry = mappingObj[key];

  // Build dictionary matchId -> groupLetter
  const allocation = {};
  let usedFallback = false;

  if(entry && typeof entry === "object"){
    THIRD_MATCHES.forEach(tm => {
      const id = String(tm.matchId);
      const byId = entry[id];
      const bySlot = entry[`1${tm.winnerGroup}`];
      const byMatch = entry[`M${tm.matchId}`];

      const chosen = byId || bySlot || byMatch;
      if(chosen) allocation[tm.matchId] = String(chosen).toUpperCase();
    });
  }

  // If allocation incomplete, fill via greedy fallback
  const assigned = new Set(Object.values(allocation));
  const availableThirds = top8.slice(); // order preference = your ranking

  THIRD_MATCHES.forEach(tm => {
    if(allocation[tm.matchId]) return;

    const pick = availableThirds.find(t => tm.candidates.includes(t.group) && !assigned.has(t.group));
    if(pick){
      allocation[tm.matchId] = pick.group;
      assigned.add(pick.group);
      usedFallback = true;
    }
  });

  // If still incomplete (edge cases), fill with any remaining
  THIRD_MATCHES.forEach(tm => {
    if(allocation[tm.matchId]) return;
    const pick = availableThirds.find(t => !assigned.has(t.group));
    if(pick){
      allocation[tm.matchId] = pick.group;
      assigned.add(pick.group);
      usedFallback = true;
    }
  });

  return { allocation, usedFallback, key };
}

/* =========================================================
   R32 RENDER
   ========================================================= */

function resolveSlot(slot, thirdAlloc){
  if(slot.type === "winner"){
    return {
      label: `Winner Group ${slot.group}`,
      team: groupsState[slot.group]?.[0] || "TBD",
      code: `1${slot.group}`
    };
  }
  if(slot.type === "runner"){
    return {
      label: `Runner-up Group ${slot.group}`,
      team: groupsState[slot.group]?.[1] || "TBD",
      code: `2${slot.group}`
    };
  }
  if(slot.type === "third"){
    const g = thirdAlloc[slot.matchId];
    const teamName = g ? (groupsState[g]?.[2] || "TBD") : "TBD";
    return {
      label: g ? `3rd Group ${g}` : "3rd-place qualifier",
      team: teamName,
      code: g ? `3${g}` : "3?"
    };
  }
  return { label:"", team:"TBD", code:"" };
}

function renderR32(){
  const mappingObj = parseMapping();
  const { allocation, usedFallback, key } = getThirdAllocation(mappingObj);

  // status badge
  if(getTop8Thirds().length !== 8){
    mappingStatus.textContent = "Rank 3rd-place teams first";
    mappingStatus.className = "badge warn";
  } else if(mappingObj[key]){
    mappingStatus.textContent = usedFallback ? `Mapping partial for ${key} (fallback used)` : `Mapping used for ${key}`;
    mappingStatus.className = usedFallback ? "badge warn" : "badge good";
  } else {
    mappingStatus.textContent = `No mapping for ${key} (fallback used)`;
    mappingStatus.className = "badge warn";
  }

  r32Body.innerHTML = "";

  R32_TEMPLATE.forEach(m => {
    const home = resolveSlot(m.home, allocation);
    const away = resolveSlot(m.away, allocation);

    const tr = document.createElement("tr");

    const tdId = document.createElement("td");
    tdId.className = "match-id";
    tdId.textContent = `Match ${m.matchId}`;

    const tdHome = document.createElement("td");
    tdHome.appendChild(renderTeamSlot(home));

    const tdAway = document.createElement("td");
    tdAway.appendChild(renderTeamSlot(away));

    const tdSrc = document.createElement("td");
    tdSrc.innerHTML = `<small>${escapeHtml(home.code)} vs ${escapeHtml(away.code)}</small>`;

    tr.appendChild(tdId);
    tr.appendChild(tdHome);
    tr.appendChild(tdAway);
    tr.appendChild(tdSrc);

    r32Body.appendChild(tr);
  });

  // Add a small note row if fallback was used
  if(usedFallback){
    const tr = document.createElement("tr");
    const td = document.createElement("td");
    td.colSpan = 4;
    td.className = "note";
    td.innerHTML = `‚ö†Ô∏è Fallback allocation used for some third-place slots.
      This may differ from the official 48-team combination table.`;
    tr.appendChild(td);
    r32Body.appendChild(tr);
  }
}

function renderTeamSlot(slot){
  const wrap = document.createElement("div");
  wrap.className = "slot";

  const flag = document.createElement("span");
  flag.className = "flag";
  flag.textContent = flagForName(slot.team);

  const text = document.createElement("div");
  text.innerHTML = `<div style="font-weight:650">${escapeHtml(slot.team)}</div>
                    <small>${escapeHtml(slot.label)}</small>`;

  wrap.appendChild(flag);
  wrap.appendChild(text);
  return wrap;
}

/* =========================================================
   UTIL
   ========================================================= */

function deepClone(o){ return JSON.parse(JSON.stringify(o)); }

function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================================================
   BUTTONS
   ========================================================= */

resetGroupsBtn.addEventListener("click", () => {
  groupsState = deepClone(DEFAULT_GROUPS);
  renderGroups();
  rebuildThirdFromGroups(true);
  renderQualificationSnapshot();
  r32Body.innerHTML = "";
});

rebuildThirdBtn.addEventListener("click", () => {
  rebuildThirdFromGroups(true);
  renderQualificationSnapshot();
});

loadExampleMappingBtn.addEventListener("click", () => {
  // Tiny illustrative example only (NOT official).
  const example = {
    "EFGHIJKL": {
      "74":"F",
      "77":"H",
      "79":"I",
      "80":"E",
      "81":"J",
      "82":"G",
      "85":"L",
      "87":"K"
    }
  };
  mappingInput.value = JSON.stringify(example, null, 2);
  parseMapping();
});

generateR32Btn.addEventListener("click", () => {
  // Ensure thirds are aligned with current group orders
  rebuildThirdFromGroups(false);
  renderQualificationSnapshot();
  renderR32();
});

/* =========================================================
   INIT
   ========================================================= */

function init(){
  mappingInput.value = ""; // start empty
  mappingStatus.textContent = "No JSON provided (will use fallback)";
  mappingStatus.className = "badge warn";

  renderGroups();
  rebuildThirdFromGroups(true);
  renderQualificationSnapshot();
  updateThirdStatus();
}
init();

</script>
</body>
</html>
